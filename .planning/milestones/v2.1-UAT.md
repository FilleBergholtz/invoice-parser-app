---
status: pending
milestone: v2.1-parsing-robustness-edi
source: [16-01-SUMMARY.md, 17-01-SUMMARY.md, 17-02-SUMMARY.md, 18-01-SUMMARY.md, 19-01-SUMMARY.md, 19-02-SUMMARY.md, 20-01-SUMMARY.md, 21-01-SUMMARY.md, 22-01-SUMMARY.md]
started: 2026-01-26
updated: 2026-01-26
verification_date: TBD
---

# User Acceptance Test: v2.1 Parsing robustness / EDI

**Milestone Goal:** Deterministisk parsing för EDI‑liknande PDF:er med text‑layer, robust tabellsegmentering och valideringsdriven om‑extraktion.

**Phases:** 16-22 (7 phases, 10 plans total)

## Phase 16: Text-layer routing (OCR-skip)

### 1. Text-layer routing per sida
expected: |
  Sidor med tillräcklig text-layer körs utan OCR och ger stabilt resultat:
  - Systemet kontrollerar text-layer kvalitet per sida
  - Om text-layer uppfyller tröskel (min_text_chars) och har konfigurerade ankare → använd text-layer direkt
  - OCR används bara när text-layer saknas eller inte uppfyller tröskeln
  - Routing-beslut loggas med debug reasons för spårbarhet
result: pending
notes: |
  Testa med fakturor som har:
  - Tydlig text-layer (EDI-liknande fakturor)
  - Bristfällig text-layer (scannade fakturor)
  - Mix av båda typerna i samma PDF
  Verifiera att OCR endast körs när nödvändigt

### 2. Konfigurerade ankare styr routing
expected: |
  Ankare (t.ex. "Faktura", "Sida 1/2", "Ramirent") i konfiguration styr routing-beslut:
  - Om sida innehåller required anchors → text-layer routing
  - Om sida innehåller extra anchors → boost för text-layer routing
  - Ankare-matchning är case-insensitive och robust
result: pending
notes: |
  Testa med fakturor från olika leverantörer:
  - Ramirent (har specifika ankare)
  - Andra leverantörer med olika header-format
  Verifiera att ankare-matchning fungerar korrekt

### 3. OCR/pdfplumber-jämförelse kraschar inte
expected: |
  OCR/pdfplumber-jämförelse fungerar stabilt utan KeyError eller andra exceptions:
  - Systemet hanterar både text-layer och OCR paths gracefully
  - Jämförelse mellan pdfplumber och OCR resultat fungerar korrekt
  - Inga kraschar vid mixed text/OCR pages
result: pending
notes: |
  Testa med fakturor som triggar både text-layer och OCR paths
  Verifiera att jämförelse-logik fungerar utan exceptions

## Phase 17: AI-policy (fallback only)

### 4. EDI-liknande fakturor parsas deterministiskt utan AI
expected: |
  Fakturor med text-layer, ankare, och tabellmönster parsas deterministiskt utan AI:
  - AI-policy evaluerar EDI-lik signal (text-layer usage, anchors, table patterns)
  - Om EDI-lik signal är stark → AI blockeras, deterministisk parsing används
  - AI används bara när deterministiska regler saknas eller mönster är ovanliga
  - AI-policy beslut sparas i extraction_detail.ai_policy för spårbarhet
result: pending
notes: |
  Testa med EDI-liknande fakturor (Ramirent, etc.):
  - Verifiera att AI inte används för normala EDI-fakturor
  - Verifiera att AI-policy beslut loggas korrekt
  - Verifiera att deterministisk parsing ger korrekt resultat

### 5. Deterministisk fallback körs före AI
expected: |
  Deterministisk retry fallback körs före AI fallback:
  - Om initial extraction misslyckas → kör deterministisk retry först
  - AI används endast om deterministisk retry också misslyckas
  - Fallback-kedja: deterministisk retry → AI (om tillåten av policy)
result: pending
notes: |
  Testa med fakturor som kräver retry:
  - Verifiera att deterministisk retry körs före AI
  - Verifiera att AI endast används när deterministisk retry misslyckas

## Phase 18: Fakturaboundaries för multi-page PDFs

### 6. Fler-sidiga fakturor grupperas korrekt via fakturanummer
expected: |
  Fler-sidiga fakturor grupperas korrekt per faktura:
  - Fakturanummer är primär boundary-signal (per sida)
  - Sidor med samma fakturanummer grupperas till samma faktura
  - Gruppering fungerar utan att vänta på "total found"
result: pending
notes: |
  Testa med multi-page PDFs:
  - Fakturor som spänner över 2+ sidor
  - Flera fakturor i samma PDF
  - Verifiera att sidor grupperas korrekt per fakturanummer

### 7. Sidnummer används som stöd för kontinuitet
expected: |
  Sidnummer används som stöd för att samla sidor per faktura:
  - Om fakturanummer saknas på en sida → använd sidnummer för kontinuitet
  - Sidnummer hjälper till att samla sidor när fakturanummer är otydligt
  - Primär signal är fortfarande fakturanummer
result: pending
notes: |
  Testa med fakturor där fakturanummer saknas på vissa sidor:
  - Verifiera att sidnummer används som fallback
  - Verifiera att gruppering fortfarande fungerar korrekt

### 8. Segmentering fungerar utan "total found" väntan
expected: |
  Segmentering fungerar utan att vänta på "total found":
  - Systemet segmenterar fakturor baserat på fakturanummer och sidnummer
  - Segmentering sker oavsett om totalsumma hittas eller inte
  - Inga blocking operations som väntar på totalsumma
result: pending
notes: |
  Testa med fakturor där totalsumma saknas eller är otydlig:
  - Verifiera att segmentering fungerar ändå
  - Verifiera att fakturor grupperas korrekt

## Phase 19: Svensk talnormalisering

### 9. Alla belopp tolkas som Decimal från gemensam funktion
expected: |
  Alla belopp parsas konsekvent som Decimal med svensk notation:
  - Gemensam normaliseringsfunktion används överallt
  - Belopp med mellanslag som tusentalsseparator tolkas korrekt (t.ex. "1 234,56")
  - Belopp med punkt som tusentalsseparator tolkas korrekt (t.ex. "1.234,56")
  - Belopp med svensk decimal-komma tolkas korrekt (t.ex. "1234,56")
  - Alla belopp är Decimal-objekt, inte float eller string
result: pending
notes: |
  Testa med fakturor som har olika belopp-format:
  - Mellanslag som tusentalsseparator: "1 234,56 SEK"
  - Punkt som tusentalsseparator: "1.234,56 SEK"
  - Decimal-komma: "1234,56 SEK"
  - Verifiera att alla tolkas korrekt som Decimal

### 10. Belopp-normalisering fungerar i hela pipeline
expected: |
  Belopp-normalisering fungerar i hela pipeline:
  - Header extraction använder normalisering
  - Line item extraction använder normalisering
  - Footer extraction använder normalisering
  - Alla belopp är Decimal från samma normaliseringsfunktion
result: pending
notes: |
  Testa med fakturor som har olika format i olika delar:
  - Header med ett format, footer med annat format
  - Verifiera att alla normaliseras korrekt

## Phase 20: Tabellsegment & kolumnregler

### 11. Tabellblocket lokaliseras korrekt
expected: |
  Tabellblocket lokaliseras korrekt mellan rubrikrad och slutrad:
  - Systemet identifierar rubrikrad (t.ex. "Artikelnr", "Benämning", "Moms", "Nettobelopp")
  - Systemet identifierar slutrad (t.ex. "Nettobelopp exkl. moms")
  - Tabellblocket är raderna mellan rubrikrad och slutrad
  - Rader utanför tabellblocket filtreras bort
result: pending
notes: |
  Testa med fakturor som har:
  - Tydlig rubrikrad och slutrad
  - Tabellblock med produktrader
  - Verifiera att tabellblocket identifieras korrekt

### 12. Nettobelopp identifieras efter moms%
expected: |
  Nettobelopp identifieras som sista valuta-tal efter moms% enligt reglerna:
  - Systemet letar efter moms% (t.ex. "25.00", "25,00") i raden
  - Nettobelopp är sista belopp efter moms%-kolumnen
  - Alternativ moms%+belopp-regex används för att undvika felkolumn
  - VAT%-anchored extraction fungerar korrekt
result: pending
notes: |
  Testa med fakturor som har:
  - Moms% i egen kolumn
  - Nettobelopp efter moms%-kolumnen
  - Verifiera att nettobelopp extraheras korrekt

### 13. Rader parsas rad-för-rad inom tabellblocket
expected: |
  Rader parsas rad-för-rad inom tabellblocket:
  - Varje rad i tabellblocket parsas som potentiell produktrad
  - Footer-rader filtreras bort (t.ex. "Summa", "Totalt")
  - Rader utan belopp hoppas över
  - Radordning bevaras
result: pending
notes: |
  Testa med fakturor som har:
  - Flera produktrader i tabellblocket
  - Footer-rader som ska filtreras bort
  - Verifiera att rader parsas korrekt

## Phase 21: Multi-line items

### 14. Fortsättningsrader läggs till i beskrivning
expected: |
  Rader utan moms% + nettobelopp läggs till i föregående beskrivning:
  - Systemet detekterar wraps via adaptiv Y-threshold (1.5× median line height)
  - Wrapped rows konsolideras till samma InvoiceLine
  - Beskrivning konsolideras med space separator
  - Wrapped rows inkluderas i InvoiceLine.rows för traceability
result: pending
notes: |
  Testa med fakturor som har:
  - Långa produktbeskrivningar som wrappar över flera rader
  - Indenterade sub-items (bullet points)
  - Verifiera att wraps detekteras korrekt

### 15. Start-pattern detection förhindrar felaktig merge
expected: |
  Nytt item startar när start-mönster matchar:
  - Artikelnr: 5+ siffror eller alfanumeriskt (ABC123)
  - Datum: YYYY-MM-DD eller DD/MM
  - Individnr: YYYYMMDD-XXXX
  - Kontokod: 4-siffrig + space
  - Start-pattern övertrumfar spatial proximity
result: pending
notes: |
  Testa med fakturor som har:
  - Tight-spaced items med start-patterns (artikelnr, datum)
  - Verifiera att start-patterns förhindrar felaktig merge
  - Verifiera att nya items startar korrekt

### 16. X-alignment tolerance hanterar indenterade rader
expected: |
  X-alignment tolerance hanterar indenterade rader korrekt:
  - Base tolerance: ±2% av page width
  - Right-indent allowance: +5% för bullet points och sub-items
  - Indenterade rader behandlas som wraps, inte nya items
result: pending
notes: |
  Testa med fakturor som har:
  - Indenterade sub-items (bullet points)
  - Nested descriptions
  - Verifiera att X-alignment tolerance fungerar korrekt

## Phase 22: Valideringsdriven om-extraktion (mode B)

### 17. Nettosumma valideras mot "Nettobelopp exkl. moms"
expected: |
  Nettosumma valideras mot "Nettobelopp exkl. moms" inom ±0,50 SEK:
  - Systemet extraherar "Nettobelopp exkl. moms" från footer
  - Systemet beräknar sum(line_items.total_amount)
  - Validering passerar om abs(diff) <= 0.50 SEK
  - VAL-01 fungerar korrekt
result: pending
notes: |
  Testa med fakturor som har:
  - Tydlig "Nettobelopp exkl. moms" i footer
  - Verifiera att validering fungerar korrekt
  - Testa både pass och fail scenarios

### 18. Total with VAT valideras mot "Att betala"
expected: |
  Netto + moms valideras mot "Att betala" inom ±0,50 SEK:
  - Systemet extraherar "Att betala" från footer
  - Systemet beräknar netto_sum + vat_amount (vat_amount = netto_sum × 0.25)
  - Validering passerar om abs(diff) <= 0.50 SEK
  - VAL-02 fungerar korrekt
result: pending
notes: |
  Testa med fakturor som har:
  - Tydlig "Att betala" i footer
  - Verifiera att validering fungerar korrekt
  - Testa både pass och fail scenarios

### 19. Mode B körs automatiskt vid VAL-01 failure
expected: |
  Om VAL-01 fallerar körs table-parser mode B (position/kolumn-baserad):
  - Systemet kör mode A extraction först (text-based)
  - Om VAL-01 failar → fallback till mode B (position-based)
  - Mode B använder gap-based column detection
  - Mode B använder hybrid position+content approach
  - VAL-03 fungerar korrekt
result: pending
notes: |
  Testa med fakturor där mode A misslyckas:
  - Verifiera att mode B körs automatiskt
  - Verifiera att mode B ger bättre resultat
  - Verifiera att fallback-logik fungerar korrekt

### 20. Debug artifacts sparas vid kvarstående mismatch
expected: |
  Om mismatch kvarstår efter mode B → status REVIEW och debug-artefakter sparas:
  - Systemet sparar 4 artefaktfiler:
    - table_block_raw_text.txt (råtext från alla table rows)
    - parsed_lines.json (parsed line items)
    - validation_result.json (validation result med diff, status, errors)
    - table_block_tokens.json (token-level data)
  - Artifacts sparas i artifacts_dir/invoices/{invoice_id}/table_debug/
  - Artifacts registreras i ArtifactManifest
  - VAL-04 fungerar korrekt
result: pending
notes: |
  Testa med fakturor där både mode A och mode B failar:
  - Verifiera att debug artifacts sparas
  - Verifiera att artifacts innehåller korrekt data
  - Verifiera att artifacts kan användas för troubleshooting

### 21. table_parser_mode konfiguration fungerar
expected: |
  table_parser_mode är konfigurerbart och fungerar (auto/text/pos):
  - `auto`: Kör mode A, fallback till mode B vid valideringsfel
  - `text`: Använd alltid mode A (text-based)
  - `pos`: Använd alltid mode B (position-based)
  - Konfiguration i configs/profiles/default.yaml
  - VAL-05 fungerar korrekt
result: pending
notes: |
  Testa med olika table_parser_mode inställningar:
  - Verifiera att `auto` mode fungerar (fallback vid failure)
  - Verifiera att `text` mode alltid använder mode A
  - Verifiera att `pos` mode alltid använder mode B

### 22. Column detection fungerar korrekt
expected: |
  Gap-based column detection fungerar korrekt:
  - Systemet identifierar kolumner via gaps mellan token clusters
  - Adaptive threshold (median gap × 1.5) för robusthet
  - Edge cases hanterade: single column, empty rows, over/under clustering
  - Column detection fungerar för de flesta fakturor
result: pending
notes: |
  Testa med fakturor som har:
  - Tydliga kolumn-gaps (normal case)
  - Tight spacing (edge case)
  - Varierande kolumn-spacing (edge case)
  - Verifiera att column detection fungerar korrekt

### 23. Mode B hybrid approach fungerar
expected: |
  Mode B parsing använder hybrid position+content approach:
  - Position: column detection identifierar kolumner
  - Content: VAT% patterns, unit keywords validerar fält
  - Fallback till mode A om column detection misslyckas
  - Hybrid approach ger robusthet mot kolumn-överlapp
result: pending
notes: |
  Testa med fakturor som kräver mode B:
  - Verifiera att hybrid approach fungerar
  - Verifiera att position och content kombineras korrekt
  - Verifiera att fallback till mode A fungerar vid misslyckande

### 24. Performance targets uppnådda
expected: |
  Performance targets uppnås:
  - Column detection: <5ms per table
  - Token assignment: <2ms per row
  - Mode B parsing: <50ms per invoice
  - Validation overhead: <5ms per invoice
  - Mode B overhead: <50ms
result: pending
notes: |
  Testa med fakturor av olika storlekar:
  - Små fakturor (5-10 rader)
  - Medelstora fakturor (20-30 rader)
  - Stora fakturor (50+ rader)
  - Verifiera att performance targets uppnås

## Integration Tests

### 25. Full pipeline fungerar end-to-end
expected: |
  Full pipeline fungerar end-to-end med alla v2.1 features:
  - Text-layer routing → OCR fallback (om nödvändigt)
  - AI-policy gating → deterministisk parsing för EDI-fakturor
  - Fakturaboundaries → multi-page gruppering
  - Svensk talnormalisering → Decimal överallt
  - Tabellsegment → korrekt tabellblock-identifiering
  - Multi-line items → wrap detection
  - Valideringsdriven om-extraktion → mode B fallback
  - Alla features fungerar tillsammans
result: pending
notes: |
  Testa med kompletta fakturor som triggar alla features:
  - Multi-page PDF med EDI-liknande fakturor
  - Text-layer routing → deterministisk parsing
  - Tabellsegment → wrap detection → validation → mode B fallback
  - Verifiera att hela pipeline fungerar korrekt

### 26. Backward compatibility bevarad
expected: |
  Backward compatibility bevarad:
  - Alla Phase 1-15 features fungerar fortfarande
  - Befintliga fakturor parsas korrekt
  - Inga breaking changes i API eller data-strukturer
  - Regression tests passerar
result: pending
notes: |
  Testa med fakturor från tidigare versioner:
  - Verifiera att alla befintliga features fungerar
  - Verifiera att ingen breaking change introducerats
  - Kör alla regression tests

## Summary

total: 26
passed: 0
issues: 0
pending: 26
skipped: 0

## End-to-End Test Results

**Date:** TBD  
**Test Files:** TBD

### Test Execution
- **Command:** TBD
- **Result:** TBD
- **Status Distribution:** TBD
- **Output Files Created:** TBD

### Key Observations
- TBD

## Unit Test Verification

**Date:** 2026-01-26

### Phase 16 Tests
- ✅ `tests/test_ocr_routing.py`: All tests passed
  - Text-layer routing tests
  - Anchor matching tests
  - OCR fallback tests

### Phase 17 Tests
- ✅ `tests/test_ai_policy.py`: All tests passed
  - AI-policy evaluation tests
  - EDI-like signal detection tests
- ✅ `tests/test_retry_extraction.py`: All tests passed
  - Deterministic retry fallback tests

### Phase 18 Tests
- ✅ Integration tests: All tests passed
  - Fakturaboundaries tests
  - Multi-page grouping tests

### Phase 19 Tests
- ✅ `tests/test_number_normalizer.py`: All tests passed
  - Swedish number normalization tests
  - Decimal conversion tests

### Phase 20 Tests
- ✅ `tests/test_invoice_line_parser.py`: All tests passed
  - Table block detection tests
  - VAT%-anchored extraction tests

### Phase 21 Tests
- ✅ `tests/test_wrap_detection.py`: 23/23 tests passed
  - Adaptive Y-threshold tests
  - Start-pattern detection tests
  - X-alignment tolerance tests
  - Wrap detection integration tests

### Phase 22 Tests
- ✅ `tests/test_validation.py`: 11/11 tests passed (VAL-01, VAL-02)
- ✅ `tests/test_column_detection.py`: 13/13 tests passed
- ✅ `tests/test_invoice_line_parser.py`: 13/13 mode B + integration tests passed
- ✅ `tests/test_debug_artifacts.py`: 7/7 tests passed
- ✅ `tests/test_performance_phase22.py`: 7/7 performance tests passed

**Total Unit Tests:** 56 nya tester för Phase 22 + alla regression tests passerar

## Gaps

[none yet - UAT pending execution]

## Known Limitations

1. **Multi-VAT rates**: Systemet hanterar endast 25% moms. Multipla momssatser (12%, 6%) är out of scope för v2.1.

2. **Column detection limitations**:
   - Fakturor med mycket tight spacing (gaps <20pt) kan misslyckas
   - Fakturor med varierande kolumn-spacing kan behöva justering av adaptive threshold
   - Fakturor utan tydliga kolumn-gränser fallback till mode A

3. **Debug artifacts size**: Kan bli stora för fakturor med många rader. Överväg komprimering eller size limits om artifacts blir för stora.

4. **Performance**: Performance targets är verifierade med unit tests men bör valideras med faktiska fakturor i production.

## Next Steps

1. **UAT Execution**: Kör UAT med faktiska fakturor från olika leverantörer
2. **Performance Validation**: Validera performance targets med faktiska fakturor
3. **Edge Case Testing**: Testa edge cases (tight spacing, varierande kolumn-spacing, etc.)
4. **Integration Testing**: Testa full pipeline med kompletta fakturor
