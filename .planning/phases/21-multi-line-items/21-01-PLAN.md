---
wave: 1
depends_on:
  - "Phase 20"
files_modified:
  - "src/pipeline/wrap_detection.py"
  - "src/pipeline/invoice_line_parser.py"
  - "tests/test_wrap_detection.py"
  - "tests/test_invoice_line_parser.py"
autonomous: true
---

# Plan 21-01 — Multi-line items (wrap detection enhancement)

## Mål
Robust detektion av fortsättningsrader (wrapped items) med adaptiva trösklar och start-pattern detection för att skilja nya items från fortsättningar.

## Must-haves
- LINE-01: Rader utan moms% + nettobelopp behandlas som fortsättning på föregående item-beskrivning.
- LINE-02: Nytt item startar när raden matchar start-mönster (artikelnr, datum, individnr, konto).
- Adaptiv Y-distance threshold (1.5× median line height) istället för fast gräns.
- Start-pattern detection som övertrumfar spatial proximity.
- Ta bort arbitrary max 3 wraps limit (använd naturliga stopp-villkor).

## Omfattning
- Utöka `wrap_detection.py` med adaptiv Y-threshold beräkning.
- Implementera start-pattern matching för nya items (artikelnr, datum, individnr, konto).
- Lägg till right-indent allowance (+5%) för X-alignment (hanterar bullet points, sub-items).
- Ta bort max wrap limit, använd naturliga stopp-villkor (amount, start-pattern, Y-distance, X-alignment).
- Uppdatera `invoice_line_parser.py` för att använda förbättrad wrap detection.
- Lägg till comprehensive tester för edge cases (indented sub-items, footer proximity, mixed wrapped/non-wrapped).

## Utanför scope
- Multi-page table continuation (cross-page wrapped items) — Phase 21 Plan 02 eller framtida fas.
- Multipla momssatser (12%, 6%) — Phase 22 scope.
- Multi-column descriptions — framtida fas.
- AI/ML-baserad wrap detection — deterministiska regler är tillräckliga.

## Tasks (XML)
<tasks>
  <task id="21-01-1" title="Adaptiv Y-distance threshold">
    <details>
      Implementera funktion `_calculate_adaptive_y_threshold(rows: List[Row]) -> float`
      som beräknar median line height från alla rader och returnerar 1.5× median
      (WCAG-guideline). Använd `statistics.median()` för robusthet mot outliers.
      Fallback till 15.0 (ca 10-12pt font × 1.5) om inga line heights finns.
      
      Uppdatera `detect_wrapped_rows()` för att använda adaptiv threshold istället
      för fixed logic. Jämför Y-distance mellan rows mot threshold:
      `next_row.y_min - prev_row.y_max &lt;= y_threshold`
      
      Research ref: Pattern 1 (Y-Distance Threshold with Adaptive Line Height)
    </details>
    <requirements>LINE-01</requirements>
  </task>
  <task id="21-01-2" title="Start-pattern detection">
    <details>
      Skapa funktion `_matches_start_pattern(row: Row) -> bool` som detekterar:
      - Artikelnr: `^\d{5,}` (5+ siffror), `^\w{3,}\d+` (alfanumeriskt)
      - Datum: `^\d{4}-\d{2}-\d{2}` (ISO), `^\d{2}/\d{2}` (svensk format)
      - Individnr: `^\d{6,8}-\d{4}` (YYYYMMDD-XXXX format)
      - Konto: `^\d{4}\s` (4-siffrig kontokod följt av space)
      
      Kombinera patterns i single regex:
      `^(?:\d{5,}|\w{3,}\d+|\d{4}-\d{2}-\d{2}|\d{2}/\d{2}|\d{6,8}-\d{4}|\d{4}\s)`
      
      Uppdatera `detect_wrapped_rows()` för att stoppa vid start-pattern match
      (övertrumfar spatial proximity). Om nästa rad matchar start-pattern = nytt item,
      inte continuation.
      
      Research ref: Pattern 3 (Start-Pattern Detection as Override)
    </details>
    <requirements>LINE-02</requirements>
  </task>
  <task id="21-01-3" title="Right-indent allowance för X-alignment">
    <details>
      Utöka X-alignment logik med two-tier tolerance:
      1. Base tolerance: ±2% page width (redan implementerat)
      2. Right-indent allowance: +5% page width för indenterade sub-items
      
      Uppdatera X-alignment check i `detect_wrapped_rows()`:
      ```python
      base_tolerance = 0.02 * page.width
      right_indent_allowance = 0.05 * page.width
      delta_x = next_row.x_min - description_start_x
      
      is_aligned = (abs(delta_x) &lt;= base_tolerance or 
                    (delta_x &gt; 0 and delta_x &lt;= right_indent_allowance))
      ```
      
      Detta hanterar bullet points och indenterade sub-items som annars skulle
      rejectas av strict X-alignment.
      
      Research ref: Pattern 2 (X-Alignment as Secondary Validation)
    </details>
    <requirements>LINE-01</requirements>
  </task>
  <task id="21-01-4" title="Ta bort max wrap limit">
    <details>
      Ta bort arbitrary `if len(wraps) >= 3: break` limit från `detect_wrapped_rows()`.
      
      Använd istället naturliga stopp-villkor:
      - Row innehåller amount (detekteras via `_contains_amount()`)
      - Row matchar start-pattern (ny funktion från task 21-01-2)
      - Y-distance överstiger threshold (adaptiv threshold från task 21-01-1)
      - X-alignment misslyckas (med right-indent allowance från task 21-01-3)
      
      Lägg till soft limit (10 wraps) med warning log för anomaly detection:
      ```python
      if len(wraps) &gt;= 10:
          logger.warning(f"Unusually long wrapped item ({len(wraps)} lines) on page {page.number}")
      ```
      
      Research ref: Pitfall 7 (Very Long Wrapped Items Truncated by Arbitrary Limit)
    </details>
    <requirements>LINE-01</requirements>
  </task>
  <task id="21-01-5" title="Integration i invoice_line_parser.py">
    <details>
      Uppdatera `invoice_line_parser.py` för att använda förbättrad wrap detection:
      
      1. Skicka `all_rows` till `detect_wrapped_rows()` för adaptiv Y-threshold
      2. Skicka `page` referens för X-alignment beräkningar
      3. Anropa `detect_wrapped_rows()` för varje product row
      4. Använd `consolidate_wrapped_description()` för att slå ihop beskrivningar
      
      Säkerställ att wrap detection körs EFTER table block filtering och footer
      filtering (Phase 20), men FÖRE InvoiceLine objekt skapas.
      
      Bibehåll backward compatibility — befintliga funktionssignaturer ska fungera.
    </details>
    <requirements>LINE-01, LINE-02</requirements>
  </task>
  <task id="21-01-6" title="Tester för wrap detection">
    <details>
      Skapa `tests/test_wrap_detection.py` med:
      
      Unit tests:
      - `test_adaptive_y_threshold_calculation`: Verifiera 1.5× median beräkning
      - `test_start_pattern_detection`: Testa alla patterns (artikelnr, datum, etc.)
      - `test_x_alignment_with_indent`: Testa base tolerance + right-indent
      - `test_no_arbitrary_wrap_limit`: Verifiera att 10+ wraps fungerar
      
      Edge case tests (från research Pitfalls):
      - `test_indented_sub_items`: Bullet points, indenterade rader
      - `test_footer_proximity`: Wraps nära footer inte felaktigt grupperade
      - `test_tightly_spaced_separate_items`: Start-pattern förhindrar merge
      - `test_mixed_wrapped_nonwrapped`: Faktura med både wrapped och single-line items
      - `test_article_number_vs_description`: Artikelnr detekteras som nytt item
      
      Integration tests:
      - `test_full_invoice_with_wraps`: Multi-line items i komplett faktura
      - `test_variable_font_sizes`: Adaptive threshold med 10pt och 14pt fonts
      
      Research ref: Section "Common Pitfalls" + "Testing Strategies"
    </details>
    <requirements>LINE-01, LINE-02</requirements>
  </task>
  <task id="21-01-7" title="Regression tests i test_invoice_line_parser.py">
    <details>
      Lägg till regression tests i befintlig test suite:
      
      - `test_line_items_with_wrapped_descriptions`: Verifiera att wrapped items
        extraheras korrekt med full beskrivning
      - `test_wrapped_items_with_start_patterns`: Verifiera att artikelnr/datum
        startar nytt item även vid tight spacing
      - `test_no_false_wraps_from_footer`: Footer-rader ska inte wrappas till items
      
      Säkerställ att Phase 20 tests fortfarande passerar (backward compatibility).
    </details>
    <requirements>LINE-01, LINE-02</requirements>
  </task>
</tasks>

## Verifiering
- Adaptiv Y-threshold beräknas som 1.5× median line height (LINE-01).
- Start-patterns (artikelnr, datum, individnr, konto) detekteras korrekt (LINE-02).
- Rader utan amount+VAT% läggs till föregående beskrivning (LINE-01).
- Nytt item startar vid start-pattern match (LINE-02).
- Right-indent allowance (+5%) hanterar bullet points och sub-items.
- Max wrap limit borttagen, naturliga stopp-villkor används.
- Alla edge case tests passerar (indented sub-items, footer proximity, etc.).
- Phase 20 regression tests passerar (backward compatibility).

## Leverabler
- Uppdaterad `wrap_detection.py` med adaptiv Y-threshold, start-pattern, right-indent.
- Uppdaterad `invoice_line_parser.py` som använder förbättrad wrap detection.
- Ny test suite `test_wrap_detection.py` med unit och edge case tests.
- Utökad `test_invoice_line_parser.py` med regression tests för multi-line items.

## Research References
- Pattern 1: Y-Distance Threshold with Adaptive Line Height
- Pattern 2: X-Alignment as Secondary Validation
- Pattern 3: Start-Pattern Detection as Override
- Pitfall 1: Fixed Y-thresholds fail (font size varies)
- Pitfall 2: Article numbers misidentified as description
- Pitfall 4: Indented sub-items rejected by strict X-alignment
- Pitfall 7: Very long items truncated by arbitrary limit
- Pitfall 8: Tightly-spaced separate items incorrectly merged
