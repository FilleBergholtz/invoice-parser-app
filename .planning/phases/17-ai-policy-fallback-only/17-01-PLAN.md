---
wave: 1
depends_on:
  - "Phase 16"
files_modified:
  - "configs/profiles/default.yaml"
  - "src/ai/fallback.py"
  - "src/pipeline/retry_extraction.py"
  - "src/pipeline/validation.py"
  - "src/pipeline/ocr_routing.py"
  - "tests/test_ai_policy.py"
  - "tests/test_retry_extraction.py"
autonomous: true
---

# Plan 17-01 — AI-policy (fallback only)

## Mål
Säkerställa att AI endast används som sista fallback när deterministiska regler saknas eller faller utanför förväntade mönster. EDI-liknande fakturor med text-layer ska i normalfallet aldrig gå via AI.

## Must-haves (från målbild)
- Central policy som tillåter AI endast vid saknade mönster/ovanliga layouter.
- EDI-lik klassning blockerar AI när deterministisk extraktion + validering fungerar.
- Regel-forst, AI-sist: deterministiska fallback-pass testas innan AI.
- Samma AI-policy i normal-path och compare-path.
- Tydliga beslutsskäl (reason_flags) sparas i resultatet.

## Omfattning
- Införa central AI-policyfunktion med EDI-lik heuristik och beslutsskäl.
- Konfigurerbar ai_policy i standardprofil (t.ex. allow_ai_for_edi, force_review_on_edi_fail).
- Integrera gating efter deterministisk extraktion + validering, inkl. deterministisk fallback.
- Tester for policy, gating och regression mot onodiga AI-anrop.

## Utanför scope
- Nya AI-modeller eller prompt-forandringar.
- Nya heuristiker for tabellsegment eller talnormalisering.
- UI-andringar for policyvisning.

## Tasks (XML)
<tasks>
  <task id="17-01-1" title="Konfigurera ai_policy i standardprofil">
    <details>
      Lagga till ai_policy med nycklar som allow_ai_for_edi=false,
      force_review_on_edi_fail=true, edi_anchor_rules och min_edi_signals.
      Behall bakatkompatibilitet med befintliga profiler.
    </details>
    <requirements>AI-01, AI-02</requirements>
  </task>
  <task id="17-01-2" title="Implementera central AI-policyfunktion">
    <details>
      Skapa policyfunktion som tar in extraction_source, text_quality,
      validation_result och edilik-heuristik (ankare, tabellmonster, text-layer).
      Returnera allow_ai, reason_flags och policy_version for spårbarhet.
    </details>
    <requirements>AI-01, AI-02</requirements>
  </task>
  <task id="17-01-3" title="Koppla gating efter deterministisk extraktion">
    <details>
      Integrera policy efter header/line-parsing och validering.
      Vid valideringsfel: kor deterministisk fallback innan AI tillats.
      Om EDI-lik och fallback misslyckas -> REVIEW enligt policy.
    </details>
    <requirements>AI-01, AI-02</requirements>
  </task>
  <task id="17-01-4" title="Samma policy i compare-path och normal-path">
    <details>
      Se till att compare-path och normal-path anvander exakt samma
      AI-policybeslut och same reason_flags for konsistens.
    </details>
    <requirements>AI-01, AI-02</requirements>
  </task>
  <task id="17-01-5" title="Tester for AI-policy och regression">
    <details>
      Enhetstester for EDI-lik + validering OK -> AI ej tillaten.
      Enhetstester for EDI-lik + fallback lyckas -> AI ej tillaten.
      Enhetstester for ej EDI + inga monster -> AI tillaten.
      Regression: inga AI-anrop i EDI-korpus nar heuristiken uppfylls.
    </details>
    <requirements>AI-01, AI-02</requirements>
  </task>
</tasks>

## Verifiering
- Enhetstest: EDI-lik + validering passerar -> allow_ai=false.
- Enhetstest: EDI-lik + validering fail + deterministisk fallback lyckas -> allow_ai=false.
- Enhetstest: EDI-lik + inga monster -> allow_ai styrs av policy (default false).
- Enhetstest: ej EDI + saknade monster -> allow_ai=true.
- Integration: compare-path och normal-path ger samma policybeslut.
- Regression: inga AI-anrop for EDI-lik text-layer i testkorpus.

## Leverabler
- ai_policy i standardprofil.
- Central policyfunktion med reason_flags.
- Gating integrerad efter deterministisk extraktion + validering.
- Tester som cover AI-01 och AI-02.
