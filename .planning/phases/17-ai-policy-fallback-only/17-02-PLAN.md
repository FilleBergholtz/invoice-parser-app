---
wave: 1
depends_on:
  - "Phase 17"
files_modified:
  - "src/cli/main.py"
  - "src/ai/fallback.py"
  - "src/pipeline/retry_extraction.py"
  - "tests/test_ai_policy.py"
  - "tests/test_retry_extraction.py"
autonomous: true
gap_closure: true
---

# Plan 17-02 — AI-policy gating i compare-path (gap-closure)

## Mål
Stäng verifieringsgap: compare‑path ska använda samma AI‑policy‑gating som normal‑path, och `ai_policy`/reason flags ska sparas i compare‑path‑resultat.

## Must‑haves (från gap‑rapport)
- Compare‑path kör AI endast när `evaluate_ai_policy(...).allow_ai` är true.
- EDI‑lik text‑layer blockerar AI i compare‑path (AI-01/AI-02 uppfylls).
- `ai_policy` skrivs in i `extraction_detail` i compare‑path.

## Omfattning
- Lägg AI‑policy‑gating i compare‑path kring `extract_total_amount`.
- Spara policybeslut i `extraction_detail.ai_policy` (både pdfplumber och ocr‑resultat där compare‑path används).
- Uppdatera tester för att täcka compare‑path‑gating och metadata.

## Utanför scope
- Nya heuristiker för EDI‑detektion (finns redan).
- Ändringar i AI‑fallback‑prompt eller strategi.

## Tasks (XML)
<tasks>
  <task id="17-02-1" title="AI-policy gating i compare-path">
    <details>
      I compare‑path (main.py) bygg edi_signals + ai_policy_decision på samma sätt som normal‑path
      och blockera AI när allow_ai=false. Säkerställ att deterministic fallback körs före AI
      även i compare‑path och att fallback_passed påverkar policybeslut.
    </details>
    <requirements>AI-01, AI-02</requirements>
  </task>
  <task id="17-02-2" title="Spara ai_policy i extraction_detail (compare-path)">
    <details>
      När compare‑path sätter extraction_detail, inkludera ai_policy (allow_ai, reason_flags,
      edi_like, edi_signals, policy_version) så spårbarhet finns i run_summary.
    </details>
    <requirements>AI-01, AI-02</requirements>
  </task>
  <task id="17-02-3" title="Tester för compare-path gating och metadata">
    <details>
      Lägg test som säkerställer att EDI‑lik data blockerar AI i compare‑path,
      och att ai_policy lagras i extraction_detail. Uppdatera befintliga policy‑tester vid behov.
    </details>
    <requirements>AI-01, AI-02</requirements>
  </task>
</tasks>

## Verifiering
- Compare‑path använder `evaluate_ai_policy` och blockerar AI när EDI‑lik.
- `extraction_detail.ai_policy` finns i compare‑path‑resultat (pdfplumber/ocr).
- Enhetstest: EDI‑lik compare‑path ger allow_ai=false och reason_flags.

## Leverabler
- Compare‑path med policy‑gating + metadata
- Uppdaterade tester
