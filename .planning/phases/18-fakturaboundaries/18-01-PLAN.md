---
wave: 1
depends_on:
  - "Phase 17"
files_modified:
  - "src/pipeline/invoice_boundary_detection.py"
  - "src/cli/main.py"
  - "tests/test_invoice_boundary_detection.py"
autonomous: true
---

# Plan 18-01 — Fakturaboundaries for multi-page PDFs

## Mål
Sidor grupperas korrekt per faktura utan att bero på totalsumma, med fakturanummer per sida och sidnumrering som stöd.

## Must-haves
- BOUND-01: Gruppindelning per sida med fakturanummer (groupby `invoice_no`).
- BOUND-02: Sidnummer (Sida 1/2, Sida 2/2, Page 1/2) används som stöd för gruppering.
- BOUND-03: Segmentering ska inte bero på “total found”.

## Omfattning
- Utöka `invoice_boundary_detection.py` med kandidat-extraktor för fakturanummer per sida.
- Lägg sidnumrerings‑parser och logik för sekventiell kontinuitet.
- Beslutslogik för gruppgräns som prioriterar fakturanummer och använder sidnumrering som stöd.
- Logga boundary‑beslut i CLI compare‑path för spårbarhet.
- Lägg tester för typfall och konflikter.

## Utanför scope
- Nya heuristiker för total‑detektion.
- Ändringar i AI/OCR‑policy.
- Ändringar i tabell‑parsern.

## Tasks (XML)
<tasks>
  <task id="18-01-1" title="Fakturanummer per sida (kandidater + val)">
    <details>
      Implementera kandidat-extraktor baserad på etiketter (Fakturanr/Faktura nr/Invoice No)
      och validering av alfanumeriska sekvenser (4-20 tecken, bindestreck tillatna).
      Prioritera kandidater i header/ovre halvan. Valj hogst konfidens kandidat per sida.
    </details>
    <requirements>BOUND-01</requirements>
  </task>
  <task id="18-01-2" title="Sidnummer‑parser och kontinuitet">
    <details>
      Implementera parser for "Sida 1/2", "Sida 2 av 3", "Page 1/2" samt "1/2".
      Anvand sidnummer som stöd for att behalla grupp när fakturanummer saknas.
      Kontrollera sekventiell kontinuitet (utan hopp) for att stabilisera grupper.
    </details>
    <requirements>BOUND-02</requirements>
  </task>
  <task id="18-01-3" title="Beslutslogik for gruppgrans utan total">
    <details>
      Bygg beslutstrad som kombinerar fakturanummer och sidnummer:
      fakturanummer vinner vid konflikt; sidnummer styr fortsättning när nummer saknas.
      Ingen logik ska bero på "total found".
    </details>
    <requirements>BOUND-01, BOUND-02, BOUND-03</requirements>
  </task>
  <task id="18-01-4" title="Compare-path logging for boundary‑beslut">
    <details>
      Logga per sida: valt fakturanummer, sidnummerstatus, gruppbeslut och ev. fallback‑skäl.
      Syfte: spårbarhet i compare‑path och enklare felsokning.
    </details>
    <requirements>BOUND-01, BOUND-02, BOUND-03</requirements>
  </task>
  <task id="18-01-5" title="Tester for fakturaboundaries">
    <details>
      Skapa testfall for:
      - 2 fakturor, 2 sidor vardera, tydligt fakturanummer.
      - Saknat fakturanummer på sida 2 med Sida 2/2.
      - Konflikt: Sida 1/2 men nytt fakturanummer på sida 2.
      - Falsk kandidat (Ordernr vs Fakturanr).
    </details>
    <requirements>BOUND-01, BOUND-02, BOUND-03</requirements>
  </task>
</tasks>

## Verifiering
- Fler-sidiga fakturor grupperas via fakturanummer per sida (BOUND-01).
- Sidnumrering styr fortsatt gruppering när fakturanummer saknas (BOUND-02).
- Inga beslut bygger på “total found” (BOUND-03).
- Tester passerar för konflikt- och fallback‑scenarier.

## Leverabler
- Utökad boundary‑logik och sidnumrering i `invoice_boundary_detection.py`
- Compare‑path loggning av boundary‑beslut
- Nya/uppdaterade tester för boundary‑fall
