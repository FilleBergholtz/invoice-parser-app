---
phase: 10-ai-fallback-fixes
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [.planning/phases/10-ai-fallback-fixes/10-CONTEXT.md]
autonomous: true

must_haves:
  truths:
    - "AI fallback behaviour is documented: trigger, context, prompts, config, UI, errors"
    - "Single source of truth exists for what is sent to AI and how it is toggled"
  artifacts:
    - path: ".planning/phases/10-ai-fallback-fixes/10-CONTEXT.md"
      provides: "Documentation of AI fallback design and usage"
  key_links:
    - from: "10-CONTEXT.md"
      to: "src/pipeline/footer_extractor.py"
      via: "Documents _try_ai_fallback and extract_total_amount contract"
    - from: "10-CONTEXT.md"
      to: "src/ai/fallback.py"
      via: "Documents AIFallback and extract_total_with_ai"
---

<objective>
Document current AI fallback behaviour so we have a single source of truth for trigger, context sent to AI, prompts, config, UI, and verification. No code changes — documentation only.

Purpose: ROADMAP Phase 10 asks to "dokumentera vad vi åtgärdat gällande AI fallback". This plan produces that documentation so future work and verification have a clear reference.

Output: `.planning/phases/10-ai-fallback-fixes/10-CONTEXT.md` describing when AI runs, what context it receives, where prompts live, how to enable/disable (config + UI), and error/validation behaviour.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-ai-integration/08-CONTEXT.md
@.planning/phases/08-ai-integration/08-01-SUMMARY.md
@.planning/phases/08-ai-integration/08-03-SUMMARY.md
@src/pipeline/footer_extractor.py
@src/ai/fallback.py
@src/ai/providers.py
@src/config.py
@src/ui/views/ai_settings_dialog.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create 10-CONTEXT.md with AI fallback documentation</name>
  <files>.planning/phases/10-ai-fallback-fixes/10-CONTEXT.md</files>
  <action>
Create a single markdown file that documents the current AI fallback for total amount extraction.

**Sections to include (derive from code, do not invent):**

1. **Phase boundary**
   - Phase 10 goal: document fixes and verify AI fallback works.
   - This document is the “what we have today” reference.

2. **Trigger**
   - When does AI run? `get_ai_enabled()` true, `get_ai_key()` set, and either (a) no heuristic candidates, or (b) best heuristic score < 0.95.
   - Reference: `footer_extractor.extract_total_amount` Step 5 (get_ai_enabled, scored_candidates, top_heuristic_score >= 0.95).

3. **Context sent to AI**
   - Footer text (footer_segment raw_text or joined rows).
   - `line_items_sum` for validation.
   - Up to 10 heuristic candidates `[{amount, keyword_type}]` when available.
   - `page_context`: full page text (header + items + footer) for the last page. Built by `_build_page_context_for_ai(last_page_segments)` in `src/cli/main.py`, passed as `page_context_for_ai` into `extract_total_amount`.
   - Call chain: CLI builds `page_context_for_ai` → `extract_total_amount(..., page_context_for_ai=...)` → `_try_ai_fallback(..., page_context=page_context_for_ai)` → `extract_total_with_ai(footer_text, line_items_sum, candidates=..., page_context=...)`.

4. **Prompts**
   - Where they live: provider `extract_total_amount` in `src/ai/providers.py` (OpenAIProvider, ClaudeProvider). Document that prompts are in those methods; no need to paste full prompt text if long, but note role (system/user), what goes in (footer, page_context, candidates, line_items_sum).

5. **Config**
   - Env: `AI_ENABLED`, `AI_PROVIDER` (openai/claude), `AI_MODEL`, `AI_KEY`. File-backed config via `get_ai_config_path()`, `load_ai_config()`, `set_ai_config()`.
   - Functions: `get_ai_enabled()`, `get_ai_key()`, `get_ai_provider()`, `get_ai_model()`.

6. **UI**
   - `AISettingsDialog` (src/ui/views/ai_settings_dialog.py): provider, model, API key, and **enabled** toggle. Status shows “Aktiverad” / “Inaktiverad”. Persisted via `set_ai_config` / `load_ai_config`.

7. **Error handling and validation**
   - AI errors (timeouts, API errors, invalid response) → return None; extraction continues with heuristic result or no total.
   - Validation: AI total vs `line_items_sum` within ±1 SEK (or “implausible” rule: trust AI when line_items_sum clearly wrong). Confidence boost when validation passes (+0.1 base, +0.1 exact match, cap 1.0).
   - Source: `src/ai/fallback.py` AIFallback.extract and `footer_extractor` use/selection of ai_result.

8. **Verification (brief)**
   - One-sentence pointer: “To verify AI fallback, enable AI (UI or env), run on a PDF that yields low heuristic confidence or no candidates, and check logs for ‘AI fallback …’ and final total.”
   - Detailed verification is covered in plan 10-02.

**Acceptance:**
- File exists and is readable.
- Each section accurately reflects the current code (footer_extractor, fallback, providers, config, ai_settings_dialog).
</action>
  <verify>Read .planning/phases/10-ai-fallback-fixes/10-CONTEXT.md and spot-check 2–3 facts against src (e.g. trigger condition, presence of page_context in call chain).</verify>
  <done>10-CONTEXT.md exists and describes trigger, context, prompts location, config, UI, errors/validation, and a brief verification pointer.</done>
</task>

</tasks>

<verification>
- 10-CONTEXT.md exists under .planning/phases/10-ai-fallback-fixes/.
- At least trigger, context, config, and UI are documented and consistent with code.
</verification>

<success_criteria>
- Single documentation file for AI fallback is in place.
- No code changes; documentation only.
</success_criteria>

<output>
After completion, create `.planning/phases/10-ai-fallback-fixes/10-01-SUMMARY.md` per template.
</output>
