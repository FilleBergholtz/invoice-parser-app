---
phase: 15-extraction-quality-hardening
plan: 07
type: execute
wave: 2
depends_on: []
files_modified: [src/pipeline/header_extractor.py, src/pipeline/footer_extractor.py]
autonomous: true

must_haves:
  truths:
    - "header_extractor: negative labels (orgnr, kundnr, order...) filter invoice-number false positives; bbox matching improved for split OCR tokens"
    - "footer_extractor: refactored into candidate generation -> scoring -> learning -> calibration -> AI routing; score_raw vs score_calibrated consistent"
    - "AI/vision routing uses Phase 14 thresholds (quality + confidence), not only top-score"
  artifacts:
    - path: "src/pipeline/header_extractor.py"
      provides: "Fewer invoice-number false positives; better bbox matching"
    - path: "src/pipeline/footer_extractor.py"
      provides: "Clear separation of concerns; R4 thresholds in routing"
  key_links:
    - from: "footer_extractor"
      to: "R4 constants"
      via: "TEXT_QUALITY_THRESHOLD, OCR_MEDIAN_CONF_ROUTING_THRESHOLD, CRITICAL_FIELDS_CONF_THRESHOLD"
---

<objective>
Complete D7 per 15-DISCUSS: header_extractor — improve candidate filtering with negative labels (orgnr, kundnr, order, etc.) and bbox matching for split OCR tokens (normalize, fallback to digit-token union bbox). footer_extractor — refactor to separate candidate generation, scoring, learning boost, calibration, AI fallback/routing; consistent score_raw vs score_calibrated; routing to AI/vision uses Phase 14 thresholds (quality + confidence), not only top-score.
</objective>

<execution_context>
@.planning/phases/15-extraction-quality-hardening/15-CONTEXT.md
@.planning/phases/15-extraction-quality-hardening/15-DISCUSS.md
</execution_context>

<context>
@.planning/phases/15-extraction-quality-hardening/15-DISCUSS.md
@src/pipeline/header_extractor.py
@src/pipeline/footer_extractor.py
</context>

<tasks>

<task type="auto">
  <name>Header: negative labels and bbox matching</name>
  <files>src/pipeline/header_extractor.py</files>
  <action>
Add or tighten candidate filtering with negative labels (orgnr, kundnr, order, etc.) so likely non-invoice-number strings are rejected. Improve bbox matching for split OCR tokens: normalize bboxes and use digit-token union bbox as fallback where needed. Per 15-DISCUSS D7.
</action>
</task>

<task type="auto">
  <name>Footer: separate candidate, scoring, learning, calibration, routing</name>
  <files>src/pipeline/footer_extractor.py</files>
  <action>
Refactor footer_extractor so that candidate generation, scoring, learning boost, calibration, and AI fallback/routing are clearly separated (functions or steps). Use consistent data model: score_raw vs score_calibrated. Per 15-DISCUSS D7.
</action>
</task>

<task type="auto">
  <name>Footer: routing uses R4 thresholds</name>
  <files>src/pipeline/footer_extractor.py</files>
  <action>
Ensure decisions to use AI or vision use Phase 14 thresholds (TEXT_QUALITY_THRESHOLD, OCR_MEDIAN_CONF_ROUTING_THRESHOLD, CRITICAL_FIELDS_CONF_THRESHOLD, etc.), not only "top score above X". Import constants from 15-DISCUSS required constants or shared config. Per 15-DISCUSS D7.
</action>
</task>

</tasks>

<verification>
- Header: fewer invoice-number false positives; bbox matching handles split tokens.
- Footer: clear separation; score_raw/score_calibrated; routing uses R4 thresholds.
</verification>
