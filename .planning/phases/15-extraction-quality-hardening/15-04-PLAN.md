---
phase: 15-extraction-quality-hardening
plan: 04
type: execute
wave: 2
depends_on: ["15-01"]
files_modified: [src/pipeline/pdf_renderer.py, orchestration]
autonomous: true

must_haves:
  truths:
    - "After OCR at BASELINE_DPI, if ocr_mean_conf < OCR_MEAN_CONF_RETRY_THRESHOLD (55), re-render at RETRY_DPI and re-run OCR once"
    - "Max one retry per page"
    - "Artifacts reflect which DPI was used per page"
  artifacts:
    - path: "src/pipeline/pdf_renderer.py"
      provides: "render at 300 or 400 DPI as needed"
    - path: "orchestration / run_summary"
      provides: "DPI per page in artifacts"
  key_links:
    - from: "orchestration"
      to: "pdf_renderer"
      via: "dpi=BASELINE_DPI or RETRY_DPI"
---

<objective>
Complete D4 per 15-DISCUSS (R1): after OCR at BASELINE_DPI, if ocr_mean_conf &lt; OCR_MEAN_CONF_RETRY_THRESHOLD (55), re-render that page at RETRY_DPI and re-run OCR once. Max one retry per page. Ensure artifacts (e.g. run_summary or artifact paths) reflect which DPI was used per page.
</objective>

<execution_context>
@.planning/phases/15-extraction-quality-hardening/15-CONTEXT.md
@.planning/phases/15-extraction-quality-hardening/15-DISCUSS.md
</execution_context>

<context>
@.planning/phases/15-extraction-quality-hardening/15-DISCUSS.md
@src/pipeline/pdf_renderer.py
</context>

<tasks>

<task type="auto">
  <name>DPI retry logic in orchestration</name>
  <files>Orchestration / pipeline that calls render and OCR</files>
  <action>
After running OCR at BASELINE_DPI (300), compute ocr_mean_conf from 15-01 metrics. If ocr_mean_conf < OCR_MEAN_CONF_RETRY_THRESHOLD (55), call render at RETRY_DPI (400), re-run OCR for that page once, then use the new result. Do not retry more than once per page. Use constants from 15-DISCUSS.
</action>
</task>

<task type="auto">
  <name>Artifacts show DPI per page</name>
  <files>run_summary and/or artifact storage</files>
  <action>
Record which DPI was used per page (e.g. dpi_used: 300 or 400 in per-page extraction_detail or metrics) so traceability explains retries. Per 15-DISCUSS D4.
</action>
</task>

</tasks>

<verification>
- DPI retry runs when mean_conf < 55; max 1 retry per page.
- Artifacts / run_summary indicate DPI per page.
</verification>
