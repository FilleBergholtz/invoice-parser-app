---
phase: 15-extraction-quality-hardening
plan: 08
type: execute
wave: 3
depends_on: ["15-03"]
files_modified: [src/run_summary.py, orchestration that writes run_summary]
autonomous: true

must_haves:
  truths:
    - "run_summary per-page includes method_used (pdfplumber|ocr|ai_text|ai_vision), metrics (pdf_text_quality, ocr_text_quality, ocr_median_conf, ocr_mean_conf, low_conf_fraction), reason flags, artifact paths"
    - "When method_used is ai_vision, vision_reason list is present"
  artifacts:
    - path: "src/run_summary.py"
      provides: "Per-page extraction_detail with method_used, metrics, reason flags, artifact paths, vision_reason"
  key_links:
    - from: "run_summary"
      to: "orchestration"
      via: "extraction_details / extraction_detail"
---

<objective>
Complete D8 per 15-DISCUSS: ensure run_summary (or equivalent output) includes per-page method_used, metrics (pdf_text_quality, ocr_text_quality, ocr_median_conf, ocr_mean_conf, low_conf_fraction), reason flags (e.g. ["ocr_median_conf<70", "text_quality<0.5"]), artifact paths (rendered image, OCR TSV, AI request/response where applicable), and vision_reason when method_used is ai_vision.
</objective>

<execution_context>
@.planning/phases/15-extraction-quality-hardening/15-CONTEXT.md
@.planning/phases/15-extraction-quality-hardening/15-DISCUSS.md
</execution_context>

<context>
@.planning/phases/15-extraction-quality-hardening/15-DISCUSS.md
@src/run_summary.py
</context>

<tasks>

<task type="auto">
  <name>Per-page method_used and metrics</name>
  <files>src/run_summary.py and code that populates it</files>
  <action>
Ensure each page (or extraction_detail) has method_used: pdfplumber | ocr | ai_text | ai_vision, and metrics: pdf_text_quality, ocr_text_quality, ocr_median_conf, ocr_mean_conf, low_conf_fraction. Serialize into run_summary.json per 15-DISCUSS D8.
</action>
</task>

<task type="auto">
  <name>Reason flags and vision_reason</name>
  <files>src/run_summary.py and orchestration</files>
  <action>
Add reason flags (e.g. ["ocr_median_conf<70", "text_quality<0.5"]) to per-page output so routing is explainable. When method_used is ai_vision, add vision_reason list describing conditions that led to vision. Per 15-DISCUSS D8.
</action>
</task>

<task type="auto">
  <name>Artifact paths per page</name>
  <files>src/run_summary.py and artifact writer</files>
  <action>
Record artifact paths per page where applicable: rendered image path, OCR TSV path, AI request/response paths. These can be under output_dir/artifacts/ or similar. Per 15-DISCUSS D8.
</action>
</task>

</tasks>

<verification>
- run_summary.json includes per-page method_used, metrics, reason flags, artifact paths.
- vision_reason present when method_used is ai_vision.
</verification>
