---
phase: 15-extraction-quality-hardening
plan: 02
type: execute
wave: 1
depends_on: []
files_modified: [src/pipeline/tokenizer.py]
autonomous: true

must_haves:
  truths:
    - "pdfplumber extract_words uses use_text_flow=True"
    - "extra_attrs=['fontname','size'] enabled with safe fallback (try/except or flag)"
    - "Reading order via line clustering, not raw (y,x) sort"
  artifacts:
    - path: "src/pipeline/tokenizer.py"
      provides: "extract_tokens_from_page with use_text_flow, extra_attrs, line-clustered order"
  key_links:
    - from: "tokenizer"
      to: "pdfplumber"
      via: "extract_words(use_text_flow=True, extra_attrs=...)"
---

<objective>
Complete D2 per 15-DISCUSS: in tokenizer.py use extract_words(use_text_flow=True), enable extra_attrs=["fontname","size"] with safe fallback, improve reading order by clustering tokens into lines. Remove unused chars extraction if not needed.
</objective>

<execution_context>
@.planning/phases/15-extraction-quality-hardening/15-CONTEXT.md
@.planning/phases/15-extraction-quality-hardening/15-DISCUSS.md
</execution_context>

<context>
@.planning/phases/15-extraction-quality-hardening/15-DISCUSS.md
@src/pipeline/tokenizer.py
</context>

<tasks>

<task type="auto">
  <name>use_text_flow and extra_attrs</name>
  <files>src/pipeline/tokenizer.py</files>
  <action>
Call extract_words(use_text_flow=True). Enable extra_attrs=["fontname","size"] with safe fallback (try/except or feature check); do not break extraction on PDFs where extra_attrs fail. Remove unused chars extraction if it adds no value per 15-DISCUSS D2.
</action>
</task>

<task type="auto">
  <name>Reading order via line clustering</name>
  <files>src/pipeline/tokenizer.py</files>
  <action>
Improve reading order by clustering tokens into lines (e.g. group by similar y within a line threshold), then sort lines by y and tokens within line by x. Avoid simple (y,x) mixing that can flip lines. Per 15-DISCUSS D2.
</action>
</task>

</tasks>

<verification>
- use_text_flow=True used; extra_attrs with safe fallback.
- Token order follows reading order via line clustering.
</verification>
