---
phase: 15-extraction-quality-hardening
plan: 03
type: execute
wave: 2
depends_on: ["15-01", "15-02"]
files_modified: [src/pipeline/text_quality.py, routing/orchestration code]
autonomous: true

must_haves:
  truths:
    - "text_quality.py exposes score_text_quality(text, tokens) and score_ocr_quality(tokens) -> float in [0..1]"
    - "R4 routing: best_available_text_quality >= TEXT_QUALITY_THRESHOLD -> AI text-only; both pdf and ocr < threshold -> AI vision eligible"
    - "TEXT_QUALITY_THRESHOLD = 0.5 and other R4 constants used from single source"
  artifacts:
    - path: "src/pipeline/text_quality.py"
      provides: "score_text_quality, score_ocr_quality"
    - path: "routing/orchestration"
      provides: "Per-page routing using text quality + R4 rules"
  key_links:
    - from: "orchestration"
      to: "text_quality"
      via: "score_text_quality / score_ocr_quality and TEXT_QUALITY_THRESHOLD"
---

<objective>
Complete D3 per 15-DISCUSS: ensure text_quality.py has score_text_quality(text, tokens) and score_ocr_quality(tokens) returning [0..1]; integrate in per-page routing so that best_available_text_quality >= TEXT_QUALITY_THRESHOLD allows AI text-only, and both pdf_text_quality and ocr_text_quality &lt; threshold makes AI vision eligible. Use R4 constants.
</objective>

<execution_context>
@.planning/phases/15-extraction-quality-hardening/15-CONTEXT.md
@.planning/phases/15-extraction-quality-hardening/15-DISCUSS.md
</execution_context>

<context>
@.planning/phases/15-extraction-quality-hardening/15-DISCUSS.md
@src/pipeline/text_quality.py
</context>

<tasks>

<task type="auto">
  <name>Text quality module</name>
  <files>src/pipeline/text_quality.py</files>
  <action>
Provide score_text_quality(text, tokens) -> float in [0..1] and score_ocr_quality(tokens) -> float in [0..1] (using OCR metrics from 15-01). If module exists from Phase 14, align signatures and semantics with 15-DISCUSS D3.
</action>
</task>

<task type="auto">
  <name>Integrate text quality into R4 routing</name>
  <files>Wherever per-page routing is implemented (e.g. cli/main, extraction pipeline)</files>
  <action>
In per-page routing: if best_available_text_quality >= TEXT_QUALITY_THRESHOLD (0.5) -> AI text-only allowed; if both pdf_text_quality and ocr_text_quality < TEXT_QUALITY_THRESHOLD -> AI vision eligible (if allowed by config/limits). Use constants from 15-DISCUSS required constants table.
</action>
</task>

</tasks>

<verification>
- score_text_quality and score_ocr_quality exist and return [0..1].
- Routing uses TEXT_QUALITY_THRESHOLD and R4 rules for text-only vs vision.
</verification>
