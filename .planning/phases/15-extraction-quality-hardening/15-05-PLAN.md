---
phase: 15-extraction-quality-hardening
plan: 05
type: execute
wave: 1
depends_on: []
files_modified: [src/pipeline/invoice_boundary_detection.py]
autonomous: true

must_haves:
  truths:
    - "Boundary detection does not treat 'faktura' + random alphanumeric as sufficient alone"
    - "Additional signal required: label match, strong candidate score, or date/amount signals"
    - "Reuse existing scoring; avoid weak regex-only checks"
  artifacts:
    - path: "src/pipeline/invoice_boundary_detection.py"
      provides: "Hardened boundary detection with reduced false positives"
  key_links:
    - from: "invoice_boundary_detection"
      to: "scoring / layout"
      via: "Existing scoring and signals"
---

<objective>
Complete D5 per 15-DISCUSS: harden invoice_boundary_detection to reduce false positives. Do not treat "faktura" + random alphanumeric as sufficient alone; require additional signal (label match, strong candidate score, or combination with date/amount). Reuse existing scoring where possible; avoid weak regex-only checks.
</objective>

<execution_context>
@.planning/phases/15-extraction-quality-hardening/15-CONTEXT.md
@.planning/phases/15-extraction-quality-hardening/15-DISCUSS.md
</execution_context>

<context>
@.planning/phases/15-extraction-quality-hardening/15-DISCUSS.md
@src/pipeline/invoice_boundary_detection.py
</context>

<tasks>

<task type="auto">
  <name>Require extra signal beyond faktura+alphanumeric</name>
  <files>src/pipeline/invoice_boundary_detection.py</files>
  <action>
Change logic so that "faktura" plus random alphanumeric is not enough to classify as invoice boundary. Require at least one of: label match (e.g. "Fakturanr"), strong candidate score from existing scorer, or combination with date/amount-like signals. Per 15-DISCUSS D5.
</action>
</task>

<task type="auto">
  <name>Prefer scoring over regex-only</name>
  <files>src/pipeline/invoice_boundary_detection.py</files>
  <action>
Where possible reuse existing scoring and structural signals instead of adding new regex-only checks. Preserve behaviour on multi-invoice PDFs (do not break true boundaries).
</action>
</task>

</tasks>

<verification>
- False positives from "faktura"+alphanumeric reduced.
- Multi-invoice PDFs still detect correct boundaries.
</verification>
