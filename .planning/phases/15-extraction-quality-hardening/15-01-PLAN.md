---
phase: 15-extraction-quality-hardening
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [src/models/token.py, src/pipeline/ocr_abstraction.py, src/pipeline/confidence_scoring.py]
autonomous: true

must_haves:
  truths:
    - "Token has confidence: Optional[float]; OCR stores TSV word-level conf in Token.confidence; conf < 0 excluded from tokens and aggregation"
    - "ocr_abstraction exposes ocr_median_conf, ocr_mean_conf, ocr_low_conf_fraction (or ocr_page_metrics) per 15-DISCUSS D1"
    - "confidence_scoring uses actual token confidence for OCR tokens; no placeholder 1.0"
  artifacts:
    - path: "src/models/token.py"
      provides: "Token with confidence field"
    - path: "src/pipeline/ocr_abstraction.py"
      provides: "OCR metrics helpers and TSV→Token.confidence"
    - path: "src/pipeline/confidence_scoring.py"
      provides: "Scoring uses real token confidence"
  key_links:
    - from: "confidence_scoring"
      to: "ocr_abstraction / Token"
      via: "Token.confidence when present"
---

<objective>
Complete D1 per 15-DISCUSS: ensure Token has confidence, ocr_abstraction stores TSV word confidence (exclude conf&lt;0), OCR metrics (median/mean/low_conf_fraction) exist, and confidence_scoring uses actual token confidence — remove any placeholder 1.0 for OCR tokens.
</objective>

<execution_context>
@.planning/phases/15-extraction-quality-hardening/15-CONTEXT.md
@.planning/phases/15-extraction-quality-hardening/15-DISCUSS.md
</execution_context>

<context>
@.planning/phases/15-extraction-quality-hardening/15-DISCUSS.md
@src/models/token.py
@src/pipeline/ocr_abstraction.py
@src/pipeline/confidence_scoring.py
</context>

<tasks>

<task type="auto">
  <name>Ensure Token.confidence and OCR persistence</name>
  <files>src/models/token.py, src/pipeline/ocr_abstraction.py</files>
  <action>
Confirm Token has confidence: Optional[float]. In ocr_abstraction, store TSV word-level confidence into Token.confidence for word tokens; exclude conf &lt; 0 (or level != 5) from token creation and from any aggregation. Use R1–R4 constants where thresholds are needed (e.g. OCR_MEDIAN_CONF_ROUTING_THRESHOLD, OCR_LOW_CONF_FRACTION_THRESHOLD).
</action>
</task>

<task type="auto">
  <name>Ensure OCR metrics helpers</name>
  <files>src/pipeline/ocr_abstraction.py</files>
  <action>
Provide ocr_median_conf, ocr_mean_conf, ocr_low_conf_fraction (or a single function/dataclass returning all) from a list of Tokens. Exclude conf &lt; 0 from aggregation. Align with 15-DISCUSS D1 and Phase 14 R2.
</action>
</task>

<task type="auto">
  <name>Use actual token confidence in confidence_scoring</name>
  <files>src/pipeline/confidence_scoring.py</files>
  <action>
Where OCR tokens or token-level confidence is available, use Token.confidence instead of a placeholder 1.0. Remove or gate any "default 1.0" behavior for OCR path so that scoring reflects real confidence. Per 15-DISCUSS D1.
</action>
</task>

</tasks>

<verification>
- Token.confidence is set from OCR TSV for word tokens; conf &lt; 0 excluded.
- OCR metrics (median/mean/low_conf_fraction) are available and used.
- confidence_scoring does not use placeholder 1.0 for OCR tokens when confidence is available.
</verification>
