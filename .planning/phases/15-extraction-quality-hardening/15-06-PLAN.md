---
phase: 15-extraction-quality-hardening
plan: 06
type: execute
wave: 1
depends_on: []
files_modified: [src/pipeline/invoice_line_parser.py]
autonomous: true

must_haves:
  truths:
    - "Footer keyword logic split into HARD vs SOFT; SOFT requires extra signal (footer zone, amount patterns) before classifying as footer"
    - "No O(n²) token index lookups (e.g. avoid row.tokens.index(token) in loops)"
    - "Amount detection prefers bbox/X-position over brittle char-offset mapping"
  artifacts:
    - path: "src/pipeline/invoice_line_parser.py"
      provides: "Robust line parsing, hard/soft footer keywords, O(n) hot path"
  key_links:
    - from: "invoice_line_parser"
      to: "segment / row"
      via: "bbox and token order"
---

<objective>
Complete D6 per 15-DISCUSS: in invoice_line_parser split footer keyword logic into HARD vs SOFT; for SOFT require additional signal (footer zone, amount patterns) before classifying as footer. Remove O(n²) token index lookups (e.g. row.tokens.index(token) in loops). Prefer bbox/X-position based amount detection over char-offset mapping.
</objective>

<execution_context>
@.planning/phases/15-extraction-quality-hardening/15-CONTEXT.md
@.planning/phases/15-extraction-quality-hardening/15-DISCUSS.md
</execution_context>

<context>
@.planning/phases/15-extraction-quality-hardening/15-DISCUSS.md
@src/pipeline/invoice_line_parser.py
</context>

<tasks>

<task type="auto">
  <name>HARD vs SOFT footer keywords</name>
  <files>src/pipeline/invoice_line_parser.py</files>
  <action>
Split footer keyword logic: HARD keywords (e.g. clear footer-only phrases) classify as footer directly; SOFT keywords require additional signal (footer zone, amount patterns, or similar) before marking as footer. Reduces misclassification of body lines as footer. Per 15-DISCUSS D6.
</action>
</task>

<task type="auto">
  <name>Remove O(n²) index lookups</name>
  <files>src/pipeline/invoice_line_parser.py</files>
  <action>
Find any row.tokens.index(token) or similar in loops and replace with O(n) patterns (e.g. precompute index map, or iterate with enumerate). Ensure hot path has no O(n²) token lookups. Per 15-DISCUSS D6.
</action>
</task>

<task type="auto">
  <name>Bbox/X-based amount detection</name>
  <files>src/pipeline/invoice_line_parser.py</files>
  <action>
Where amount or total is detected from tokens, prefer bbox or X-position based logic over brittle character-offset mapping. Reduces failures on split OCR tokens or layout quirks. Per 15-DISCUSS D6.
</action>
</task>

</tasks>

<verification>
- HARD/SOFT footer logic in place; SOFT requires extra signal.
- No O(n²) token index lookups in hot path.
- Amount detection uses bbox/X where appropriate.
</verification>
