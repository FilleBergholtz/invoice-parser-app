---
phase: 09-ai-data-analysis
plan: 03
type: execute
wave: 3
depends_on: ["09-02"]
files_modified: [src/analysis/query_executor.py, src/cli/main.py]
autonomous: true

must_haves:
  truths:
    - "System executes queries against invoice data"
    - "System presents query results in structured format"
    - "System can summarize invoice data"
    - "User can ask natural language questions via CLI"
  artifacts:
    - path: "src/analysis/query_executor.py"
      provides: "Query execution and result formatting"
      exports: ["execute_query", "format_results"]
  key_links:
    - from: "src/analysis/query_executor.py"
      to: "src/analysis/query_processor.py"
      via: "Uses QueryIntent to execute queries"
      pattern: "QueryIntent"
    - from: "src/analysis/query_executor.py"
      to: "src/analysis/data_loader.py"
      via: "Uses InvoiceDataStore to retrieve data"
      pattern: "InvoiceDataStore"
    - from: "src/cli/main.py"
      to: "src/analysis/query_executor.py"
      via: "CLI command for querying"
      pattern: "execute_query|--query"
---

<objective>
Create query executor that executes structured queries against invoice data and formats results. Add CLI command for querying.

Purpose: Build query executor that takes QueryIntent, filters/aggregates invoice data, and formats results. Add CLI --query command for natural language queries.

Output: execute_query function, format_results function, CLI --query command.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-ai-data-analysis/09-CONTEXT.md
@src/analysis/query_processor.py
@src/analysis/data_loader.py
@src/cli/main.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create query executor</name>
  <files>src/analysis/query_executor.py</files>
  <action>
Create query executor module `src/analysis/query_executor.py`.

**Functions to implement:**

1. `execute_query(
    query_intent: QueryIntent,
    data_store: InvoiceDataStore
) -> Dict[str, Any]`:
   - Execute query against invoice data
   - Apply filters (supplier, date range, amount range, status)
   - Apply aggregations (sum, count, average)
   - Group by field if specified
   - Sort results if specified
   - Limit results if specified
   - Return results dict

2. `format_results(
    results: Dict[str, Any],
    query_intent: QueryIntent
) -> str`:
   - Format query results as readable text
   - Handle different query types (filter, aggregate, summarize, compare)
   - Include relevant invoice details
   - Format aggregations nicely
   - Return formatted string

**Query Execution Logic:**
- Filter invoices by supplier, date range, amount range, status
- Aggregate: sum, count, average of amounts
- Group by: supplier, month, status, etc.
- Sort: by date, amount, supplier, etc.
- Limit: max number of results

**Result Formatting:**
- Filter queries: List invoices with details
- Aggregate queries: Show totals, counts, averages
- Summarize queries: Summary statistics, breakdowns
- Compare queries: Side-by-side comparison

**Error Handling:**
- Handle empty results
- Handle invalid filters
- Handle aggregation errors

Add type hints and docstrings.
  </action>
  <verify>python -c "from src.analysis.query_executor import execute_query, format_results; print('Query executor imported successfully')"</verify>
  <done>Query executor created with filtering, aggregation, and result formatting</done>
</task>

<task type="auto">
  <name>Task 2: Add CLI query command</name>
  <files>src/cli/main.py</files>
  <action>
Add CLI command for natural language querying.

**Add argparse argument:**
- `--query "question"`: Natural language query about invoice data
- `--excel-path PATH`: Path to Excel file with invoice data (optional, default: latest in output dir)

**Implementation:**
- Parse query argument
- Load invoices from Excel (use --excel-path or find latest)
- Parse natural language query using parse_query()
- Execute query using execute_query()
- Format and print results using format_results()

**Error Handling:**
- Handle missing Excel file
- Handle query parsing errors
- Handle query execution errors
- Print helpful error messages

**Example Usage:**
```bash
python -m src.cli.main --query "Visa alla fakturor fr√•n Acme Corp i januari" --excel-path data/excel/invoices.xlsx
```

Update imports and add query handler function.
  </action>
  <verify>python -m src.cli.main --help | grep -i query</verify>
  <done>CLI query command added for natural language querying</done>
</task>

</tasks>
