---
phase: 09-ai-data-analysis
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [src/analysis/__init__.py, src/analysis/data_loader.py]
autonomous: true

must_haves:
  truths:
    - "System can load processed invoice data from Excel files"
    - "System stores invoice data in memory or database for querying"
  artifacts:
    - path: "src/analysis/data_loader.py"
      provides: "Invoice data loading from Excel files"
      exports: ["load_invoices_from_excel", "InvoiceDataStore"]
  key_links:
    - from: "src/analysis/data_loader.py"
      to: "src/export/excel_export.py"
      via: "Reads Excel files created by export"
      pattern: "export_to_excel|Excel"
    - from: "src/analysis/data_loader.py"
      to: "src/models/invoice_header.py"
      via: "Loads InvoiceHeader objects"
      pattern: "InvoiceHeader"
---

<objective>
Create invoice data loading system to read processed invoices from Excel files for querying.

Purpose: Build data loader that reads Excel files exported by the system, parses invoice data, and stores it in a queryable format (in-memory or SQLite).

Output: InvoiceDataStore class and load_invoices_from_excel function.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-ai-data-analysis/09-CONTEXT.md
@src/export/excel_export.py
@src/models/invoice_header.py
@src/models/invoice_line.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create invoice data loader</name>
  <files>src/analysis/data_loader.py</files>
  <action>
Create invoice data loading module `src/analysis/data_loader.py`.

**Dependencies:**
- pandas (already in dependencies)
- openpyxl (already in dependencies)

**Classes/Functions to implement:**

1. `InvoiceDataStore` class:
   - Methods:
     - `__init__()`: Initialize empty store
     - `add_invoice(invoice_data: Dict) -> None`: Add invoice to store
     - `get_invoices(filters: Optional[Dict] = None) -> List[Dict]`: Get invoices with optional filters
     - `get_all_invoices() -> List[Dict]`: Get all invoices
     - `clear() -> None`: Clear all invoices

2. `load_invoices_from_excel(excel_path: str) -> InvoiceDataStore`:
   - Read Excel file created by export_to_excel()
   - Parse invoice metadata and line items
   - Group by invoice (using Faktura-ID or fakturanummer)
   - Create InvoiceDataStore with all invoices
   - Return InvoiceDataStore instance

**Excel Structure (from excel_export.py):**
- Columns: Fakturanummer, Referenser, Företag, Fakturadatum, Beskrivning, Antal, Enhet, Á-pris, Rabatt, Summa, Hela summan, Faktura-ID, Status, Radsumma, Avvikelse, Fakturanummer-konfidens, Totalsumma-konfidens
- One row per line item
- Invoice metadata repeated per row

**Data Structure:**
- Store as list of dicts, each dict represents one invoice:
  ```python
  {
    'invoice_number': str,
    'supplier_name': str,
    'invoice_date': date,
    'total_amount': float,
    'status': str,
    'line_items': List[Dict],
    'metadata': Dict
  }
  ```

**Error Handling:**
- Handle missing Excel file
- Handle invalid Excel format
- Handle missing columns
- Log warnings for parsing errors

Add type hints and docstrings.
  </action>
  <verify>python -c "from src.analysis.data_loader import load_invoices_from_excel, InvoiceDataStore; print('Invoice data loader imported successfully')"</verify>
  <done>Invoice data loader created with Excel reading and storage</done>
</task>

</tasks>
