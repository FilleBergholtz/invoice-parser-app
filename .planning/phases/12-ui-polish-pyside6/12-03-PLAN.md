---
phase: 12-ui-polish-pyside6
plan: 03
type: execute
wave: 1
depends_on: [12-01]
files_modified: [src/ui/services/engine_runner.py, src/ui/views/main_window.py]
autonomous: true

must_haves:
  truths:
    - "EngineRunner emits stateChanged(state), progressChanged(step/msg), logLine(str), finished(success, paths)"
    - "While Running: Run/Open disabled or appropriate controls disabled; progress and optional log visible"
    - "On Error: user-facing dialog with short message and expandable Show details (no raw trace in main message)"
  artifacts:
    - path: "src/ui/services/engine_runner.py"
      provides: "Standardized states and signals for engine run UX"
  key_links:
    - from: "main_window"
      to: "engine_runner"
      via: "Connects to stateChanged/progressChanged/finished; shows progress and error dialog"
---

<objective>
Standardize engine run states and signals, and improve UX: disable/enable controls during run, show progress and optional expandable log, and show user-friendly error dialog with "Show details". See 12-DISCUSS.md §3.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/12-ui-polish-pyside6/12-CONTEXT.md
@.planning/phases/12-ui-polish-pyside6/12-DISCUSS.md
@src/ui/services/engine_runner.py
@src/ui/views/main_window.py
</context>

<tasks>

<task type="auto">
  <name>Define states and add stateChanged / progressChanged / logLine / finished(success, paths)</name>
  <files>src/ui/services/engine_runner.py</files>
  <action>
**States (str or enum):** Idle, Running, Success, Warning, Error.

**Signals to add or align:**
- **stateChanged(str)** — emit with state name when state changes (Idle → Running at start; Running → Success/Warning/Error when done).
- **progressChanged(str)** — optional; step or short message (e.g. "Reading PDF…", "Extracting…"). Can reuse existing progress(str) as logLine and add progressChanged for higher-level steps, or use progress for both; DISCUSS says "step-based ok".
- **logLine(str)** — emit each line of stdout/stderr (existing progress(str) can be renamed or duplicated as logLine for clarity).
- **finished(bool success, object paths)** — emit when run ends; success = (exit_code == 0 or acceptable); paths = output paths (output_dir, excel_path, etc.) for caller to open/display. Keep existing finished(int) only if needed for backward compat; prefer one finished(success, paths) or add overload.

In run(): emit stateChanged("Running") at start; on exit emit stateChanged("Success"|"Warning"|"Error"), then finished(success, paths). On exception emit stateChanged("Error"), error(msg), finished(False, None).
  </action>
  <verify>python -c "from src.ui.services.engine_runner import EngineRunner; r=EngineRunner('',''); assert hasattr(r,'stateChanged') or hasattr(r,'progress'); print('signals ok')"</verify>
</task>

<task type="auto">
  <name>MainWindow: disable/enable controls and show progress while Running</name>
  <files>src/ui/views/main_window.py</files>
  <action>
Connect to EngineRunner signals (stateChanged and/or started/finished):
- **While Running:** Disable Run button (and optionally Open, Export) to prevent double runs. Enable a progress indicator (QProgressBar indeterminate or a "Kör…" label/spinner).
- **Optional expandable log panel:** A collapsible area showing stdout/stderr lines (from logLine or progress). Use QPlainTextEdit in a QFrame with "Show log" / "Hide log" or similar. Default collapsed.
- When finished: re-enable Run/Open/Export; hide or clear progress; update status bar (see 12-02).
  </action>
</task>

<task type="auto">
  <name>On Error: user-friendly dialog with Show details</name>
  <files>src/ui/views/main_window.py</files>
  <action>
When engine_runner emits error or stateChanged("Error"):
- Show a QMessageBox or custom dialog with a **short user-facing message** (e.g. "Körningen misslyckades. Kontrollera att engine är installerad och att PDF-filen är giltig.").
- Add **"Show details"** (or "Visa detaljer") that expands to show the full error text / stderr / traceback in a read-only QPlainTextEdit. Do not put raw trace or long tech text in the main message.
- Buttons: OK (close). No new dependencies; use QMessageBox plus optional detail widget, or a small QDialog with QLabel + expandable section.
  </action>
  <verify>Trigger an error (e.g. invalid path or kill engine) and confirm dialog shows short message + expandable details.</verify>
</task>

</tasks>

<success_criteria>
- Engine run UX has robust states, progress, and safe error messaging. All changes in src/ui/.
</success_criteria>
