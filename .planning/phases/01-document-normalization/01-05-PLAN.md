---
phase: 01-document-normalization
plan: 05
type: execute
wave: 5
depends_on: ["01-04"]
files_modified: [src/export/excel_export.py, src/cli/main.py, tests/test_excel_export.py, tests/test_cli.py]
autonomous: true

must_haves:
  truths:
    - "System exports Excel file with one row per line item"
    - "Excel includes invoice metadata repeated per row (Fakturanummer, Fakturadatum, Företag, Totalsumma)"
    - "CLI accepts --input and --output flags"
    - "CLI processes invoices in batch and outputs status per invoice"
    - "Excel file uses Swedish column names"
  artifacts:
    - path: "src/export/excel_export.py"
      provides: "Excel export functionality with Swedish column names"
      exports: ["export_to_excel"]
    - path: "src/cli/main.py"
      provides: "CLI entry point with --input and --output flags"
      exports: ["main", "process_invoice", "process_batch"]
  key_links:
    - from: "src/cli/main.py"
      to: "src/export/excel_export.py"
      via: "Calls export_to_excel to create Excel file"
      pattern: "export_to_excel"
    - from: "src/export/excel_export.py"
      to: "src/models/invoice_line.py"
      via: "Takes List[InvoiceLine] as input"
      pattern: "List\[InvoiceLine\]|InvoiceLine"
---

<objective>
Implement Excel export and CLI interface for batch processing.

Purpose: Generate Excel output with Swedish column names, one row per line item with metadata repeated. Provide CLI interface for batch processing with progress reporting and error handling.
Output: Excel exporter, CLI entry point with batch processing.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-document-normalization/01-CONTEXT.md
@docs/02_data-model.md
@specs/invoice_pipeline_v1.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement Excel export with Swedish columns</name>
  <files>src/export/excel_export.py</files>
  <action>
Implement Excel export functionality with Swedish column names and one row per line item.

Function to implement:
- `export_to_excel(invoice_lines: List[InvoiceLine], output_path: str, invoice_metadata: Optional[Dict] = None) -> str`: Exports InvoiceLines to Excel file.

Excel structure:
- One row per InvoiceLine (product row)
- Swedish column names: Fakturanummer, Referenser, Företag, Fakturadatum, Beskrivning, Antal, Enhet, Á-pris, Rabatt, Summa, Hela summan
- Invoice metadata repeated per row (placeholder values in Phase 1):
  - Fakturanummer: placeholder (e.g., "TBD" or extracted filename)
  - Referenser: empty for Phase 1
  - Företag: placeholder
  - Fakturadatum: placeholder
  - Hela summan: sum of all line totals (calculated)
- Line item columns:
  - Beskrivning: InvoiceLine.description
  - Antal: InvoiceLine.quantity (if available)
  - Enhet: InvoiceLine.unit (if available)
  - Á-pris: InvoiceLine.unit_price (if available)
  - Rabatt: InvoiceLine.discount (if available)
  - Summa: InvoiceLine.total_amount (required)

Use pandas DataFrame + openpyxl for Excel generation. Format numeric columns appropriately. Ensure Swedish column names match 01-CONTEXT.md specification.

File naming: Use timestamp-based naming in CLI (this function just exports to given path).
  </action>
  <verify>python -c "from src.export.excel_export import export_to_excel; from src.models.invoice_line import InvoiceLine; lines = [InvoiceLine(rows=[], description='Test', total_amount=100.0, line_number=1, segment=None)]; path = export_to_excel(lines, 'test_output.xlsx'); import openpyxl; wb = openpyxl.load_workbook(path); ws = wb.active; assert 'Beskrivning' in [cell.value for cell in ws[1]]; assert 'Summa' in [cell.value for cell in ws[1]]"</verify>
  <done>export_to_excel creates Excel file with Swedish column names, one row per InvoiceLine, metadata repeated per row, numeric formatting correct</done>
</task>

<task type="auto">
  <name>Task 2: Implement CLI interface with batch processing</name>
  <files>src/cli/main.py</files>
  <action>
Implement CLI interface according to 01-CONTEXT.md specifications.

Command syntax: `invoice-parser --input input_dir --output output_dir`

CLI functionality:
- Parse arguments using argparse:
  - --input: Input directory or file list (supports both)
  - --output: Output directory for Excel files
  - --fail-fast: Optional flag (default: continue on errors)
  - --verbose: Optional flag for debug output
- Batch processing:
  - Process all PDF files in input directory or specified file list
  - For each PDF: read → detect type → extract tokens → group rows → identify segments → extract line items → export to Excel
  - Collect all InvoiceLines from all invoices
  - Create single consolidated Excel file: `invoices_YYYY-MM-DD_HH-MM-SS.xlsx`
- Progress reporting:
  - Counter: `Processing N/M...`
  - Status per invoice: `[N/M] filename.pdf → Processing...`
  - Final summary: totals and file paths
- Error handling (from 01-CONTEXT.md):
  - Corrupt PDFs: move to errors/{filename}.pdf, log in error report
  - Continue processing by default (unless --fail-fast)
  - Create structured error JSON: `errors/errors_YYYY-MM-DD_HH-MM-SS.json`

Entry point: `if __name__ == "__main__": main()`. Use click or argparse for argument parsing.
  </action>
  <verify>python -m src.cli.main --help</verify>
  <done>CLI interface implemented with --input and --output flags, batch processing works, progress reporting matches 01-CONTEXT.md format</done>
</task>

<task type="auto">
  <name>Task 3: Integrate pipeline steps into CLI</name>
  <files>src/cli/main.py</files>
  <action>
Integrate all pipeline steps into CLI workflow for complete invoice processing.

Pipeline integration:
- Read PDF → create Document
- Detect PDF type → route to extraction path
- For each page: extract tokens (pdfplumber or OCR based on type)
- Group tokens to rows
- Identify segments
- Extract line items from items segment
- Combine line items from all pages
- Export to Excel

Handle multi-page invoices:
- Process all pages, combine items segments across pages
- Maintain line numbering globally across pages
- Preserve traceability (InvoiceLine.rows → Row.page reference tracks page number)

Error handling:
- Wrap each invoice processing in try/except
- On error: move corrupt PDF to errors/, log error details
- Continue with next invoice (unless --fail-fast)
- Collect errors in structured format for JSON export

Status output:
- Per invoice: `[N/M] filename.pdf → Processing... → OK (X line items)`
- Use format from 01-CONTEXT.md example

Final summary:
- Count: OK, failed invoices
- Excel file path
- Errors JSON path (if errors occurred)
  </action>
  <verify>python -m src.cli.main --input tests/fixtures/pdfs --output test_output/</verify>
  <done>CLI integrates all pipeline steps, processes invoices end-to-end, creates consolidated Excel, handles errors correctly, outputs progress and summary</done>
</task>

<task type="auto">
  <name>Task 4: Write unit tests for Excel export and CLI</name>
  <files>tests/test_excel_export.py, tests/test_cli.py</files>
  <action>
Create unit tests for Excel export and CLI functionality.

Tests to write:
- test_excel_export.py:
  - Test Excel file creation with Swedish column names
  - Test one row per InvoiceLine
  - Test metadata repetition per row
  - Test numeric formatting
  - Test file structure (can open with openpyxl, has correct columns)

- test_cli.py:
  - Test CLI argument parsing (--input, --output)
  - Test batch processing (mock invoice processing)
  - Test error handling (corrupt PDF handling)
  - Test progress output format
  - Test final summary format

Use pytest fixtures. Mock PDF processing for CLI tests (don't require actual PDF files for all tests). Ensure tests run with `pytest tests/test_excel_export.py tests/test_cli.py -v`.
  </action>
  <verify>pytest tests/test_excel_export.py tests/test_cli.py -v</verify>
  <done>All Excel export and CLI unit tests pass, coverage >80% for excel_export and cli modules</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] pytest tests/test_excel_export.py tests/test_cli.py -v passes
- [ ] mypy type checking passes for all new files
- [ ] Excel export creates file with Swedish column names
- [ ] One row per InvoiceLine with metadata repeated
- [ ] CLI processes batch of invoices
- [ ] Progress reporting matches 01-CONTEXT.md format
- [ ] Error handling works (corrupt PDFs moved to errors/)
</verification>

<success_criteria>

- All tasks completed
- Excel export generates file with Swedish column names
- Excel structure: one row per line item, metadata repeated per row
- CLI interface accepts --input and --output flags
- CLI processes invoices in batch with progress reporting
- Error handling matches 01-CONTEXT.md specifications
- Unit tests pass with >80% coverage
- No type errors or linting issues

</success_criteria>

<output>
After completion, create `.planning/phases/01-document-normalization/01-05-SUMMARY.md`
</output>
