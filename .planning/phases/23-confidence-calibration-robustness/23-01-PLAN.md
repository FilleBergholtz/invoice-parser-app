# Phase 23 Plan 01: Confidence Calibration Robustness

**Phase:** 23-confidence-calibration-robustness  
**Plan:** 23-01  
**Status:** Complete  
**Created:** 2026-01-28  
**Completed:** 2026-01-28

---

## Goal

Robust kalibrering med equal-frequency binning, sample weights, komplett fallback-kedja, och segment-adaptiva thresholds.

---

## Tasks

### Task 1: CAL-01 - Equal-frequency binning ✅

**Objective:** Implementera quantile-baserad binning för ECE/MCE

**Changes:**
- Added `_quantile_bin_edges()` using `numpy.quantile()`
- Added `_get_bin_index()` for efficient bin lookup
- Updated `_calculate_ece()` and `_calculate_mce()` with `use_quantile_bins=True`
- `validate_calibration()` reports both `ece` (quantile) and `ece_equal_width`

**Verification:** Skewed data (80% near 0.9, 20% near 0.0-0.5) produces appropriate quantile edges

### Task 2: CAL-02 - Sample weights in isotonic ✅

**Objective:** Avoid "steppy" curves by passing counts as weights

**Changes:**
- Replaced `_aggregate_by_score()` with `_aggregate_by_score_with_weights()`
- Returns `(X_agg, y_agg, weights)` tuple
- `train_calibration_model()` calls `model.fit(X_agg, y_agg, sample_weight=w_agg)`

**Verification:** Aggregation returns correct weights (e.g., 4 samples at 0.8 → weight=4.0)

### Task 3: CAL-03 - Supplier-global models ✅

**Objective:** Fill gap in fallback chain (supplier, "*")

**Changes:**
- Added explicit loop in `train_segmented_calibration()` for `per_supplier` aggregation
- Creates models at all 4 levels: (supplier, field), (supplier, "*"), ("*", field), ("*", "*")

**Verification:** Registry contains supplier-global models (e.g., SUP_A/*, SUP_B/*)

### Task 4: CAL-04 - Safe filenames ✅

**Objective:** Prevent path traversal in registry save/load

**Changes:**
- Added `_safe_key()` function
- `CalibrationRegistry.save()` uses `_safe_key()` for filenames
- Manifest uses JSON array `[supplier, field]` instead of `supplier:field`
- `CalibrationRegistry.load()` handles both old and new formats

**Verification:** `../etc/passwd` becomes `_etc_passwd`

### Task 5: CAL-05 - Segment-adaptive min-samples ✅

**Objective:** Higher thresholds for more specific segments

**Changes:**
- New constants: `MIN_SAMPLES_SUPPLIER_FIELD=200`, `MIN_SAMPLES_SUPPLIER_GLOBAL=150`, `MIN_SAMPLES_FIELD_GLOBAL=100`, `MIN_SAMPLES_GLOBAL=50`
- Added `min_samples_for_segment(supplier, field)` function
- `train_calibration_model()` uses adaptive threshold when `min_samples=None`

**Verification:** Function returns correct thresholds for each segment type

### Task 6: CAL-06 - Volume-aware recalibration ✅

**Objective:** Avoid false positives from small-sample variance

**Changes:**
- Added `_suggest_recalibration()` with adaptive thresholds:
  - N < 200: ECE > 0.08 or MCE > 0.15
  - N < 500: ECE > 0.06 or MCE > 0.12
  - N ≥ 500: ECE > 0.05 or MCE > 0.10
- Requires at least 5 bins with data
- `format_validation_report()` explains which threshold was used

**Verification:** All 4 test cases return expected values

---

## Files Changed

| File | Changes |
|------|---------|
| `src/pipeline/confidence_calibration.py` | All CAL-01 to CAL-06 implementations |

---

## Test Results

```
=== CAL-04: Safe key test ===
Normal: supplier123
Special chars: .._etc_passwd
Unicode: Orebro_AB_Test_123

=== CAL-05: Min samples test ===
(supplier, field): 200
(supplier, *): 150
(*, field): 100
(*, *): 50

=== CAL-01: Quantile binning test ===
Edges for skewed data: [0.0, 0.26, 0.809, 0.909, 0.918, 0.93, 0.944, 0.96, 0.974, 0.987, 1.0]

=== CAL-02: Sample weights test ===
Scores: [0.8, 0.9]
Mean correct: [0.75, 1.0]
Weights: [4.0, 2.0]

=== CAL-03: Segmented training ===
Total models: 5
Supplier-global models: [('SUP_A', '*'), ('SUP_B', '*')]
Field-global models: [('*', 'total'), ('*', 'invoice_no')]

=== CAL-06: Volume-aware recalibration ===
N=100, ECE=0.06: False (expected: False)
N=100, ECE=0.09: True (expected: True)
N=600, ECE=0.06: True (expected: True)
N=100, bins=3: False (expected: False)

tests/test_validation.py: 34 passed
```

---

## Success Criteria Verification

| Criterion | Status |
|-----------|--------|
| Equal-frequency binning för stabil ECE/MCE | ✅ `numpy.quantile()` used |
| Sample weights i isotonic regression | ✅ `sample_weight=w_agg` passed |
| Supplier-global modeller skapas | ✅ (supplier, "*") trained |
| Säkra filnamn i registry | ✅ `_safe_key()` sanitizes |
| Adaptiva min-samples thresholds | ✅ 200/150/100/50 per level |
| Validation tar hänsyn till datavolym | ✅ Adaptive ECE/MCE thresholds |

---

*Plan completed: 2026-01-28*
