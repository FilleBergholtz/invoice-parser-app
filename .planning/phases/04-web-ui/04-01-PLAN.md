# Plan 04-01: Streamlit MVP - Grundläggande UI och Filuppladdning

**Phase:** 4 (Web UI)  
**Plan:** 1 of TBD  
**Status:** Ready to execute  
**Estimated Duration:** ~2-3 hours

---

## Objective

Skapa grundläggande Streamlit UI med filuppladdning och batch-bearbetning. Användare ska kunna ladda upp PDF-fakturor via webbläsare och se bearbetningsstatus.

---

## Background

Systemet har en fungerande CLI som kan processa fakturor. Nu behöver vi enkapsulera samma funktionalitet i ett Streamlit-gränssnitt för att möjliggöra web-baserad användning.

**Befintlig kod:**
- `src/cli/main.py` - CLI interface med `process_invoice()` och `process_batch()`
- Pipeline är modulär och kan användas som bibliotek
- Excel-export och review-rapporter redan implementerade

---

## Success Criteria

1. ✅ Streamlit-app kan startas med `streamlit run src/web/app.py`
2. ✅ Användare kan ladda upp en eller flera PDF-fakturor via filuppladdningswidget
3. ✅ Systemet processar uppladdade fakturor med befintlig pipeline
4. ✅ Bearbetningsstatus visas för varje faktura (OK/PARTIAL/REVIEW/FAILED)
5. ✅ Användare kan se lista över bearbetade fakturor med grundläggande info (fakturanummer, status, totalsumma)
6. ✅ Användare kan ladda ner Excel-fil med resultat

---

## Implementation Steps

### Step 1: Setup Streamlit och Projektstruktur

**Files to create:**
- `src/web/__init__.py`
- `src/web/app.py` - Huvudapplikation
- `requirements.txt` - Lägg till `streamlit>=1.28.0`

**Tasks:**
1. Installera Streamlit som dependency
2. Skapa `src/web/` directory structure
3. Skapa grundläggande `app.py` med Streamlit hello world

**Acceptance:**
- `streamlit run src/web/app.py` startar en tom app

---

### Step 2: Filuppladdning och Temporär Lagring

**Files to modify:**
- `src/web/app.py`

**Tasks:**
1. Lägg till `st.file_uploader()` för PDF-uppladdning (stöd för flera filer)
2. Validera att uppladdade filer är PDF:er
3. Spara temporärt till disk (temp directory eller session state)
4. Visa lista över uppladdade filer

**Acceptance:**
- Användare kan ladda upp PDF:er
- Systemet validerar filtyp
- Uppladdade filer sparas temporärt

---

### Step 3: Integrera Befintlig Pipeline

**Files to modify:**
- `src/web/app.py`

**Tasks:**
1. Importera `process_invoice()` från `src.cli.main`
2. Skapa funktion som anropar pipeline för varje uppladdad PDF
3. Hantera fel gracefully (try/except, visa felmeddelanden)
4. Spara resultat i session state eller temporär struktur

**Acceptance:**
- Pipeline anropas korrekt för varje PDF
- Fel hanteras och visas till användaren
- Resultat sparas för visning

---

### Step 4: Visa Bearbetningsstatus och Resultat

**Files to modify:**
- `src/web/app.py`

**Tasks:**
1. Visa progress bar eller status för varje faktura under bearbetning
2. Skapa tabell/DataFrame med resultat (fakturanummer, status, totalsumma, antal rader)
3. Använd `st.dataframe()` eller `st.table()` för visning
4. Lägg till filtrering efter status (OK/PARTIAL/REVIEW)

**Acceptance:**
- Status visas under bearbetning
- Resultattabell visas efter bearbetning
- Filtrering fungerar

---

### Step 5: Excel-export och Nedladdning

**Files to modify:**
- `src/web/app.py`

**Tasks:**
1. Använd befintlig `export_to_excel()` från `src.export.excel_export`
2. Skapa Excel-fil med alla bearbetade fakturor
3. Använd `st.download_button()` för nedladdning
4. Rensa temporära filer efter nedladdning (valfritt)

**Acceptance:**
- Excel-fil genereras korrekt
- Användare kan ladda ner Excel-filen
- Filen innehåller alla bearbetade fakturor

---

## Technical Details

### Dependencies to Add

```toml
streamlit>=1.28.0
```

### File Structure

```
src/
├── web/
│   ├── __init__.py
│   └── app.py          # Streamlit huvudapplikation
```

### Key Functions

**`src/web/app.py`:**
- `main()` - Huvudfunktion som kör Streamlit-appen
- `process_uploaded_files(uploaded_files)` - Processar uppladdade PDF:er
- `display_results(results)` - Visar resultat i tabell
- `generate_excel_download(results)` - Genererar Excel för nedladdning

### Integration Points

- **Pipeline:** Använd `process_invoice()` från `src.cli.main`
- **Export:** Använd `export_to_excel()` från `src.export.excel_export`
- **Models:** Använd befintliga modeller (`InvoiceHeader`, `InvoiceLine`, `ValidationResult`)

---

## Testing Strategy

1. **Manual Testing:**
   - Ladda upp en PDF → Verifiera bearbetning
   - Ladda upp flera PDF:er → Verifiera batch-bearbetning
   - Testa med fakturor som ger OK/PARTIAL/REVIEW status
   - Verifiera Excel-nedladdning

2. **Edge Cases:**
   - Ogiltig filtyp (inte PDF)
   - Tom fil
   - Större filer
   - Fakturor som misslyckas

---

## Risks & Mitigations

| Risk | Impact | Mitigation |
|------|--------|------------|
| Streamlit kan bli långsam vid många filer | Medium | Processera i bakgrunden, visa progress |
| Temporär lagring kan bli stor | Low | Rensa efter nedladdning, begränsa antal filer |
| Fel i pipeline kraschar UI | High | Try/except runt pipeline-anrop, visa felmeddelanden |

---

## Out of Scope (Future Plans)

- Review workflow med klickbara PDF-länkar (Plan 04-02)
- Detaljvy för enskilda fakturor (Plan 04-02)
- API endpoints (Plan 04-03)
- Autentisering (Future)
- Persistent lagring/databas (Future)

---

## Definition of Done

- [ ] Streamlit-app kan startas och köras
- [ ] Filuppladdning fungerar för en eller flera PDF:er
- [ ] Pipeline anropas korrekt och processar fakturor
- [ ] Status visas för varje faktura
- [ ] Resultattabell visas med filtrering
- [ ] Excel-export och nedladdning fungerar
- [ ] Fel hanteras gracefully
- [ ] Manual testing genomförd med riktiga fakturor

---

*Plan created: 2026-01-17*
