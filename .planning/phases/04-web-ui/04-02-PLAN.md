# Plan 04-02: Streamlit MVP - Detaljvy och Review Workflow

**Phase:** 4 (Web UI)  
**Plan:** 2 of TBD  
**Status:** Pending (depends on 04-01)  
**Estimated Duration:** ~2-3 hours

---

## Objective

Utöka Streamlit UI med detaljvy för enskilda fakturor och review workflow med klickbara PDF-länkar för verifiering.

---

## Background

Efter Plan 04-01 har vi grundläggande UI med filuppladdning och resultatlista. Nu behöver användare kunna:
- Klicka på en faktura för att se detaljerad information
- Se extraherade fält (fakturanummer, totalsumma, företag, datum)
- Se linjeobjekt med valideringsvarningar
- Öppna PDF på rätt sida/position för verifiering (review workflow)

---

## Success Criteria

1. ✅ Användare kan klicka på en faktura i resultatlistan för att se detaljvy
2. ✅ Detaljvy visar alla extraherade fält (fakturanummer, totalsumma, företag, datum, status)
3. ✅ Detaljvy visar alla linjeobjekt med beskrivning, antal, á-pris, summa
4. ✅ Valideringsvarningar visas för linjeobjekt med problem
5. ✅ Klickbara länkar öppnar PDF på rätt sida (för fakturanummer och totalsumma)
6. ✅ PDF-visning fungerar i webbläsare (PDF.js eller Streamlit's inbyggda viewer)

---

## Implementation Steps

### Step 1: Detaljvy för Faktura

**Files to modify:**
- `src/web/app.py`

**Tasks:**
1. Lägg till session state för vald faktura
2. Skapa detaljvy-sektion som visas när faktura är vald
3. Visa extraherade fält från `InvoiceHeader` (fakturanummer, totalsumma, företag, datum)
4. Visa konfidensvärden för fakturanummer och totalsumma
5. Visa valideringsresultat (status, lines_sum, diff)

**Acceptance:**
- Klick på faktura i listan visar detaljvy
- Alla extraherade fält visas korrekt

---

### Step 2: Linjeobjekt-tabell med Varningar

**Files to modify:**
- `src/web/app.py`

**Tasks:**
1. Visa linjeobjekt i tabell (beskrivning, antal, enhet, á-pris, summa)
2. Markera rader med valideringsvarningar (t.ex. röd bakgrund eller ikon)
3. Visa varningstext när användare hovrar eller klickar på rad
4. Filtrera/sortera linjeobjekt (valfritt)

**Acceptance:**
- Alla linjeobjekt visas
- Varningar markeras tydligt
- Varningstext är läsbar

---

### Step 3: PDF-visning och Navigation

**Files to modify:**
- `src/web/app.py`

**Tasks:**
1. Använd Streamlit's `st.components.v1.iframe()` eller `st.file_downloader()` för PDF-visning
2. Alternativ: Använd PDF.js via custom component
3. Implementera navigation till specifik sida (från traceability)
4. Visa PDF i sidebar eller expanderbar sektion

**Acceptance:**
- PDF kan visas i webbläsare
- Navigation till specifik sida fungerar

---

### Step 4: Klickbara Länkar för Review Workflow

**Files to modify:**
- `src/web/app.py`

**Tasks:**
1. För fakturanummer: Skapa klickbar länk som öppnar PDF på rätt sida
2. För totalsumma: Skapa klickbar länk som öppnar PDF på rätt sida
3. Använd traceability-data (page_number, bbox) från `InvoiceHeader`
4. Implementera scroll/zoom till rätt position i PDF (om möjligt)

**Acceptance:**
- Klick på fakturanummer öppnar PDF på rätt sida
- Klick på totalsumma öppnar PDF på rätt sida
- PDF scrollar till rätt position (om tekniken stödjer det)

---

## Technical Details

### PDF-visning i Streamlit

**Alternativ 1: Streamlit's inbyggda viewer**
- `st.file_downloader()` - Nedladdning, inte visning
- `st.components.v1.iframe()` - Kan visa PDF men begränsad kontroll

**Alternativ 2: PDF.js via custom component**
- Mer kontroll över visning och navigation
- Kräver mer setup

**Rekommendation:** Börja med `st.components.v1.iframe()` för enkelhet, uppgradera till PDF.js om behov finns.

### Navigation till Specifik Sida

**Implementation:**
```python
# Använd traceability från InvoiceHeader
if invoice_header.invoice_number_traceability:
    page = invoice_header.invoice_number_traceability.page_number
    # Öppna PDF på rätt sida
    pdf_url = f"/pdf_viewer?file={pdf_path}&page={page}"
```

---

## Testing Strategy

1. **Manual Testing:**
   - Klicka på faktura i listan → Verifiera detaljvy
   - Klicka på fakturanummer-länk → Verifiera PDF öppnas på rätt sida
   - Klicka på totalsumma-länk → Verifiera PDF öppnas på rätt sida
   - Testa med fakturor som har valideringsvarningar

2. **Edge Cases:**
   - Fakturor utan traceability (ingen länk)
   - Fakturor med flera sidor
   - Fakturor med många linjeobjekt

---

## Risks & Mitigations

| Risk | Impact | Mitigation |
|------|--------|------------|
| PDF-visning fungerar inte i alla webbläsare | Medium | Testa i Chrome, Firefox, Safari |
| Navigation till specifik position i PDF är svår | Medium | Börja med sida-navigation, förbättra senare |
| Stora PDF:er kan bli långsamma att visa | Low | Lazy loading, visa först sida |

---

## Out of Scope (Future Plans)

- API endpoints (Plan 04-03)
- Persistent lagring/databas (Future)
- Användarhantering och autentisering (Future)

---

## Definition of Done

- [ ] Detaljvy visas när faktura klickas
- [ ] Alla extraherade fält visas korrekt
- [ ] Linjeobjekt-tabell med varningar fungerar
- [ ] PDF kan visas i webbläsare
- [ ] Klickbara länkar öppnar PDF på rätt sida
- [ ] Review workflow fungerar för verifiering
- [ ] Manual testing genomförd

---

*Plan created: 2026-01-17*
