# Plan 04-03: API Endpoints för Extern Integration

**Phase:** 4 (Web UI)  
**Plan:** 3 of TBD  
**Status:** Pending (depends on 04-01, 04-02)  
**Estimated Duration:** ~2-3 hours

---

## Objective

Skapa REST API endpoints för extern systemintegration. API ska tillåta externa system att processa fakturor programmatiskt.

---

## Background

Streamlit UI är bra för manuell användning, men externa system behöver API för integration. FastAPI är idealiskt för detta eftersom det ger automatisk OpenAPI-dokumentation och bra prestanda.

**Befintlig kod:**
- Pipeline i `src/cli/main.py` kan användas som bibliotek
- Streamlit UI använder samma pipeline

---

## Success Criteria

1. ✅ FastAPI-app kan startas och köras
2. ✅ API endpoint för att processa en faktura (POST /api/invoices/process)
3. ✅ API endpoint för att hämta status (GET /api/invoices/{invoice_id}/status)
4. ✅ API endpoint för att hämta resultat (GET /api/invoices/{invoice_id}/result)
5. ✅ OpenAPI-dokumentation tillgänglig på /docs
6. ✅ API returnerar JSON med strukturerad data

---

## Implementation Steps

### Step 1: Setup FastAPI och Projektstruktur

**Files to create:**
- `src/api/__init__.py`
- `src/api/main.py` - FastAPI applikation
- `src/api/models.py` - API request/response modeller
- `requirements.txt` - Lägg till `fastapi>=0.104.0`, `uvicorn>=0.24.0`

**Tasks:**
1. Installera FastAPI och Uvicorn
2. Skapa `src/api/` directory structure
3. Skapa grundläggande FastAPI-app med hello world endpoint

**Acceptance:**
- `uvicorn src.api.main:app --reload` startar API
- `/docs` visar OpenAPI-dokumentation

---

### Step 2: Invoice Processing Endpoint

**Files to modify:**
- `src/api/main.py`
- `src/api/models.py`

**Tasks:**
1. Skapa POST endpoint `/api/invoices/process`
2. Acceptera PDF-fil via multipart/form-data
3. Anropa `process_invoice()` från pipeline
4. Returnera JSON med resultat (invoice_id, status, line_count)
5. Hantera fel gracefully (HTTP status codes)

**Acceptance:**
- API kan processa en PDF-faktura
- Returnerar korrekt JSON-response
- Fel hanteras med rätt HTTP status codes

---

### Step 3: Status och Resultat Endpoints

**Files to modify:**
- `src/api/main.py`
- `src/api/models.py`

**Tasks:**
1. Skapa GET endpoint `/api/invoices/{invoice_id}/status`
2. Skapa GET endpoint `/api/invoices/{invoice_id}/result`
3. Implementera enkel lagring av resultat (in-memory eller filbaserad)
4. Returnera strukturerad JSON med alla extraherade fält

**Acceptance:**
- Status kan hämtas via API
- Resultat kan hämtas via API
- JSON-struktur är tydlig och dokumenterad

---

### Step 4: Batch Processing Endpoint

**Files to modify:**
- `src/api/main.py`

**Tasks:**
1. Skapa POST endpoint `/api/invoices/batch`
2. Acceptera flera PDF-filer
3. Processera asynkront eller synkront
4. Returnera lista med resultat för varje faktura

**Acceptance:**
- Batch-bearbetning fungerar via API
- Resultat returneras för alla fakturor

---

## Technical Details

### Dependencies to Add

```toml
fastapi>=0.104.0
uvicorn[standard]>=0.24.0
python-multipart>=0.0.6  # För filuppladdning
```

### File Structure

```
src/
├── api/
│   ├── __init__.py
│   ├── main.py          # FastAPI applikation
│   └── models.py        # API request/response modeller
```

### API Endpoints

**POST /api/invoices/process**
- Request: multipart/form-data med PDF-fil
- Response: `{"invoice_id": "...", "status": "OK", "line_count": 10}`

**GET /api/invoices/{invoice_id}/status**
- Response: `{"status": "OK", "invoice_number": "...", "total_amount": 1234.56}`

**GET /api/invoices/{invoice_id}/result**
- Response: Fullständig JSON med alla extraherade fält och linjeobjekt

**POST /api/invoices/batch**
- Request: multipart/form-data med flera PDF-filer
- Response: Lista med resultat för varje faktura

### Data Storage

**För MVP:** In-memory dictionary eller filbaserad lagring  
**För produktion:** Databas (SQLite, PostgreSQL)

---

## Testing Strategy

1. **Manual Testing:**
   - Testa endpoints med curl eller Postman
   - Verifiera JSON-responser
   - Testa felhantering (ogiltig fil, saknad fil, etc.)

2. **API Testing:**
   - Skapa enkla integrationstester
   - Verifiera OpenAPI-dokumentation

---

## Risks & Mitigations

| Risk | Impact | Mitigation |
|------|--------|------------|
| API kan bli långsam vid stora filer | Medium | Asynkron bearbetning, background jobs |
| Data storage kan bli problem | Low | Börja med enkel lagring, uppgradera senare |
| API security (ingen auth) | Medium | Lägg till auth senare, dokumentera begränsningar |

---

## Out of Scope (Future Plans)

- Autentisering och auktorisering (Future)
- Rate limiting (Future)
- Persistent databas (Future)
- Webhooks för notifikationer (Future)

---

## Definition of Done

- [ ] FastAPI-app kan startas och köras
- [ ] Invoice processing endpoint fungerar
- [ ] Status och resultat endpoints fungerar
- [ ] Batch processing endpoint fungerar
- [ ] OpenAPI-dokumentation är tillgänglig
- [ ] API testad med curl/Postman
- [ ] JSON-responser är korrekt strukturerade

---

*Plan created: 2026-01-17*
