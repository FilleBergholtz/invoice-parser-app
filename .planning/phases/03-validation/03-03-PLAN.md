---
phase: 03-validation
plan: 03
type: execute
wave: 3
depends_on: ["03-01"]
files_modified: [src/export/review_report.py, tests/test_review_report.py]
autonomous: true

must_haves:
  truths:
    - "System creates review reports only for invoices with REVIEW status"
    - "Review folder structure: review/{invoice_filename}/ with PDF copy + metadata.json"
    - "Metadata JSON contains InvoiceHeader data, Traceability evidence, and ValidationResult data"
    - "PDF is copied to review folder using shutil.copy2() (preserves metadata)"
    - "JSON serialization uses to_dict() methods from InvoiceHeader and Traceability objects"
  artifacts:
    - path: "src/export/review_report.py"
      provides: "Review report generation functionality"
      exports: ["create_review_report"]
    - path: "tests/test_review_report.py"
      provides: "Unit tests for review report generation"
  key_links:
    - from: "src/export/review_report.py"
      to: "src/models/invoice_header.py"
      via: "Serializes InvoiceHeader data to JSON"
      pattern: "InvoiceHeader|invoice_number|total_amount|supplier_name"
    - from: "src/export/review_report.py"
      to: "src/models/traceability.py"
      via: "Serializes Traceability evidence using to_dict()"
      pattern: "Traceability|to_dict"
    - from: "src/export/review_report.py"
      to: "src/models/validation_result.py"
      via: "Serializes ValidationResult data to JSON"
      pattern: "ValidationResult|status|lines_sum|diff"
---

<objective>
Implement review report generation for REVIEW status invoices.

Purpose: Create review report generation function that creates a folder per invoice (review/{invoice_filename}/), copies PDF to review folder, and generates metadata.json with InvoiceHeader, Traceability, and ValidationResult data serialized to JSON. Only REVIEW status invoices get review reports (saves space, focuses on issues).
Output: Review report generator, folder structure, JSON serialization.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-validation/03-CONTEXT.md
@.planning/phases/03-validation/03-RESEARCH.md
@docs/05_validation.md
@specs/invoice_pipeline_v1.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create review report generator function</name>
  <files>src/export/review_report.py</files>
  <action>
Create create_review_report() function according to 03-CONTEXT.md Decision 5 and 03-RESEARCH.md.

Function signature:
- `create_review_report(invoice_header: InvoiceHeader, validation_result: ValidationResult, line_items: List[InvoiceLine], pdf_path: str, output_dir: Path) -> Path`

Function logic:
1. Create review folder structure:
   - Extract PDF filename stem: `pdf_filename = Path(pdf_path).stem`
   - Create folder: `review_folder = output_dir / "review" / pdf_filename`
   - Create folder: `review_folder.mkdir(parents=True, exist_ok=True)`

2. Copy PDF to review folder:
   - Destination: `review_pdf_path = review_folder / f"{pdf_filename}.pdf"`
   - Use `shutil.copy2(pdf_path, review_pdf_path)` (preserves metadata/timestamps)
   - Handle errors: try/except, log warning if copy fails, continue

3. Serialize InvoiceHeader to dict:
   - invoice_number, invoice_number_confidence
   - total_amount, total_confidence
   - supplier_name, invoice_date (ISO format string if date, else None)
   - invoice_number_traceability: `invoice_header.invoice_number_traceability.to_dict() if invoice_header.invoice_number_traceability else None`
   - total_traceability: `invoice_header.total_traceability.to_dict() if invoice_header.total_traceability else None`

4. Serialize ValidationResult to dict:
   - status, lines_sum, diff, tolerance
   - hard_gate_passed, invoice_number_confidence, total_confidence
   - errors, warnings
   - line_count: `len(line_items)`

5. Combine into metadata structure:
   ```python
   metadata = {
       "invoice_header": header_dict,
       "validation": validation_dict,
       "timestamp": datetime.now().isoformat(),
   }
   ```

6. Write JSON file:
   - Path: `metadata_path = review_folder / "metadata.json"`
   - Use `json.dump(metadata, f, indent=2, ensure_ascii=False)`

7. Return review_folder path.

Import required modules: Path, shutil, json, datetime, InvoiceHeader, ValidationResult, InvoiceLine.
  </action>
  <verify>python -c "from src.export.review_report import create_review_report; # Basic import test"</verify>
  <done>create_review_report function implemented, creates folder structure, copies PDF, serializes metadata to JSON</done>
</task>

<task type="auto">
  <name>Task 2: Handle date serialization in JSON</name>
  <files>src/export/review_report.py</files>
  <action>
Handle date serialization for invoice_date field (from InvoiceHeader).

InvoiceHeader.invoice_date is Optional[date] (from datetime module).
JSON doesn't support date objects directly, so convert to ISO format string:
- If invoice_date exists: `invoice_header.invoice_date.isoformat()`
- If invoice_date is None: store as None in JSON

In InvoiceHeader serialization:
```python
"invoice_date": invoice_header.invoice_date.isoformat() if invoice_header.invoice_date else None
```

This ensures JSON-compatible format while preserving date information for review reports.
  </action>
  <verify>python -c "from src.export.review_report import create_review_report; # Verify date handling"</verify>
  <done>Date serialization handled, invoice_date converted to ISO format string in JSON</done>
</task>

<task type="auto">
  <name>Task 3: Write unit tests for review report generation</name>
  <files>tests/test_review_report.py</files>
  <action>
Create comprehensive unit tests for review report generation.

Tests to write:
1. Test folder creation:
   - Verify review folder created at correct path (output_dir / "review" / pdf_filename)
   - Verify folder created even if parent directories don't exist (parents=True)

2. Test PDF copying:
   - Verify PDF copied to review folder with correct filename
   - Verify copy preserves file metadata (use shutil.copy2)
   - Test error handling: if PDF doesn't exist, function should handle gracefully

3. Test metadata.json structure:
   - Verify JSON file created in review folder
   - Verify JSON contains invoice_header, validation, timestamp keys
   - Verify invoice_header contains all expected fields (invoice_number, total_amount, supplier_name, invoice_date, traceability)
   - Verify validation contains all expected fields (status, lines_sum, diff, errors, warnings, line_count)
   - Verify traceability serialized using to_dict() methods

4. Test date serialization:
   - Verify invoice_date converted to ISO format string if exists
   - Verify invoice_date is None in JSON if not present

5. Test Traceability serialization:
   - Verify invoice_number_traceability.to_dict() called if exists
   - Verify total_traceability.to_dict() called if exists
   - Verify None stored if traceability doesn't exist

6. Test edge cases:
   - Test with None traceability objects
   - Test with None invoice_date
   - Test with empty line_items list

Use pytest fixtures for InvoiceHeader, ValidationResult, InvoiceLine objects.
Use tempfile for temporary directories in tests.
Verify JSON is valid and can be parsed.

Ensure tests run with `pytest tests/test_review_report.py -v`.
  </action>
  <verify>pytest tests/test_review_report.py -v</verify>
  <done>All review report unit tests pass, folder structure verified, PDF copying tested, JSON serialization verified</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] pytest tests/test_review_report.py -v passes
- [ ] Review folder created at correct path (review/{invoice_filename}/)
- [ ] PDF copied to review folder using shutil.copy2()
- [ ] metadata.json created with correct structure
- [ ] InvoiceHeader data serialized correctly (including date as ISO string)
- [ ] Traceability evidence serialized using to_dict() methods
- [ ] ValidationResult data serialized correctly
- [ ] Error handling for PDF copy failures
</verification>

<success_criteria>

- All tasks completed
- Review report generator creates folder structure (review/{invoice_filename}/)
- PDF copied to review folder with correct filename
- metadata.json contains InvoiceHeader, Traceability, and ValidationResult data
- JSON serialization handles dates (ISO format) and Traceability objects (to_dict())
- Unit tests pass with >80% coverage
- No type errors or linting issues

</success_criteria>

<output>
After completion, create `.planning/phases/03-validation/03-03-SUMMARY.md`
</output>
