---
phase: 03-validation
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified: [src/export/excel_export.py, tests/test_excel_export.py]
autonomous: true

must_haves:
  truths:
    - "Excel export includes control columns after existing columns: Status, Radsumma, Avvikelse, Fakturanummer-konfidens, Totalsumma-konfidens"
    - "Control columns use Swedish names and proper formatting: Status (text), Radsumma (currency), Avvikelse (currency or 'N/A'), confidence (percentage)"
    - "Control column values repeat for all rows of same invoice (one row per line item, same validation data per invoice)"
    - "Confidence scores formatted as percentage (0.95 → 95%) using Excel percentage format"
    - "Diff column shows 'N/A' when total_amount is None (cannot calculate diff)"
  artifacts:
    - path: "src/export/excel_export.py"
      provides: "Excel export with control columns"
      exports: ["export_to_excel"]
    - path: "tests/test_excel_export.py"
      provides: "Unit tests for Excel export with control columns"
  key_links:
    - from: "src/export/excel_export.py"
      to: "src/models/invoice_line.py"
      via: "Exports InvoiceLine objects"
      pattern: "InvoiceLine"
    - from: "src/export/excel_export.py"
      to: "src/models/validation_result.py"
      via: "Uses validation data from invoice_metadata dict"
      pattern: "status|lines_sum|diff|invoice_number_confidence|total_confidence"
---

<objective>
Extend Excel export with control columns for validation data.

Purpose: Add control columns (Status, Radsumma, Avvikelse, Fakturanummer-konfidens, Totalsumma-konfidens) after existing columns in Excel export. Use Swedish names, proper formatting (percentage for confidence, currency for amounts, text for Status), and handle "N/A" for diff when total_amount is None. Control columns repeat same value for all rows of same invoice.
Output: Extended Excel export function with control columns, proper formatting.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-validation/03-CONTEXT.md
@.planning/phases/03-validation/03-RESEARCH.md
@docs/05_validation.md
@specs/invoice_pipeline_v1.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend invoice_metadata dict structure in Excel export</name>
  <files>src/export/excel_export.py</files>
  <action>
Update export_to_excel() function signature and documentation to accept validation data via invoice_metadata dict.

Extend invoice_metadata dict to include validation fields (from 03-CONTEXT.md Decision 7):
- status: str (OK/PARTIAL/REVIEW)
- lines_sum: float (SUM of all InvoiceLine.total_amount)
- diff: float or "N/A" (total_amount - lines_sum, or "N/A" if total_amount is None)
- invoice_number_confidence: float (0.0-1.0)
- total_confidence: float (0.0-1.0)

Update function docstring to document new metadata fields:
- Existing: fakturanummer, foretag, fakturadatum, referenser
- New: status, lines_sum, diff, invoice_number_confidence, total_confidence

Keep backward compatibility: validation fields are optional (use defaults if not provided).
Default values: status="REVIEW", lines_sum=0.0, diff="N/A", invoice_number_confidence=0.0, total_confidence=0.0
  </action>
  <verify>python -c "from src.export.excel_export import export_to_excel; # Basic import test"</verify>
  <done>export_to_excel() function signature and documentation updated, validation fields documented, backward compatible</done>
</task>

<task type="auto">
  <name>Task 2: Add control columns to DataFrame rows</name>
  <files>src/export/excel_export.py</files>
  <action>
Add control columns to DataFrame rows after existing columns (from 03-CONTEXT.md Decision 4).

Control columns (Swedish names):
- Status: str (OK/PARTIAL/REVIEW) - from metadata["status"]
- Radsumma: float (lines_sum) - from metadata["lines_sum"]
- Avvikelse: float or str (diff or "N/A") - from metadata["diff"]
- Fakturanummer-konfidens: float (invoice_number_confidence * 100) - convert to percentage
- Totalsumma-konfidens: float (total_confidence * 100) - convert to percentage

Column order (after existing columns):
1. Existing columns: Fakturanummer, Referenser, Företag, Fakturadatum, Beskrivning, Antal, Enhet, Á-pris, Rabatt, Summa, Hela summan
2. NEW: Status, Radsumma, Avvikelse, Fakturanummer-konfidens, Totalsumma-konfidens

In row building loop, add control columns to each row:
- Extract validation fields from metadata with defaults
- Convert confidence scores to percentage: `metadata.get("invoice_number_confidence", 0.0) * 100`
- Handle diff: use metadata["diff"] directly (already "N/A" or float)

All rows for same invoice get same validation values (one row per line item, same metadata).
  </action>
  <verify>python -c "from src.export.excel_export import export_to_excel; # Verify function works"</verify>
  <done>Control columns added to DataFrame rows after existing columns, Swedish names, confidence converted to percentage</done>
</task>

<task type="auto">
  <name>Task 3: Apply Excel formatting to control columns</name>
  <files>src/export/excel_export.py</files>
  <action>
Apply proper Excel formatting to control columns using openpyxl (from 03-CONTEXT.md Decision 4).

Formatting rules:
- Status: Text format (no formatting needed, already text)
- Radsumma: Currency format (FORMAT_NUMBER_00 or "#,##0.00")
- Avvikelse: Currency format if numeric, text if "N/A" (check value type)
- Fakturanummer-konfidens: Percentage format (FORMAT_PERCENTAGE_00) - value already multiplied by 100
- Totalsumma-konfidens: Percentage format (FORMAT_PERCENTAGE_00) - value already multiplied by 100

In Excel formatting section (after df.to_excel()):
1. Get worksheet: `worksheet = writer.sheets['Invoices']`
2. Find column indices for control columns (they come after existing 11 columns)
   - Status: column 11 (index 11, 0-indexed)
   - Radsumma: column 12 (index 12)
   - Avvikelse: column 13 (index 13)
   - Fakturanummer-konfidens: column 14 (index 14)
   - Totalsumma-konfidens: column 15 (index 15)
3. Iterate through data rows (min_row=2 to max_row):
   - Format Radsumma: `row[12].number_format = FORMAT_NUMBER_00`
   - Format Avvikelse: Check if numeric or "N/A", format only if numeric
   - Format confidence columns: `row[14].number_format = FORMAT_PERCENTAGE_00` and `row[15].number_format = FORMAT_PERCENTAGE_00`

Import from openpyxl: `from openpyxl.styles.numbers import FORMAT_NUMBER_00, FORMAT_PERCENTAGE_00`

Note: Percentage format expects values as percentages (95 for 95%), so we multiply by 100 before writing (already done in Task 2).
  </action>
  <verify>python -c "from src.export.excel_export import export_to_excel; # Verify formatting works"</verify>
  <done>Excel formatting applied to control columns: currency for amounts, percentage for confidence, text for Status and "N/A"</done>
</task>

<task type="auto">
  <name>Task 4: Update unit tests for Excel export with control columns</name>
  <files>tests/test_excel_export.py</files>
  <action>
Update existing unit tests and add new tests for control columns.

Tests to add/update:
1. Test control columns present in exported Excel:
   - Verify Status, Radsumma, Avvikelse, Fakturanummer-konfidens, Totalsumma-konfidens columns exist
   - Verify columns appear after existing columns (correct order)

2. Test control column values:
   - Verify Status value from metadata
   - Verify Radsumma = lines_sum from metadata
   - Verify Avvikelse = diff or "N/A" from metadata
   - Verify confidence columns = percentage (confidence * 100)

3. Test formatting:
   - Verify Radsumma formatted as currency (number format)
   - Verify Avvikelse formatted as currency if numeric, text if "N/A"
   - Verify confidence columns formatted as percentage

4. Test backward compatibility:
   - Verify export works without validation fields in metadata (uses defaults)

Use openpyxl to read Excel file and verify:
- Column names match expected Swedish names
- Values match expected data
- Cell number formats match expected formats

Ensure tests run with `pytest tests/test_excel_export.py -v`.
  </action>
  <verify>pytest tests/test_excel_export.py -v</verify>
  <done>Excel export unit tests updated, control columns tested, formatting verified, backward compatibility maintained</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] pytest tests/test_excel_export.py -v passes
- [ ] Excel export includes control columns after existing columns
- [ ] Control columns use Swedish names
- [ ] Confidence scores formatted as percentage (0.95 → 95%)
- [ ] Radsumma and Avvikelse formatted as currency
- [ ] Diff column shows "N/A" when total_amount is None
- [ ] Control column values repeat for all rows of same invoice
- [ ] Backward compatibility maintained (works without validation fields)
</verification>

<success_criteria>

- All tasks completed
- Control columns added to Excel export (Status, Radsumma, Avvikelse, Fakturanummer-konfidens, Totalsumma-konfidens)
- Control columns placed after existing columns
- Swedish column names used
- Proper Excel formatting: percentage for confidence, currency for amounts, text for Status
- Diff column handles "N/A" when total_amount is None
- Control columns repeat same value for all rows of same invoice
- Unit tests pass with >80% coverage
- No type errors or linting issues

</success_criteria>

<output>
After completion, create `.planning/phases/03-validation/03-02-SUMMARY.md`
</output>
