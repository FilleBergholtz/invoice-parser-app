---
phase: 03-validation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [src/pipeline/validation.py, src/models/validation_result.py, tests/test_validation.py]
autonomous: true

must_haves:
  truths:
    - "System performs mathematical validation: calculates lines_sum = SUM(all line item totals)"
    - "System calculates diff = total_amount - lines_sum (signed difference, not absolute)"
    - "System assigns status: OK (hard gate pass + diff ≤ ±1 SEK), PARTIAL (hard gate pass + diff > ±1 SEK), REVIEW (hard gate fail or cannot validate)"
    - "System implements hard gates: OK status ONLY when both invoice number AND total are ≥0.95 confidence"
    - "System handles edge cases: no line items → REVIEW, total_amount None → REVIEW, etc."
  artifacts:
    - path: "src/models/validation_result.py"
      provides: "ValidationResult data model with status, lines_sum, diff, confidence scores, errors, warnings"
      contains: "class ValidationResult"
    - path: "src/pipeline/validation.py"
      provides: "Validation logic and status assignment"
      exports: ["validate_invoice", "calculate_validation_values"]
  key_links:
    - from: "src/pipeline/validation.py"
      to: "src/models/invoice_header.py"
      via: "Uses InvoiceHeader.meets_hard_gate() and extracts confidence scores"
      pattern: "InvoiceHeader|meets_hard_gate|invoice_number_confidence|total_confidence"
    - from: "src/pipeline/validation.py"
      to: "src/models/invoice_line.py"
      via: "Calculates lines_sum from InvoiceLine.total_amount"
      pattern: "InvoiceLine|total_amount|sum"
    - from: "src/pipeline/validation.py"
      to: "src/pipeline/confidence_scoring.py"
      via: "Reuses validate_total_against_line_items() for mathematical validation"
      pattern: "validate_total_against_line_items"
    - from: "src/pipeline/validation.py"
      to: "src/models/validation_result.py"
      via: "Returns ValidationResult object with all validation data"
      pattern: "ValidationResult"
---

<objective>
Implement ValidationResult model and status assignment logic with hard gates and mathematical validation.

Purpose: Create ValidationResult data model and validate_invoice() function that performs mathematical validation (lines_sum vs total), checks hard gates (invoice number + total confidence ≥0.95), and assigns status (OK/PARTIAL/REVIEW) based on 03-CONTEXT.md logic. This is the foundation for Phase 3 validation.
Output: ValidationResult model, validate_invoice() function with status assignment logic, edge case handling.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-validation/03-CONTEXT.md
@.planning/phases/03-validation/03-RESEARCH.md
@docs/05_validation.md
@specs/invoice_pipeline_v1.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ValidationResult data model</name>
  <files>src/models/validation_result.py</files>
  <action>
Create ValidationResult dataclass according to 03-CONTEXT.md and 03-RESEARCH.md.

Model structure:
- status: str (must be "OK", "PARTIAL", or "REVIEW")
- lines_sum: float (SUM of all InvoiceLine.total_amount, always ≥0)
- diff: Optional[float] (total_amount - lines_sum, signed difference, None if total_amount is None)
- tolerance: float (default 1.0 SEK)
- hard_gate_passed: bool (True if both confidences >= 0.95)
- invoice_number_confidence: float (from InvoiceHeader)
- total_confidence: float (from InvoiceHeader)
- errors: List[str] (validation error messages)
- warnings: List[str] (validation warning messages)

Validation in __post_init__:
- status must be one of ["OK", "PARTIAL", "REVIEW"]
- lines_sum must be >= 0
- confidence scores must be 0.0-1.0

Use dataclass pattern with field(default_factory=list) for errors and warnings.

Ensure proper imports: from __future__ import annotations, dataclass, field, Optional, List.
  </action>
  <verify>python -c "from src.models.validation_result import ValidationResult; # Basic import test"</verify>
  <done>ValidationResult dataclass created with all required fields, __post_init__ validation, default values</done>
</task>

<task type="auto">
  <name>Task 2: Implement calculate_validation_values helper</name>
  <files>src/pipeline/validation.py</files>
  <action>
Implement helper function for calculating validation values (lines_sum, diff, validation_passed).

Function to implement:
- `calculate_validation_values(total_amount: Optional[float], line_items: List[InvoiceLine], tolerance: float = 1.0) -> Tuple[float, Optional[float], bool]`: Calculates lines_sum, diff, validation_passed

Algorithm:
1. Calculate lines_sum: `sum(line.total_amount for line in line_items) if line_items else 0.0`
2. If total_amount is None: return (lines_sum, None, False)
3. If total_amount exists: calculate diff = total_amount - lines_sum (signed, can be negative)
4. Reuse `validate_total_against_line_items()` from confidence_scoring.py to check validation_passed
5. Return (lines_sum, diff, validation_passed)

Import from confidence_scoring: `from ..pipeline.confidence_scoring import validate_total_against_line_items`

Ensure proper type hints: Optional[float], List[InvoiceLine], Tuple.
  </action>
  <verify>python -c "from src.pipeline.validation import calculate_validation_values; # Basic import test"</verify>
  <done>calculate_validation_values implemented, reuses Phase 2 validation function, calculates signed diff</done>
</task>

<task type="auto">
  <name>Task 3: Implement validate_invoice function with status assignment</name>
  <files>src/pipeline/validation.py</files>
  <action>
Implement validate_invoice() function with status assignment logic according to 03-CONTEXT.md Decision 2.

Function signature:
- `validate_invoice(invoice_header: InvoiceHeader, line_items: List[InvoiceLine]) -> ValidationResult`

Status assignment logic (from 03-CONTEXT.md):
1. Check hard gate: `invoice_header.meets_hard_gate()`
2. Calculate lines_sum: `sum(line.total_amount for line in line_items) if line_items else 0.0`
3. Calculate diff: If total_amount is None → diff = None, else diff = total_amount - lines_sum
4. Assign status:
   - IF not hard_gate_passed → REVIEW
   - ELIF total_amount is None → REVIEW (cannot validate)
   - ELIF not line_items → REVIEW (cannot validate)
   - ELIF abs(diff) <= 1.0 (tolerance) → OK
   - ELSE → PARTIAL (header confident, sum mismatch)
5. Generate errors/warnings:
   - If REVIEW: Add error messages for why (hard gate failed, total None, no lines)
   - If PARTIAL: Add warning about sum mismatch with diff value

Edge cases handled (from 03-CONTEXT.md):
- invoice_number_confidence >= 0.95 but total_confidence < 0.95 → REVIEW
- total_confidence >= 0.95 but invoice_number_confidence < 0.95 → REVIEW
- no invoice_lines extracted but header OK → REVIEW (no lines = cannot validate)
- invoice_lines exist but total_amount is None → REVIEW (cannot validate without total)

Use calculate_validation_values() helper for lines_sum and diff calculation.

Return ValidationResult with all fields populated.
  </action>
  <verify>python -c "from src.pipeline.validation import validate_invoice; # Basic import test"</verify>
  <done>validate_invoice implemented with correct status assignment logic, all edge cases handled, errors/warnings generated</done>
</task>

<task type="auto">
  <name>Task 4: Write unit tests for validation</name>
  <files>tests/test_validation.py</files>
  <action>
Create comprehensive unit tests for ValidationResult model and validate_invoice() function.

Tests to write:
1. ValidationResult model:
   - Test creation with all fields
   - Test __post_init__ validation (status must be OK/PARTIAL/REVIEW, lines_sum >= 0)
   - Test default values (errors=[], warnings=[], tolerance=1.0)

2. calculate_validation_values():
   - Test with total_amount and line_items (calculates lines_sum, diff, validation_passed)
   - Test with total_amount None (returns None for diff, False for validation_passed)
   - Test with empty line_items (lines_sum = 0.0)
   - Test tolerance (diff within ±1.0 = True, diff > 1.0 = False)

3. validate_invoice() status assignment:
   - Test OK status: hard gate pass + diff <= ±1 SEK
   - Test PARTIAL status: hard gate pass + diff > ±1 SEK
   - Test REVIEW status: hard gate fail (low confidence)
   - Test REVIEW status: total_amount None (cannot validate)
   - Test REVIEW status: no line_items (cannot validate)
   - Test edge cases: invoice_number confidence >= 0.95 but total < 0.95 → REVIEW
   - Test edge cases: total confidence >= 0.95 but invoice_number < 0.95 → REVIEW
   - Test errors/warnings generation (REVIEW has errors, PARTIAL has warnings)

Use pytest fixtures for InvoiceHeader and InvoiceLine objects. Mock or create minimal test objects.

Ensure tests run with `pytest tests/test_validation.py -v`.
  </action>
  <verify>pytest tests/test_validation.py -v</verify>
  <done>All validation unit tests pass, coverage >80%, all status assignment scenarios tested</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] pytest tests/test_validation.py -v passes
- [ ] mypy type checking passes for all new files
- [ ] ValidationResult model created with all required fields
- [ ] validate_invoice() assigns status correctly (OK/PARTIAL/REVIEW)
- [ ] Hard gate logic implemented (both confidences >= 0.95)
- [ ] Mathematical validation calculates lines_sum and diff correctly
- [ ] All edge cases handled (None values, empty lists, etc.)
- [ ] Errors and warnings generated appropriately
</verification>

<success_criteria>

- All tasks completed
- ValidationResult model created with proper validation
- validate_invoice() function implements status assignment logic from 03-CONTEXT.md
- Hard gates checked (both invoice number and total confidence >= 0.95)
- Mathematical validation calculates lines_sum and diff (signed difference)
- Status assignment: OK (hard gate + diff ≤ ±1 SEK), PARTIAL (hard gate + diff > ±1 SEK), REVIEW (hard gate fail)
- All edge cases handled
- Unit tests pass with >80% coverage
- No type errors or linting issues

</success_criteria>

<output>
After completion, create `.planning/phases/03-validation/03-01-SUMMARY.md`
</output>
