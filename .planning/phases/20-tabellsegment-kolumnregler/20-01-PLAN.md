---
wave: 1
depends_on:
  - "Phase 19"
files_modified:
  - "src/pipeline/invoice_line_parser.py"
  - "src/pipeline/segment_identification.py"
  - "tests/test_invoice_line_parser.py"
autonomous: true
---

# Plan 20-01 — Tabellsegment & kolumnregler

## Mål
Robust radextraktion inom tabellblocket och korrekt identifiering av nettobelopp via moms%-kolumnen.

## Must-haves
- TABLE-01: Lokalisera tabellblocket mellan rubrikraden (t.ex. “Artikelnr/ … Nettobelopp”) och slutraden “Nettobelopp exkl. moms:”.
- TABLE-02: Rader parsas inom tabellblocket rad‑för‑rad.
- TABLE-03: Nettobelopp identifieras som sista valuta‑talet efter moms% (25.00) på raden.
- TABLE-04: Alternativ regex stöds för moms% + belopp (t.ex. `\s25\.00\s<belopp>`) för att undvika felkolumn.

## Omfattning
- Inför tabellblock‑avgränsning med header/slutrad‑ankare och filtrera rader till blocket.
- Justera rad‑parsern så att nettobelopp kräver moms% (25.00/25,00) och hämtas som sista beloppet efter moms%.
- Lägg regressionstester för block‑avgränsning och kolumnregel (moms% + nettobelopp).

## Utanför scope
- Multi‑line items (Phase 21).
- Valideringsdriven om‑extraktion (Phase 22).
- OCR/AI‑policy eller GUI‑ändringar.

## Tasks (XML)
<tasks>
  <task id="20-01-1" title="Tabellblock: header/slutrad‑ankare">
    <details>
      Identifiera tabellblockets start på rader som matchar rubrikmönster
      (t.ex. "Artikelnr", "Benämning", "Nettobelopp") och slutrad som
      matchar "Nettobelopp exkl. moms". Filtrera items‑rader till detta block
      innan line‑parsern körs.
    </details>
    <requirements>TABLE-01, TABLE-02</requirements>
  </task>
  <task id="20-01-2" title="Kolumnregel: moms% + sista beloppet">
    <details>
      Uppdatera rad‑extraktionen så att nettobelopp kräver moms% (25.00/25,00)
      och väljs som sista beloppet efter moms%. Stöd alternativ regex som
      matchar "\s25\.00\s<belopp>" för att undvika felkolumn (35.1/38.9).
    </details>
    <requirements>TABLE-03, TABLE-04</requirements>
  </task>
  <task id="20-01-3" title="Tester för tabellblock och kolumnregel">
    <details>
      Lägg tester i test_invoice_line_parser för: (a) korrekt block‑avgränsning
      mellan rubrikrad och "Nettobelopp exkl. moms", (b) nettobelopp efter moms%.
    </details>
    <requirements>TABLE-01, TABLE-02, TABLE-03, TABLE-04</requirements>
  </task>
</tasks>

## Verifiering
- Tabellblock avgränsas korrekt av rubrikrad/slutrad (TABLE-01).
- Endast rader i tabellblocket parsas (TABLE-02).
- Nettobelopp kräver moms% och väljs efter moms% (TABLE-03, TABLE-04).
- Tester för tabellblock och kolumnregel passerar.

## Leverabler
- Uppdaterad tabellblock‑avgränsning och rad‑parser.
- Tester som verifierar moms%‑kolumnregler.
