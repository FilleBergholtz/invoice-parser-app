---
wave: 1
depends_on:
  - "Phase 15"
files_modified:
  - "configs/profiles/default.yaml"
  - "src/pipeline/process_pdf.py"
  - "src/pipeline/process_virtual_invoice.py"
  - "src/pipeline/detect_invoice_boundaries.py"
  - "src/pipeline/ocr_abstraction.py"
  - "tests/test_pdf_detection.py"
  - "tests/test_tokenizer.py"
autonomous: true
---

# Plan 16-01 — Text-layer routing (OCR-skip)

## Mål
Införa per‑sida routing där text‑layer används när den är “tillräcklig”, annars OCR. OCR ska endast användas som fallback och compare‑path får inte krascha på `KeyError: 4`.

## Must‑haves (från målbild)
- Per‑sida beslut: text‑layer styr routing och OCR används bara vid otillräcklig text.
- Konfigurerbara trösklar och ankare enligt OCR‑02, med default `min_text_chars=500`.
- Required anchor måste matcha `"Faktura "` (inkl. tab/regex‑variant).
- “Tillräcklig text” kräver minst ett extra ankare (t.ex. “Sida 1/2” eller “Ramirent”).
- OCR/pdfplumber‑jämförelse kraschar inte.
- Routing fungerar även för mixed‑PDF (text‑layer + bildsidor).

## Omfattning
- Implementera konfigurerbar routing per sida (text‑layer → OCR fallback).
- Säkerställa robust compare‑path utan crash.
- Testtäckning för routing‑logik och regressionstester.

## Utanför scope
- Förändringar i AI‑policy (Phase 17).
- Tabellsegmentering och valideringsdriven om‑extraktion (Phase 20/22).

## Tasks (XML)
<tasks>
  <task id="16-01-1" title="Konfigurationsnycklar för OCR‑routing">
    <details>
      Lägg till ocr_routing i standardprofil med min_text_chars (default 500),
      required_anchors som täcker "Faktura " (inkl. tab/regex), extra_anchors,
      min_word_tokens, min_text_quality, allow_quality_override,
      cache_pdfplumber_text. Behåll kompatibilitet med befintliga profiler.
    </details>
    <requirements>OCR-01, OCR-02</requirements>
  </task>
  <task id="16-01-2" title="Implementera per‑sida text‑layer check">
    <details>
      Skapa hjälpfunktion som utvärderar pdfplumber‑text per sida enligt basvillkor
      (min_text_chars + required_anchors + minst ett extra_anchors) och optional quality override.
      Returnera beslut och beslutskäl för debug.
    </details>
    <requirements>OCR-01, OCR-02, OCR-03</requirements>
  </task>
  <task id="16-01-3" title="Integrera routing i pipeline">
    <details>
      Använd per‑sida routing i process_virtual_invoice och detect_invoice_boundaries.
      I compare‑path: kör pdfplumber överallt och OCR bara för sidor som saknar
      tillräcklig text‑layer. Säkra att mixed‑PDF stöds.
    </details>
    <requirements>OCR-01, OCR-03</requirements>
  </task>
  <task id="16-01-4" title="Fixa KeyError: 4 i OCR compare‑path">
    <details>
      Byt output_type till stabil enum (Output.STRING/DICT) och/eller defensiv fallback
      om TSV‑enum saknas. Om OCR faller, fortsätt med pdfplumber‑resultat utan crash.
    </details>
    <requirements>OCR-04</requirements>
  </task>
  <task id="16-01-5" title="Tester för routing och regression">
    <details>
      Lägg tester för routing‑logik (tillräcklig text, ankare, quality override) och
      regression för compare_extraction utan crash. Kör relevanta befintliga tester.
    </details>
    <requirements>OCR-01, OCR-02, OCR-03, OCR-04</requirements>
  </task>
</tasks>

## Verifiering
- Enhetstest: sida med text >= min_text_chars + required_anchors + extra_anchors → OCR skip.
- Enhetstest: “tillräcklig text” kräver required_anchors (Faktura + tab/regex) och minst ett extra ankare.
- Enhetstest: sida utan ankare men hög text_quality + min_word_tokens → OCR skip om override är på.
- Enhetstest: sida med låg text_quality → OCR används.
- Integration: mixed‑PDF där bara bildsidor OCR:as.
- Regression: compare_extraction kraschar inte vid OCR fallback (KeyError: 4).
- Integration: sidor med tillräcklig text‑layer ger stabilt resultat (identiskt/konsekvent utfall utan OCR).

## Leverabler
- Uppdaterad standardprofil med ocr_routing‑nycklar.
- Per‑sida routing implementerad i pipeline.
- Stabil OCR compare‑path utan crash.
- Tester som täcker OCR‑01..OCR‑04.
