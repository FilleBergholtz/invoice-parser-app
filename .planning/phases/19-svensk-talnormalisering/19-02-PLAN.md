---
wave: 1
depends_on:
  - "Phase 19"
files_modified:
  - "src/pipeline/invoice_line_parser.py"
  - "src/pipeline/validation.py"
  - "src/models/invoice_line.py"
  - "src/models/validation_result.py"
  - "tests/test_invoice_line_parser.py"
  - "tests/test_validation.py"
autonomous: true
gap_closure: true
---

# Plan 19-02 — Decimal ut i pipeline (gap-closure)

## Mål
Stäng gapet för NUM-01: belopp ska materialiseras som `Decimal` hela vägen ut från parsing/validering (inte castas till `float`).

## Must‑haves (från gap‑rapport)
- Line amounts, quantities och unit_price hålls som `Decimal`.
- Validering använder och returnerar `Decimal` (diff, lines_sum, total).
- Ingen implicit `float`-cast i parsing/validering.

## Omfattning
- Uppdatera parsing och validering för att behålla `Decimal`.
- Justera modeller/typer vid behov.
- Uppdatera tester så de förväntar `Decimal`.

## Utanför scope
- Ändra exportformat (Excel) utöver att den kan acceptera `Decimal`.

## Tasks (XML)
<tasks>
  <task id="19-02-1" title="Behåll Decimal i invoice_line_parser">
    <details>
      Uppdatera _parse_numeric_value/_extract_amount_from_row_text så de returnerar Decimal.
      Säkerställ att InvoiceLine-fält (quantity, unit_price, total) behåller Decimal i objektet.
    </details>
    <requirements>NUM-01</requirements>
  </task>
  <task id="19-02-2" title="Validering med Decimal hela vägen">
    <details>
      Uppdatera validation.py så lines_sum, diff och jämförelser använder Decimal utan float‑cast.
      Justera ValidationResult-modellen om typer behöver uppdateras.
    </details>
    <requirements>NUM-01</requirements>
  </task>
  <task id="19-02-3" title="Tester för Decimal-utdata">
    <details>
      Uppdatera tester så de förväntar Decimal i line parser och validation.
      Lägg ett fall där totalsumma i svensk format blir Decimal exakt.
    </details>
    <requirements>NUM-01</requirements>
  </task>
</tasks>

## Verifiering
- Parsing returnerar `Decimal` för quantity/unit_price/total.
- Validering returnerar `Decimal` för lines_sum/diff/total.
- Tester passerar utan float‑konvertering.

## Leverabler
- Decimal‑utdata i pipeline + uppdaterade tester
