---
wave: 1
depends_on:
  - "Phase 18"
files_modified:
  - "src/pipeline/number_normalizer.py"
  - "src/pipeline/invoice_line_parser.py"
  - "src/pipeline/header_extractor.py"
  - "src/pipeline/validation.py"
  - "tests/test_number_normalizer.py"
  - "tests/test_invoice_line_parser.py"
  - "tests/test_header_extractor.py"
  - "tests/test_validation.py"
autonomous: true
---

# Plan 19-01 — Svensk talnormalisering

## Mål
Alla belopp parsas konsekvent som `Decimal` via en gemensam normaliseringsfunktion med svensk notation.

## Must-haves
- NUM-01: All valutaparssning använder en gemensam normaliseringsfunktion som returnerar `Decimal`.
- NUM-02: Normalisering tar bort mellanslag som tusentalsseparator.
- NUM-03: Normalisering tar bort punkt som tusentalsseparator endast när den följs av tre siffror.
- NUM-04: Normalisering byter `,` → `.` innan `Decimal`-parsning.

## Omfattning
- Skapa gemensam normaliseringsfunktion för svensk talnotation och kontrollerad felhantering.
- Centralisera alla beloppsparsers till den gemensamma funktionen.
- Lägg testfall för svenska format, tusentalsseparatorer och negativa belopp.

## Utanför scope
- Ändringar i tabellsegmentering eller kolumnregler (Phase 20).
- Nya AI/OCR‑regler eller fallback‑logik.
- Ändringar i GUI/export‑format.

## Tasks (XML)
<tasks>
  <task id="19-01-1" title="Gemensam normaliseringsfunktion för svenska tal">
    <details>
      Implementera normalize_swedish_decimal(text) med regler:
      trimning, borttagning av mellanslag, punkt endast som tusentalsseparator
      (regex for tre siffror efter), byt kommatecken till punkt och returnera Decimal.
      Stod for negativa belopp (både "-1 234,00" och "1 234,00-") och kontrollerat fel
      vid ogiltigt format.
    </details>
    <requirements>NUM-01, NUM-02, NUM-03, NUM-04</requirements>
  </task>
  <task id="19-01-2" title="Centralisera beloppsparsing i pipeline">
    <details>
      Byt ut lokala float/Decimal‑parsers i invoice_line_parser, header_extractor
      och validation till gemensam normaliseringsfunktion. Sakerstall att alla
      valutor/belopp for line items, totalsummor och validering går via samma kodvag.
    </details>
    <requirements>NUM-01</requirements>
  </task>
  <task id="19-01-3" title="Tester for svensk talnormalisering">
    <details>
      Enhetstester for normalizer: "1 234 567,89", "12.345,67", "12.50", "12.5",
      "1.234", "1,234", "SEK 1 234,50", "-1 234,00", "1 234,00-".
      Komplettera parser/validation‑tester for att säkerställa att Decimal används
      och att ingen felaktig punktborttagning sker.
    </details>
    <requirements>NUM-01, NUM-02, NUM-03, NUM-04</requirements>
  </task>
</tasks>

## Verifiering
- Alla belopp går via gemensam normalisering och returnerar `Decimal` (NUM-01).
- Mellanslag som tusentalsseparator tas bort korrekt (NUM-02).
- Punkt tas bort endast vid tusentalsformat med tre siffror efter (NUM-03).
- Komma konverteras till punkt innan `Decimal`-parsning (NUM-04).
- Testfall for svenska format passerar.

## Leverabler
- Ny gemensam normaliseringsfunktion för svenska tal.
- Uppdaterade parsers och validering som använder funktionen.
- Nya/uppdaterade tester for talnormalisering.
