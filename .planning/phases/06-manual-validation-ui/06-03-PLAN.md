---
phase: 06-manual-validation-ui
plan: 03
type: execute
wave: 3
depends_on: ["06-02"]
files_modified: [src/ui/views/main_window.py, src/learning/correction_collector.py]
autonomous: true

must_haves:
  truths:
    - "System collects user corrections and saves them for learning"
    - "Corrections stored in JSON format for Phase 7 integration"
    - "Correction includes invoice metadata, original value, corrected value, confidence"
    - "User can confirm correction with button or keyboard shortcut"
  artifacts:
    - path: "src/learning/correction_collector.py"
      provides: "Correction collection and storage"
      exports: ["CorrectionCollector", "save_correction"]
  key_links:
    - from: "src/learning/correction_collector.py"
      to: "src/models/invoice_header.py"
      via: "Collects corrections from InvoiceHeader"
      pattern: "InvoiceHeader|total_amount|total_confidence"
    - from: "src/ui/views/main_window.py"
      to: "src/learning/correction_collector.py"
      via: "Saves corrections when user validates"
      pattern: "CorrectionCollector|save_correction"
---

<objective>
Implement correction collection system that saves user corrections to JSON file for learning system integration.

Purpose: When user selects correct candidate, save correction with invoice metadata, original/corrected values, and confidence scores. Store in JSON format for Phase 7 learning system to consume.

Output: CorrectionCollector module, integration with validation UI, correction storage.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-manual-validation-ui/06-CONTEXT.md
@src/models/invoice_header.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create correction collector module</name>
  <files>src/learning/correction_collector.py</files>
  <action>
Create correction collector module `src/learning/correction_collector.py` for saving user corrections.

**Dependencies:**
- Create `src/learning/` directory and `__init__.py` if not exists
- JSON for storage (standard library)

**Classes/Functions to implement:**

1. `CorrectionCollector` class:
   - Manages correction storage
   - Methods:
     - `save_correction(correction: Dict) -> None`: Save single correction
     - `get_corrections() -> List[Dict]`: Get all corrections
     - `clear_corrections() -> None`: Clear all corrections (optional)

2. `save_correction(invoice_id: str, invoice_header: InvoiceHeader, selected_amount: float, selected_index: int) -> Dict`:
   - Create correction dict with:
     - `invoice_id`: Invoice identifier (filename or hash)
     - `supplier_name`: From InvoiceHeader.supplier_name
     - `original_total`: InvoiceHeader.total_amount
     - `original_confidence`: InvoiceHeader.total_confidence
     - `corrected_total`: selected_amount
     - `corrected_confidence`: From candidate score
     - `raw_confidence`: Original raw score (before calibration, if available)
     - `candidate_index`: Selected candidate index
     - `timestamp`: ISO timestamp
     - `correction_type`: "total_amount" (for future extensibility)
   - Save to JSON file: `data/corrections.json` (append mode)
   - Return correction dict

**Storage Format:**
- JSON file: `data/corrections.json`
- Array of correction objects
- Append new corrections (don't overwrite)
- Create data/ directory if not exists

**Error Handling:**
- Handle file I/O errors gracefully
- Validate correction data before saving
- Log errors but don't fail validation workflow

Add type hints and docstrings.
  </action>
  <verify>python -c "from src.learning.correction_collector import CorrectionCollector, save_correction; print('Module imported successfully')"</verify>
  <done>CorrectionCollector module created with save_correction function and JSON storage</done>
</task>

<task type="auto">
  <name>Task 2: Integrate correction collection into validation UI</name>
  <files>src/ui/views/main_window.py</files>
  <action>
Integrate correction collection into main window validation workflow.

**Update MainWindow:**
- Add "Confirm" or "Save Correction" button in validation UI
- Connect candidate selection to correction saving
- Show confirmation message after correction saved

**Workflow:**
1. User selects candidate (via PDF click or selector)
2. User clicks "Confirm" button (or presses Enter in selector)
3. Save correction using `save_correction()`
4. Show success message
5. Optionally: Mark invoice as validated, move to next

**UI Elements:**
- "Confirm Selection" button (enabled when candidate selected)
- Status message: "Correction saved" or "No correction needed"
- Optional: "Skip" button to move to next invoice without correction

**Integration:**
- Call `save_correction()` when user confirms selection
- Pass InvoiceHeader and selected candidate data
- Handle save errors gracefully (show error message)

**State Management:**
- Track if correction has been saved for current invoice
- Prevent duplicate saves
- Update UI state after save

Update imports and ensure correction collection works seamlessly with validation workflow.
  </action>
  <verify>python -c "from src.ui.views.main_window import MainWindow; print('MainWindow integrates correction collection')"</verify>
  <done>Correction collection integrated into validation UI, corrections saved when user confirms selection</done>
</task>

</tasks>
