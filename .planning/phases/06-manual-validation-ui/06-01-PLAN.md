---
phase: 06-manual-validation-ui
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [src/ui/views/pdf_viewer.py, src/ui/views/main_window.py]
autonomous: true

must_haves:
  truths:
    - "User can view PDF in clickable viewer component"
    - "System detects clicks on total amount candidates in PDF"
    - "System maps click coordinates to PDF page coordinates"
    - "System identifies which candidate (if any) was clicked"
  artifacts:
    - path: "src/ui/views/pdf_viewer.py"
      provides: "Clickable PDF viewer with candidate detection"
      exports: ["PDFViewer"]
  key_links:
    - from: "src/ui/views/pdf_viewer.py"
      to: "src/models/invoice_header.py"
      via: "Uses InvoiceHeader.total_candidates for candidate detection"
      pattern: "InvoiceHeader|total_candidates"
    - from: "src/ui/views/pdf_viewer.py"
      to: "src/models/traceability.py"
      via: "Uses Traceability.evidence.bbox for candidate highlighting"
      pattern: "Traceability|evidence|bbox"
---

<objective>
Create clickable PDF viewer component that can detect clicks on total amount candidates and highlight them visually.

Purpose: Build PDF viewer using PySide6 QGraphicsView with PyMuPDF rendering. Support click detection on candidate bounding boxes from InvoiceHeader.total_candidates. Visual highlighting of candidates.

Output: PDFViewer component with click detection and highlighting.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-manual-validation-ui/06-CONTEXT.md
@.planning/research/ARCHITECTURE.md
@src/ui/views/main_window.py
@src/models/invoice_header.py
@src/models/traceability.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create PDF viewer component with PyMuPDF</name>
  <files>src/ui/views/pdf_viewer.py</files>
  <action>
Create new PDF viewer component `src/ui/views/pdf_viewer.py` using PySide6 QGraphicsView and PyMuPDF.

**Dependencies:**
- PySide6 (already in dependencies)
- PyMuPDF (fitz) - add to pyproject.toml if not present: `pymupdf>=1.23.0`

**Class to implement:**

`PDFViewer(QGraphicsView)`:
- Inherits from QGraphicsView
- Renders PDF pages using PyMuPDF
- Supports click detection on PDF coordinates
- Highlights candidate bounding boxes

**Methods:**
- `load_pdf(path: str) -> None`: Load PDF file and render first page
- `set_candidates(candidates: List[Dict], traceability: Optional[Traceability]) -> None`: Set candidate list and traceability for highlighting
- `mousePressEvent(event: QMouseEvent) -> None`: Detect clicks and check if within candidate bbox
- `highlight_candidate(candidate_index: int) -> None`: Highlight selected candidate in PDF

**PDF Rendering:**
- Use PyMuPDF to render PDF page to QPixmap
- Add QPixmap to QGraphicsScene as QGraphicsPixmapItem
- Scale to fit viewport while maintaining aspect ratio

**Click Detection:**
- Convert mouse click coordinates to PDF page coordinates
- Check if click is within any candidate's bounding box (from traceability evidence)
- Emit signal when candidate clicked: `candidate_clicked = Signal(int)` (candidate index)

**Visual Highlighting:**
- Add QGraphicsRectItem for each candidate bounding box
- Use different colors: selected (blue), others (yellow/transparent)
- Update highlighting when candidate selected

**Coordinate Mapping:**
- Map viewport coordinates to PDF page coordinates
- Account for scaling and translation
- Use traceability evidence bbox: [x, y, width, height] in PDF coordinates

Add type hints and docstrings. Use PySide6 signals for communication.
  </action>
  <verify>python -c "from src.ui.views.pdf_viewer import PDFViewer; print('PDFViewer imported successfully')"</verify>
  <done>PDFViewer component created with PyMuPDF rendering, click detection, and candidate highlighting</done>
</task>

<task type="auto">
  <name>Task 2: Integrate PDF viewer into main window</name>
  <files>src/ui/views/main_window.py</files>
  <action>
Integrate PDF viewer into main window for validation workflow.

**Update MainWindow:**
- Add PDF viewer widget (after processing completes)
- Show PDF viewer when invoice has REVIEW status or low confidence
- Connect PDF viewer signals to candidate selector (next plan)

**UI Layout:**
- Add validation section/tab after processing
- Show PDF viewer on left/center
- Reserve space for candidate selector (right side, next plan)

**Integration Points:**
- After `handle_result()` - check if invoice needs validation
- Load PDF from input_path
- Set candidates from `InvoiceHeader.total_candidates` (if available from processing result)
- Show PDF viewer with candidates highlighted

**State Management:**
- Store processing result (InvoiceHeader, etc.) for validation
- Track current invoice being validated
- Enable validation mode when confidence < 0.95

**Error Handling:**
- Handle PDF loading errors gracefully
- Show message if PDF not found
- Handle missing candidates (fallback to showing extracted total only)

Update imports and ensure PDF viewer is optional (only shown when needed).
  </action>
  <verify>python -c "from src.ui.views.main_window import MainWindow; print('MainWindow imports PDFViewer')"</verify>
  <done>PDF viewer integrated into main window, shown when validation needed</done>
</task>

</tasks>
