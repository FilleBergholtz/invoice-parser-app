---
phase: 14-extraction-fallback-optimization-pdfplumber-ocr-ai-vision
plan: 04
type: execute
wave: 2
depends_on: ["14-01"]
files_modified: [src/pipeline/pdf_renderer.py]
autonomous: true

must_haves:
  truths:
    - "Baseline render uses 300 DPI; optional DPI parameter allows 400 for retry"
    - "R1: Retry at 400 DPI only when ocr_mean_conf < 55 after 300 DPI, max 1 retry per page"
    - "pdf_renderer exposes DPI in signature or behaviour so orchestration can request 300 or 400"
  artifacts:
    - path: "src/pipeline/pdf_renderer.py"
      provides: "render_page_to_image(page, output_dir, dpi=300)"
  key_links:
    - from: "orchestration"
      to: "pdf_renderer"
      via: "Call with dpi=400 when mean_conf < OCR_MEAN_CONF_RETRY_THRESHOLD (55)"
---

<objective>
Ensure rendering supports 300 DPI baseline and optional 400 DPI retry. Per 14-RESEARCH R1: BASELINE_DPI=300, RETRY_DPI=400, retry only if ocr_mean_conf < 55 after first OCR, max 1 retry per page. Orchestration (14-06) will decide when to retry; this plan adds the capability (e.g. dpi parameter to render_page_to_image).
</objective>

<execution_context>
@.planning/phases/14-extraction-fallback-optimization-pdfplumber-ocr-ai-vision/14-RESEARCH.md
@.planning/phases/14-extraction-fallback-optimization-pdfplumber-ocr-ai-vision/14-CONTEXT.md
</execution_context>

<context>
@.planning/phases/14-extraction-fallback-optimization-pdfplumber-ocr-ai-vision/14-RESEARCH.md
@src/pipeline/pdf_renderer.py
</context>

<tasks>

<task type="auto">
  <name>Add optional dpi parameter to render_page_to_image</name>
  <files>src/pipeline/pdf_renderer.py</files>
  <action>
Add parameter `dpi: int = 300` to render_page_to_image(page, output_dir, dpi=300). Use it when building the zoom matrix: zoom = dpi / 72.0. Keep default 300 so existing callers are unchanged. Document that 400 is used for OCR retry when mean_conf is low (R1).
</action>
</task>

<task type="auto">
  <name>Document R1 constants for callers</name>
  <files>src/pipeline/pdf_renderer.py or config/constants</files>
  <action>
Either in pdf_renderer or in a shared constants module used by orchestration, document/default the R1 values: BASELINE_DPI=300, RETRY_DPI=400, OCR_MEAN_CONF_RETRY_THRESHOLD=55, MAX_DPI_RETRIES_PER_PAGE=1. Orchestration will use these to decide when to call render(..., dpi=400). This plan only makes the renderer capable of 400 DPI; actual retry logic is in 14-06.
</action>
</task>

</tasks>

<verification>
- render_page_to_image(page, output_dir, dpi=300) preserves current behaviour.
- render_page_to_image(page, output_dir, dpi=400) produces a higher-resolution image.
- R1 constants are documented or defined where orchestration can use them.
</verification>
