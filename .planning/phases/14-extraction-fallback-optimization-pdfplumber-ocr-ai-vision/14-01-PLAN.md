---
phase: 14-extraction-fallback-optimization-pdfplumber-ocr-ai-vision
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [src/models/token.py, src/pipeline/ocr_abstraction.py]
autonomous: true

must_haves:
  truths:
    - "Token has optional confidence (float 0..1 or None); OCR populates it from Tesseract TSV conf"
    - "TSV rows with conf < 0 are excluded from word tokens; only conf >= 0 (level 5 words) are used"
    - "OCR abstraction computes mean_conf, median_conf, low_conf_fraction (excl. conf < 0) for routing"
  artifacts:
    - path: "src/models/token.py"
      provides: "Token with optional confidence field"
    - path: "src/pipeline/ocr_abstraction.py"
      provides: "OCR tokens with confidence; aggregation for mean/median/low_conf_fraction"
  key_links:
    - from: "ocr_abstraction"
      to: "Token"
      via: "Token(..., confidence=...) when conf >= 0"
---

<objective>
Add optional confidence to Token and persist OCR word confidence from Tesseract TSV. Exclude conf == -1 (layout rows) from tokens; compute per-page OCR metrics (mean_conf, median_conf, low_conf_fraction) for routing. Document mean vs median: "Mean is used for DPI retry sensitivity, median for routing robustness." (14-RESEARCH Recommendation B)
</objective>

<execution_context>
@.planning/phases/14-extraction-fallback-optimization-pdfplumber-ocr-ai-vision/14-CONTEXT.md
@.planning/phases/14-extraction-fallback-optimization-pdfplumber-ocr-ai-vision/14-RESEARCH.md
</execution_context>

<context>
@.planning/phases/14-extraction-fallback-optimization-pdfplumber-ocr-ai-vision/14-CONTEXT.md
@.planning/phases/14-extraction-fallback-optimization-pdfplumber-ocr-ai-vision/14-RESEARCH.md
@src/models/token.py
@src/pipeline/ocr_abstraction.py
</context>

<tasks>

<task type="auto">
  <name>Add Optional[float] confidence to Token</name>
  <files>src/models/token.py</files>
  <action>
Add attribute `confidence: Optional[float] = None` to Token. Normalize TSV conf (0–100) to 0..1 when storing if desired, or keep 0–100 and document; 14-RESEARCH uses raw-like values for thresholds (e.g. 55, 70). Recommend storing 0–100 for OCR to match Tesseract, or 0.0–1.0 for consistency with rest of app — CONTEXT says "persist OCR confidence". If any serialization or tests assert on Token fields, update them to allow confidence.
</action>
</task>

<task type="auto">
  <name>Persist OCR conf into Token and exclude conf &lt; 0</name>
  <files>src/pipeline/ocr_abstraction.py</files>
  <action>
In TesseractOCREngine.extract_tokens:
1. After parsing conf from TSV, skip rows where conf < 0 (or level != 5 if level column is used). Do not create Token for those rows.
2. When creating Token, pass confidence. Use conf/100.0 if Token uses 0..1, else pass float(conf) if Token keeps 0–100.
3. Add a short comment: "Mean is used for DPI retry sensitivity, median for routing robustness." near where conf is read or aggregated.
</action>
</task>

<task type="auto">
  <name>Add OCR confidence aggregation helpers</name>
  <files>src/pipeline/ocr_abstraction.py</files>
  <action>
Add functions or methods that compute per-page OCR metrics from a list of Tokens that have confidence set:
- mean_conf: mean of token.confidence for tokens where confidence is not None and >= 0.
- median_conf: median of those values.
- low_conf_fraction: fraction of such tokens with confidence < 50 (or < 0.5 if using 0..1 scale). Use 50 when confidence is 0–100.

Return a small dataclass or dict with mean_conf, median_conf, low_conf_fraction. Expose for use by routing/orchestration (plan 14-06). Constants from 14-RESEARCH: OCR_EXCLUDE_CONF_BELOW=0, OCR_MEDIAN_CONF_ROUTING_THRESHOLD=70, OCR_LOW_CONF_FRACTION_THRESHOLD=0.25.
</action>
</task>

</tasks>

<verification>
- Token has confidence attribute; OCR path sets it for word rows (conf >= 0).
- No tokens are created for conf < 0.
- mean_conf, median_conf, low_conf_fraction are computable from OCR tokens and match 14-RESEARCH semantics.
</verification>
