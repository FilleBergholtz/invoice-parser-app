---
phase: 14-extraction-fallback-optimization-pdfplumber-ocr-ai-vision
plan: 02
type: execute
wave: 1
depends_on: []
files_modified: [src/pipeline/tokenizer.py]
autonomous: true

must_haves:
  truths:
    - "pdfplumber extract_words uses use_text_flow=True for reading order"
    - "extra_attrs=['fontname','size'] is supported with safe fallback if edge cases occur"
    - "Token ordering uses line clustering rather than raw (y,x) sort to avoid mixing lines"
  artifacts:
    - path: "src/pipeline/tokenizer.py"
      provides: "extract_tokens_from_page with improved ordering and optional extra_attrs"
  key_links:
    - from: "tokenizer"
      to: "pdfplumber"
      via: "extract_words(..., use_text_flow=True, extra_attrs=...)"
---

<objective>
Improve pdfplumber tokenizer: use_text_flow=True, optional extra_attrs=["fontname","size"] with safe fallback, and better reading order via line clustering. Per 14-CONTEXT ยง3 and 14-DISCUSS implementation task 2.
</objective>

<execution_context>
@.planning/phases/14-extraction-fallback-optimization-pdfplumber-ocr-ai-vision/14-CONTEXT.md
@.planning/phases/14-extraction-fallback-optimization-pdfplumber-ocr-ai-vision/14-DISCUSS.md
</execution_context>

<context>
@.planning/phases/14-extraction-fallback-optimization-pdfplumber-ocr-ai-vision/14-CONTEXT.md
@src/pipeline/tokenizer.py
</context>

<tasks>

<task type="auto">
  <name>Enable use_text_flow=True in extract_words</name>
  <files>src/pipeline/tokenizer.py</files>
  <action>
In extract_tokens_from_page, when calling pdfplumber's extract_words (or equivalent), pass use_text_flow=True if the API supports it, to improve reading order for multi-column or complex layouts. If the current code uses a different method, add use_text_flow=True to the relevant call or document why it is not used.
</action>
</task>

<task type="auto">
  <name>Add extra_attrs with safe fallback</name>
  <files>src/pipeline/tokenizer.py</files>
  <action>
Support extra_attrs=["fontname","size"] for extract_words behind a safe implementation: try/except or capability check, and fall back to current behavior if pdfplumber raises or returns unusable data. 14-DISCUSS notes edge cases/bugs with extra_attrs; do not break extraction when they occur. Optional: feature flag or parameter to enable extra_attrs.
</action>
</task>

<task type="auto">
  <name>Improve ordering via line clustering</name>
  <files>src/pipeline/tokenizer.py</files>
  <action>
Replace or augment simple (y, x) sort with line-based grouping: cluster tokens by similar y (within a line threshold), then sort lines by y and tokens within each line by x. This avoids mixing lines when spacing is uneven. Use existing page dimensions or token heights to derive a reasonable line threshold if needed.
</action>
</task>

</tasks>

<verification>
- extract_words uses use_text_flow=True where applicable.
- extra_attrs can be enabled without breaking extraction on problematic PDFs.
- Token order follows reading order (top-to-bottom, left-to-right) via line clustering.
</verification>
