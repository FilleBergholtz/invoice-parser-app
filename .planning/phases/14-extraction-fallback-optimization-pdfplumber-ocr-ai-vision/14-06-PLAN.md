---
phase: 14-extraction-fallback-optimization-pdfplumber-ocr-ai-vision
plan: 06
type: execute
wave: 4
depends_on: ["14-01", "14-02", "14-03", "14-04", "14-05"]
files_modified: [src/cli/main.py, run_summary / engine output]
autonomous: false

must_haves:
  truths:
    - "Per-page routing: pdfplumber → OCR → AI text → AI vision; only necessary pages are rendered/OCR'd/AI'd"
    - "run_summary.json includes per-page method_used, confidences, text_quality, artifact paths, and vision_reason when method_used is ai_vision"
    - "Routing uses TEXT_QUALITY_THRESHOLD=0.5, OCR_MEDIAN_CONF_ROUTING_THRESHOLD=70, CRITICAL_FIELDS_CONF_THRESHOLD=0.95"
  artifacts:
    - path: "run_summary.json (extended)"
      provides: "Per-page method_used, vision_reason, confidences, text quality, artifact paths"
  key_links:
    - from: "CLI / engine"
      to: "orchestration"
      via: "Page-level extraction with fallback chain"
---

<objective>
Implement page-level orchestration: run pdfplumber first; if critical_fields_conf >= 0.95 and text_quality >= threshold, accept. Else run OCR for needed pages; if ocr metrics and conf above thresholds, accept. Else AI text-only if text_quality >= 0.5; else AI vision. Only render/OCR/AI pages that need fallback. Write per-page decisions to run_summary.json including vision_reason when method_used is ai_vision (Recommendation A). Per 14-CONTEXT §1, §5, §7 and 14-RESEARCH R4.
</objective>

<execution_context>
@.planning/phases/14-extraction-fallback-optimization-pdfplumber-ocr-ai-vision/14-CONTEXT.md
@.planning/phases/14-extraction-fallback-optimization-pdfplumber-ocr-ai-vision/14-RESEARCH.md
@.planning/phases/14-extraction-fallback-optimization-pdfplumber-ocr-ai-vision/14-DISCUSS.md
</execution_context>

<context>
@.planning/phases/14-extraction-fallback-optimization-pdfplumber-ocr-ai-vision/14-CONTEXT.md
@.planning/phases/14-extraction-fallback-optimization-pdfplumber-ocr-ai-vision/14-RESEARCH.md
@src/cli/main.py
</context>

<tasks>

<task type="auto">
  <name>Implement page-level fallback orchestration</name>
  <files>src/cli/main.py and/or new pipeline module (e.g. orchestration or extraction_router)</files>
  <action>
Implement the routing table from 14-RESEARCH R4:
1) pdfplumber → parse → if critical_fields_conf >= 0.95 and pdf_text_quality >= TEXT_QUALITY_THRESHOLD (0.5), accept.
2) Else run OCR for this page (render at 300 DPI; if mean_conf < 55, retry render at 400 DPI once). Parse OCR → if critical_fields_conf >= 0.95 and ocr_quality ok (median_conf >= 70, ocr_text_quality >= 0.5), accept.
3) Else if best text_quality >= 0.5, use AI text-only (max 1 retry on invalid JSON).
4) Else use AI vision (image + text), max 1 retry. If vision not allowed (config or limits), keep text-only result or REVIEW.

Use 14-01 aggregation (mean_conf, median_conf, low_conf_fraction), 14-03 (score_text_quality, score_ocr_quality), 14-04 (render with dpi=300 or 400), 14-05 (AI text + vision + retry). Only render/OCR when step 1 does not accept; only call AI when step 2 does not accept.
</action>
</task>

<task type="auto">
  <name>Extend run_summary.json with per-page routing and vision_reason</name>
  <files>Wherever run_summary is produced (e.g. cli/main, batch runner, engine)</files>
  <action>
For each page (or virtual invoice segment), write: method_used (pdfplumber | ocr | ai_text | ai_vision), confidence values (field_confidence, pdf_text_quality, ocr_text_quality, ocr_mean_conf / median_conf), text quality scores, artifact paths (rendered_image_path if created, ocr_tsv_path, ai request/response paths). When method_used is ai_vision, add vision_reason: list of threshold conditions that led to vision (e.g. ["pdf_text_quality < 0.5", "ocr_median_conf < 70"]). Per Recommendation A in 14-CONTEXT and 14-RESEARCH.
</action>
</task>

<task type="auto">
  <name>Write artifacts under output_dir/artifacts/</name>
  <files>Pipeline or CLI</files>
  <action>
Store intermediate artifacts under output_dir/artifacts/: pages/page_0001.png, ocr/page_0001.tsv (if OCR ran), ai/page_0001_request.json and response.json (if AI ran). Paths can be recorded in run_summary for traceability. Create subdirs on demand.
</action>
</task>

</tasks>

<verification>
- Pipeline selects minimal method per page (pdfplumber when sufficient, then OCR, then AI text, then vision).
- run_summary.json includes per-page method_used, confidences, text quality, artifact paths, and vision_reason when ai_vision.
- Architecture remains subprocess + file-based; no new services.
</verification>
