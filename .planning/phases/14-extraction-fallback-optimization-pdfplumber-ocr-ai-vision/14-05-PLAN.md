---
phase: 14-extraction-fallback-optimization-pdfplumber-ocr-ai-vision
plan: 05
type: execute
wave: 3
depends_on: []
files_modified: [src/ai/providers.py, src/ai/fallback.py]
autonomous: true

must_haves:
  truths:
    - "AI providers support vision input: image path or bytes, PNG/JPEG, max 4096 px longest side, 20 MB"
    - "Vision is used only when text quality is too poor for text-only (R4); one image per request"
    - "On invalid JSON/schema from AI: max 1 retry with stricter schema instruction"
  artifacts:
    - path: "src/ai/providers.py"
      provides: "extract_total_amount with optional image input; retry on invalid JSON"
  key_links:
    - from: "orchestration"
      to: "src/ai"
      via: "Call vision path when routing selects ai_vision"
---

<objective>
Extend AI layer to support vision-based extraction: accept image (path or bytes), enforce R3 limits (PNG/JPEG, max 4096 px longest side, 20 MB, one image per request). Add retry: on invalid JSON/schema, perform 1 retry with stricter instruction. Per 14-RESEARCH R3 and R4.
</objective>

<execution_context>
@.planning/phases/14-extraction-fallback-optimization-pdfplumber-ocr-ai-vision/14-RESEARCH.md
@.planning/phases/14-extraction-fallback-optimization-pdfplumber-ocr-ai-vision/14-CONTEXT.md
</execution_context>

<context>
@.planning/phases/14-extraction-fallback-optimization-pdfplumber-ocr-ai-vision/14-RESEARCH.md
@.planning/phases/14-extraction-fallback-optimization-pdfplumber-ocr-ai-vision/14-CONTEXT.md
@src/ai/providers.py
@src/ai/fallback.py
</context>

<tasks>

<task type="auto">
  <name>Add vision overload or parameter to extract_total_amount</name>
  <files>src/ai/providers.py</files>
  <action>
Extend AIProvider.extract_total_amount (and OpenAI/Claude implementations) to accept an optional image input: e.g. image_path: Optional[str] = None or image_bytes: Optional[bytes] = None with mime type. When provided, call the provider's vision API (e.g. GPT-4o/vision, Claude with image block). Use same response shape (total_amount, confidence, reasoning, validation_passed). Enforce R3: PNG/JPEG, max 4096 px on longest side, max 20 MB; scale or reject if oversized.
</action>
</task>

<task type="auto">
  <name>Implement 1-retry on invalid JSON</name>
  <files>src/ai/providers.py, src/ai/fallback.py</files>
  <action>
When AI returns a response that fails validate_response or schema/JSON parsing, retry once with a stricter prompt (e.g. "Return only valid JSON matching the schema; no additional text."). After the retry, either return the parsed result or propagate failure. Per R4: AI_JSON_RETRY_COUNT = 1. Apply to both text-only and vision call paths.
</action>
</task>

<task type="auto">
  <name>Wire vision and retry in fallback entrypoint</name>
  <files>src/ai/fallback.py</files>
  <action>
Ensure the fallback code path that calls AI can pass an image when the caller has chosen vision mode, and that the single retry on invalid JSON is applied. Orchestration (14-06) will decide when to pass an image; this plan only makes the AI layer accept it and enforce limits + retry.
</action>
</task>

</tasks>

<verification>
- extract_total_amount can be called with an image (path or bytes); vision API is used and response shape is unchanged.
- Response validation/parsing triggers at most one retry with stricter instructions; then success or failure.
- R3 limits (4096 px, 20 MB, PNG/JPEG) are enforced before sending to the API.
</verification>
