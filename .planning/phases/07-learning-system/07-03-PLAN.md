---
phase: 07-learning-system
plan: 03
type: execute
wave: 3
depends_on: ["07-02"]
files_modified: [src/learning/pattern_consolidator.py, src/learning/database.py, src/cli/main.py]
autonomous: true

must_haves:
  truths:
    - "System consolidates similar patterns to prevent database bloat"
    - "System performs regular cleanup of old or conflicting patterns"
    - "CLI command available for consolidation and cleanup"
  artifacts:
    - path: "src/learning/pattern_consolidator.py"
      provides: "Pattern consolidation and cleanup"
      exports: ["consolidate_patterns", "cleanup_patterns", "PatternConsolidator"]
  key_links:
    - from: "src/learning/pattern_consolidator.py"
      to: "src/learning/database.py"
      via: "Queries and updates patterns in database"
      pattern: "LearningDatabase|get_patterns|save_pattern"
    - from: "src/cli/main.py"
      to: "src/learning/pattern_consolidator.py"
      via: "CLI command for consolidation and cleanup"
      pattern: "PatternConsolidator|consolidate_patterns|cleanup_patterns"
---

<objective>
Implement pattern consolidation and cleanup system to prevent database bloat and remove old/conflicting patterns.

Purpose: Build consolidation logic that merges similar patterns (same supplier, similar layout/position), cleanup logic that removes old/unused patterns, and CLI command for running consolidation/cleanup.

Output: PatternConsolidator class, consolidation/cleanup functions, CLI integration.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-learning-system/07-CONTEXT.md
@src/learning/database.py
@src/cli/main.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create pattern consolidator</name>
  <files>src/learning/pattern_consolidator.py</files>
  <action>
Create pattern consolidation and cleanup module `src/learning/pattern_consolidator.py`.

**Dependencies:**
- LearningDatabase for querying and updating patterns
- datetime for age calculations

**Classes/Functions to implement:**

1. `PatternConsolidator` class:
   - Methods:
     - `__init__(database: LearningDatabase) -> None`: Initialize with database
     - `consolidate_patterns(supplier: Optional[str] = None, similarity_threshold: float = 0.8) -> int`:
       - Find similar patterns (same supplier, similar layout/position)
       - Merge patterns: keep pattern with highest usage_count, sum usage_counts, update last_used
       - Delete merged patterns
       - Return count of patterns consolidated
     - `cleanup_patterns(max_age_days: int = 90, min_usage_count: int = 1) -> int`:
       - Remove patterns not used in max_age_days
       - Remove patterns with usage_count < min_usage_count
       - Return count of patterns removed
     - `remove_conflicting_patterns(supplier: Optional[str] = None) -> int`:
       - Find conflicting patterns (same supplier, same layout/position, different correct_total)
       - Keep pattern with highest usage_count or confidence_boost
       - Remove conflicting patterns
       - Return count of patterns removed

2. `consolidate_patterns(database: LearningDatabase, supplier: Optional[str] = None) -> int`:
   - Convenience function that creates PatternConsolidator and calls consolidate_patterns

3. `cleanup_patterns(database: LearningDatabase, max_age_days: int = 90) -> int`:
   - Convenience function that creates PatternConsolidator and calls cleanup_patterns

**Consolidation Logic:**
- Group patterns by supplier
- For each supplier, find patterns with:
  - Same layout_hash (exact match)
  - Similar position (within 50 points distance)
- Merge: Keep pattern with highest usage_count, sum all usage_counts, use latest last_used
- Delete merged patterns (keep only the consolidated one)

**Cleanup Logic:**
- Age-based: Remove patterns where last_used is older than max_age_days
- Usage-based: Remove patterns with usage_count < min_usage_count
- Conflicting: Remove patterns with same supplier+layout+position but different correct_total (keep best one)

**Error Handling:**
- Handle database errors gracefully
- Log consolidation/cleanup actions
- Return counts for reporting

Add type hints and docstrings.
  </action>
  <verify>python -c "from src.learning.pattern_consolidator import PatternConsolidator, consolidate_patterns, cleanup_patterns; print('Pattern consolidator imported successfully')"</verify>
  <done>Pattern consolidator created with consolidation, cleanup, and conflict resolution</done>
</task>

<task type="auto">
  <name>Task 2: Add CLI commands for consolidation and cleanup</name>
  <files>src/cli/main.py</files>
  <action>
Add CLI commands for pattern consolidation and cleanup.

**New Arguments:**
- `--consolidate-patterns`: Run pattern consolidation
- `--cleanup-patterns`: Run pattern cleanup
- `--max-age-days` (optional, default 90): Maximum age for cleanup
- `--supplier` (optional): Limit consolidation/cleanup to specific supplier

**Implementation:**
- Add argument parsing for new flags
- Create handler function `_handle_pattern_maintenance()`:
  - If `--consolidate-patterns`: Run consolidation, report count
  - If `--cleanup-patterns`: Run cleanup, report count
  - Can run both in sequence
- Show summary: "Consolidated X patterns", "Removed Y patterns"

**Integration:**
- Make `--input` optional when using pattern maintenance commands
- Initialize LearningDatabase
- Call consolidation/cleanup functions
- Print results

**Error Handling:**
- Handle database errors gracefully
- Show error messages if consolidation/cleanup fails
- Continue execution even if errors occur

Update imports and ensure commands work independently of invoice processing.
  </action>
  <verify>python -c "from src.cli.main import main; print('CLI imports pattern maintenance')"</verify>
  <done>CLI commands added for pattern consolidation and cleanup</done>
</task>

</tasks>
