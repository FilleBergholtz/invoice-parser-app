---
phase: 07-learning-system
plan: 02
type: execute
wave: 2
depends_on: ["07-01"]
files_modified: [src/learning/pattern_matcher.py, src/pipeline/footer_extractor.py]
autonomous: true

must_haves:
  truths:
    - "System matches new invoices to learned patterns (supplier-specific matching only)"
    - "System uses learned patterns to improve confidence scoring for similar invoices"
    - "Pattern matching is supplier-specific (no cross-supplier matching)"
    - "Confidence boost applied when pattern matches"
  artifacts:
    - path: "src/learning/pattern_matcher.py"
      provides: "Pattern matching for new invoices"
      exports: ["match_patterns", "PatternMatcher"]
  key_links:
    - from: "src/learning/pattern_matcher.py"
      to: "src/learning/database.py"
      via: "Queries patterns from LearningDatabase"
      pattern: "LearningDatabase|get_patterns"
    - from: "src/pipeline/footer_extractor.py"
      to: "src/learning/pattern_matcher.py"
      via: "Uses pattern matching to boost confidence scores"
      pattern: "PatternMatcher|match_patterns"
---

<objective>
Implement pattern matching system that matches new invoices to learned patterns and boosts confidence scores when patterns match.

Purpose: Build pattern matcher that queries patterns from database, matches against new invoice (supplier-specific), calculates similarity, and applies confidence boost to candidates when pattern matches.

Output: PatternMatcher class, integration with footer extractor for confidence boosting.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-learning-system/07-CONTEXT.md
@src/learning/database.py
@src/pipeline/footer_extractor.py
@src/pipeline/confidence_scoring.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create pattern matcher</name>
  <files>src/learning/pattern_matcher.py</files>
  <action>
Create pattern matching module `src/learning/pattern_matcher.py`.

**Dependencies:**
- LearningDatabase for querying patterns
- hashlib for layout hash calculation

**Classes/Functions to implement:**

1. `PatternMatcher` class:
   - Methods:
     - `__init__(database: LearningDatabase) -> None`: Initialize with database
     - `match_patterns(supplier_name: str, layout_hash: Optional[str] = None, position: Optional[Dict] = None) -> List[Dict]`:
       - Query patterns for supplier (supplier-specific only)
       - Calculate similarity scores for each pattern
       - Return matched patterns sorted by similarity (highest first)
     - `calculate_similarity(pattern: Dict, layout_hash: Optional[str], position: Optional[Dict]) -> float`:
       - Calculate similarity score (0.0-1.0)
       - Layout hash match: 0.5 weight (exact match = 1.0, no match = 0.0)
       - Position similarity: 0.5 weight (proximity-based, normalized distance)
       - Return combined similarity score

2. `match_patterns(supplier_name: str, database: LearningDatabase, layout_hash: Optional[str] = None, position: Optional[Dict] = None) -> List[Dict]`:
   - Convenience function that creates PatternMatcher and calls match_patterns
   - Returns list of matched patterns with similarity scores

**Pattern Matching Logic:**
- Supplier matching: Must match exactly (normalized, case-insensitive)
- Layout hash matching: Exact match = 1.0, no match = 0.0
- Position matching: Calculate distance between pattern position and invoice position
  - Distance = sqrt((x_diff)^2 + (y_diff)^2)
  - Normalize: similarity = 1.0 / (1.0 + distance / 100.0)  # 100 points = 0.5 similarity
- Combined similarity: (layout_match * 0.5) + (position_similarity * 0.5)
- Threshold: Only return patterns with similarity >= 0.5

**Error Handling:**
- Handle missing supplier name (return empty list)
- Handle missing layout/position (use partial matching)
- Log warnings for low similarity matches

Add type hints and docstrings.
  </action>
  <verify>python -c "from src.learning.pattern_matcher import PatternMatcher, match_patterns; print('Pattern matcher imported successfully')"</verify>
  <done>Pattern matcher created with supplier-specific matching and similarity calculation</done>
</task>

<task type="auto">
  <name>Task 2: Integrate pattern matching into confidence scoring</name>
  <files>src/pipeline/footer_extractor.py</files>
  <action>
Integrate pattern matching into footer extractor to boost confidence scores.

**Update `extract_total_amount()` function:**
- After scoring candidates, query patterns for supplier
- Match patterns against invoice (supplier, layout hash, position from traceability)
- For each candidate that matches a pattern:
  - Apply confidence boost: candidate_score += pattern.confidence_boost
  - Cap at 1.0 (don't exceed maximum)
  - Log pattern match for debugging

**Integration Points:**
- After candidate scoring (before calibration)
- Use supplier_name from InvoiceHeader
- Use layout hash (simplified: hash of supplier + "footer")
- Use position from total_traceability.evidence.bbox if available

**Confidence Boost Logic:**
- Boost amount: pattern.confidence_boost (default 0.1, can be adjusted based on pattern accuracy)
- Apply boost: candidate_score = min(1.0, candidate_score + boost)
- Only boost if pattern similarity >= 0.5 (threshold from matcher)
- Boost highest similarity pattern only (or sum boosts if multiple high-similarity patterns)

**Error Handling:**
- Handle missing database gracefully (no boost, continue normally)
- Handle missing patterns (no boost, continue normally)
- Handle matching errors (log warning, continue without boost)

**Configuration:**
- Add config flag: `LEARNING_ENABLED` (default: true)
- Only apply boosts if learning enabled

Update imports and ensure pattern matching is optional (doesn't break if database missing).
  </action>
  <verify>python -c "from src.pipeline.footer_extractor import extract_total_amount; print('Footer extractor imports pattern matching')"</verify>
  <done>Pattern matching integrated into confidence scoring, boosts applied when patterns match</done>
</task>

</tasks>
