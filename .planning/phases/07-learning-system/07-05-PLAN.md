---
phase: 07-learning-system
plan: 05
type: execute
wave: 1
depends_on: []
files_modified: [src/pipeline/footer_extractor.py]
autonomous: true
gap_closure: true

# Goal-backward: UAT gap "Konfidensboost ger inte högre resultat"
must_haves:
  truths: ["When learning is on and patterns exist for a supplier, total-amount confidence increases for similar invoices"]
  artifacts: [src/pipeline/footer_extractor.py]
  key_links: [_apply_pattern_boosts uses supplier_name; treat missing vendor as 'unknown' to match patterns from corrections]
---

<objective>
Få konfidensboost att faktiskt höja resultat när inlärda mönster finns. Användarrapport: "Den får inte högre resultat".

Purpose: Stäng 07-UAT gap – konfidens vid matchande mönster ska öka.
Output: Säkerställ att pattern matching anropas även när leverantör saknas (använd "unknown" så vi matchar patterns från corrections med supplier Unknown); eventuella justeringar så boost syns (t.ex. loggning eller tröskel).
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
.planning/phases/07-learning-system/07-UAT.md (Gap: "When learning is on and patterns exist for a supplier, total-amount confidence increases")
.planning/phases/07-learning-system/07-02-SUMMARY.md (pattern boost in footer_extractor, get_learning_enabled)

Befintlig kod:
- src/pipeline/footer_extractor.py: _apply_pattern_boosts(scored_candidates, invoice_header) – returnerar direkt om inte invoice_header.supplier_name (rad 164–166). PatternMatcher.match_patterns(supplier_name, ...) kräver supplier.
- corrections.json / patterns i DB har ofta supplier_name "Unknown" (från Phase 6 när leverantör inte extraherats). PatternExtractor.normalize_supplier("Unknown") → "unknown".
- När vi processar en ny PDF utan extraherad leverantör är invoice_header.supplier_name None → inga mönster söks → ingen boost.
</context>

<tasks>

<task type="auto">
  <name>Använd 'unknown' när supplier_name saknas för pattern matching</name>
  <files>src/pipeline/footer_extractor.py</files>
  <action>
I _apply_pattern_boosts:
- Ta bort early-return när invoice_header.supplier_name är tom/None.
- Sätt supplier för matchning till: (invoice_header.supplier_name or "Unknown").strip() eller motsvarande, och normalisera med samma logik som PatternExtractor (lowercase, strip). Enklast: anropa PatternExtractor.normalize_supplier(invoice_header.supplier_name or "Unknown") och använd det i matcher.match_patterns(supplier_for_matching, ...).
- Behåll resten av logiken oförändrad (layout_hash, position, similarity_threshold 0.5).
  </action>
  <verify>
Kör process på en PDF som inte har extraherad leverantör (eller mocka supplier_name=None), med patterns i DB för "unknown". Förväntat: boost appliceras (t.ex. högre score efter steg 3). Logga debug-nivå "Applied pattern boost" om möjligt för att verifiera.
  </verify>
  <done>
- PDF utan leverantör kan få konfidensboost om det finns mönster för "unknown".
- Inga andra beteenden ändrade.
  </done>
</task>

</tasks>

<verification>
- När patterns finns för "unknown" och en ny PDF har ej leverantör: _apply_pattern_boosts söker mönster för "unknown" och applicerar boost.
</verification>

<success_criteria>
- 07-UAT gap "Den får inte högre resultat" kan stängas: användaren ser högre konfidens när learning är på och mönster finns (inkl. för Unknown-leverantör).
</success_criteria>
