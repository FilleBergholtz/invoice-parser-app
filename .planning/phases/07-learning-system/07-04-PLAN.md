---
phase: 07-learning-system
plan: 04
type: execute
wave: 1
depends_on: []
files_modified: [src/cli/main.py]
autonomous: true
gap_closure: true

# Goal-backward: UAT gap "Korrigeringar kan importeras till learning-databasen"
must_haves:
  truths: ["User can import data/corrections.json into learning.db via CLI; after run, corrections and patterns tables have rows"]
  artifacts: [src/cli/main.py]
  key_links: [CLI --import-corrections → LearningDatabase.import_corrections_from_json → pattern extraction → save_pattern]
---

<objective>
Expose import of corrections from JSON into the learning database via CLI so that "inget ligger i db" is resolved: användaren ska kunna köra ett kommando och få rader i learning.db (corrections + patterns).

Purpose: Close 07-UAT gap — "Korrigeringar kan importeras till learning-databasen" (user reported: inget ligger i db).
Output: CLI flag --import-corrections [path] and handler; default path data/corrections.json; after import, run pattern extraction and save patterns so both corrections and patterns tables are populated.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md (Phase 7 success criteria)
.planning/phases/07-learning-system/07-UAT.md (Gaps: import → learning.db)
.planning/phases/07-learning-system/07-01-SUMMARY.md (database.import_corrections_from_json, PatternExtractor)
.planning/phases/07-learning-system/07-03-SUMMARY.md (CLI pattern maintenance pattern: early return, no --input)

Befintlig kod:
- src/learning/database.py: import_corrections_from_json(json_path), get_corrections(), save_pattern(pattern)
- src/learning/pattern_extractor.py: extract_patterns_from_corrections(corrections, invoice_headers=None)
- src/config.py: get_learning_db_path()
- src/cli/main.py: _handle_pattern_maintenance() körs när args.consolidate_patterns eller args.cleanup_patterns; behöver liknande för --import-corrections
</context>

<tasks>

<task type="auto">
  <name>Add CLI --import-corrections and handler</name>
  <files>src/cli/main.py</files>
  <action>
1) Add arguments (vid samma ställe som --consolidate-patterns / --cleanup-patterns):
   - parser.add_argument("--import-corrections", action="store_true", help="Import corrections from JSON into learning database and extract patterns. Use --corrections-file for path (default: data/corrections.json).")
   - parser.add_argument("--corrections-file", type=str, default=None, help="Path to corrections JSON (with --import-corrections); default is data/corrections.json")

2) Early dispatch (efter "Handle pattern maintenance commands"):
   if args.import_corrections:
       _handle_import_corrections(args)
       return

3) Implementera _handle_import_corrections(args) (nya funktionen, samma stil som _handle_pattern_maintenance):
   - Importera: from pathlib import Path (om inte redan); from ..learning.database import LearningDatabase; from ..config import get_learning_db_path; from ..learning.pattern_extractor import extract_patterns_from_corrections
   - db_path = get_learning_db_path()
   - json_path = Path(args.corrections_file) if args.corrections_file else (db_path.parent / "corrections.json")
   - db = LearningDatabase(db_path)
   - n = db.import_corrections_from_json(json_path)
   - print(f"✓ Imported {n} corrections from {json_path}")
   - corrections = db.get_corrections()
   - patterns = extract_patterns_from_corrections(corrections)
   - for p in patterns: db.save_pattern(p)
   - print(f"✓ Extracted and saved {len(patterns)} patterns")
   Hantera FileNotFoundError/ValueError från import_corrections_from_json med tydliga felmeddelanden och sys.exit(1).
  </action>
  <verify>
Run: python -m src.cli.main --import-corrections
Expect: "✓ Imported N corrections from ..." and "✓ Extracted and saved M patterns". Then open data/learning.db and confirm rows in corrections and patterns (e.g. sqlite3 data/learning.db "SELECT COUNT(*) FROM corrections;" "SELECT COUNT(*) FROM patterns;").
  </verify>
  <done>
- CLI accepts --import-corrections (and optional --corrections-file).
- Running --import-corrections populates corrections table from JSON.
- After import, pattern extraction runs and patterns are saved; both tables have rows when corrections.json had data.
  </done>
</task>

</tasks>

<verification>
- User can run: python -m src.cli.main --import-corrections
- Output shows imported count and pattern count.
- data/learning.db has rows in corrections and patterns when corrections.json is non-empty.
</verification>

<success_criteria>
- 07-UAT gap "Korrigeringar kan importeras till learning-databasen" closable: användaren kör --import-corrections och ser rader i DB (observable).
</success_criteria>
