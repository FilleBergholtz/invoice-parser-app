---
phase: 07-learning-system
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [src/learning/database.py, src/learning/pattern_extractor.py]
autonomous: true

must_haves:
  truths:
    - "System stores user corrections in SQLite learning database"
    - "System can import corrections from JSON file (Phase 6 output)"
    - "System extracts patterns from corrections (supplier, layout, position)"
    - "Patterns stored in SQLite with supplier isolation"
  artifacts:
    - path: "src/learning/database.py"
      provides: "SQLite learning database with corrections and patterns tables"
      exports: ["LearningDatabase"]
    - path: "src/learning/pattern_extractor.py"
      provides: "Pattern extraction from corrections"
      exports: ["extract_patterns", "PatternExtractor"]
  key_links:
    - from: "src/learning/database.py"
      to: "src/learning/correction_collector.py"
      via: "Imports corrections from JSON file"
      pattern: "CorrectionCollector|get_corrections"
    - from: "src/learning/pattern_extractor.py"
      to: "src/models/invoice_header.py"
      via: "Uses InvoiceHeader data for pattern extraction"
      pattern: "InvoiceHeader|supplier_name|total_traceability"
---

<objective>
Create SQLite learning database and pattern extraction system that imports corrections from JSON and extracts supplier-specific patterns.

Purpose: Build SQLite database schema for storing corrections and patterns. Import corrections from Phase 6 JSON file. Extract patterns (supplier, layout hash, position, correct_total) from corrections.

Output: LearningDatabase class, pattern extraction functions, SQLite schema.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-learning-system/07-CONTEXT.md
@.planning/research/ARCHITECTURE.md
@src/learning/correction_collector.py
@src/models/invoice_header.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create SQLite learning database</name>
  <files>src/learning/database.py</files>
  <action>
Create SQLite learning database module `src/learning/database.py`.

**Dependencies:**
- SQLite3 (standard library)
- Path for database file management

**Class to implement:**

`LearningDatabase`:
- Manages SQLite database connection and schema
- Methods:
  - `__init__(db_path: Optional[Path] = None) -> None`: Initialize database, create schema if needed
  - `import_corrections_from_json(json_path: Path) -> int`: Import corrections from JSON file, returns count
  - `get_corrections(supplier: Optional[str] = None) -> List[Dict]`: Get corrections, optionally filtered by supplier
  - `save_pattern(pattern: Dict) -> None`: Save extracted pattern
  - `get_patterns(supplier: Optional[str] = None) -> List[Dict]`: Get patterns, optionally filtered by supplier

**Database Schema:**

1. `corrections` table:
   - id (INTEGER PRIMARY KEY)
   - invoice_id (TEXT)
   - supplier_name (TEXT, indexed)
   - original_total (REAL)
   - original_confidence (REAL)
   - corrected_total (REAL)
   - corrected_confidence (REAL)
   - raw_confidence (REAL, nullable)
   - candidate_index (INTEGER)
   - timestamp (TEXT, ISO format)
   - correction_type (TEXT, default 'total_amount')

2. `patterns` table:
   - id (INTEGER PRIMARY KEY)
   - supplier_name (TEXT, indexed, NOT NULL)
   - layout_hash (TEXT, indexed)
   - position_x (REAL)
   - position_y (REAL)
   - position_width (REAL)
   - position_height (REAL)
   - correct_total (REAL)
   - confidence_boost (REAL, default 0.1)
   - usage_count (INTEGER, default 1)
   - last_used (TEXT, ISO timestamp)
   - created_at (TEXT, ISO timestamp)

**Database Location:**
- Default: `data/learning.db` in project root
- Create data/ directory if not exists

**Indexes:**
- corrections.supplier_name (for supplier filtering)
- patterns.supplier_name (for supplier-specific matching)
- patterns.layout_hash (for pattern matching)

Add type hints and docstrings. Use context managers for database connections.
  </action>
  <verify>python -c "from src.learning.database import LearningDatabase; print('LearningDatabase imported successfully')"</verify>
  <done>SQLite learning database created with corrections and patterns tables</done>
</task>

<task type="auto">
  <name>Task 2: Create pattern extractor</name>
  <files>src/learning/pattern_extractor.py</files>
  <action>
Create pattern extraction module `src/learning/pattern_extractor.py`.

**Dependencies:**
- hashlib for layout hash
- LearningDatabase for storing patterns

**Functions/Classes to implement:**

1. `extract_patterns_from_corrections(corrections: List[Dict], invoice_headers: Optional[List[InvoiceHeader]] = None) -> List[Dict]`:
   - Extract patterns from correction list
   - For each correction:
     - Get supplier name (normalized)
     - Calculate layout hash (hash of footer structure - simplified for now)
     - Get position from traceability (if available) or use default
     - Create pattern dict with supplier, layout_hash, position, correct_total
   - Return list of patterns

2. `PatternExtractor` class (optional, for future extensibility):
   - Methods:
     - `extract(correction: Dict, invoice_header: Optional[InvoiceHeader] = None) -> Dict`: Extract single pattern
     - `normalize_supplier(supplier_name: str) -> str`: Normalize supplier name (lowercase, trim)

**Pattern Extraction Logic:**
- Supplier: Normalize (lowercase, trim whitespace)
- Layout hash: Hash of supplier + "footer" (simplified - can be enhanced with actual layout analysis)
- Position: From traceability evidence bbox if available, otherwise None
- Correct total: From corrected_total in correction
- Confidence boost: Default 0.1 (can be calculated from pattern accuracy later)

**Layout Hash (Simplified):**
- For now: hash(supplier_name + "footer")
- Future: Can be enhanced with actual footer structure analysis (row positions, column layout)

**Error Handling:**
- Handle missing traceability data gracefully
- Handle missing supplier names (use "Unknown")
- Log warnings for incomplete patterns

Add type hints and docstrings.
  </action>
  <verify>python -c "from src.learning.pattern_extractor import extract_patterns_from_corrections; print('Pattern extractor imported successfully')"</verify>
  <done>Pattern extractor created with supplier-specific pattern extraction</done>
</task>

</tasks>
