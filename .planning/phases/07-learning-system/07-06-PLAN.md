---
phase: 07-learning-system
plan: 06
type: execute
wave: 1
depends_on: []
files_modified: [src/run_summary.py, src/ui/views/main_window.py, src/cli/main.py]
autonomous: true
gap_closure: true

# Goal-backward: UAT gap "Validation UI supports multiple PDFs; user can validate more than one"
must_haves:
  truths: ["Validation UI supports multiple PDFs with low confidence; user can validate more than one invoice"]
  artifacts: [src/run_summary.py, src/ui/views/main_window.py]
  key_links: [RunSummary.validation_queue → GUI queue → "Nästa" / nästa REVIEW]
---

<objective>
Låta användaren validera fler än en PDF i viewern när kören ger flera REVIEW-fakturor. Användarrapport: "vi får bara svara på 1 pdf i viewer men de finns pdfer som har sämre confidence".

Purpose: Stäng 07-UAT gap – flera PDF:er med låg confidence ska kunna valideras.
Output: Stöd för att visa validering för flera REVIEW-invoices i tur (kö: efter Skip/Bekräfta val, visa nästa om det finns fler).
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
.planning/phases/07-learning-system/07-UAT.md (Gap: "Validation UI supports multiple PDFs...")
.planning/phases/06-manual-validation-ui/ (validerings‑UI, _show_validation_ui, processing_result)

Befintlig kod:
- RunSummary.validation: Optional[Dict] – en enda blob (candidates, traceability, pdf_path) för single-PDF REVIEW.
- main_window: needs_validation = review_count > 0 or status == REVIEW; _show_validation_ui() använder self.processing_result["validation"] och visar en PDF. Efter Skip/Bekräfta döljs valideringen – ingen "nästa".
- CLI/batch: vid en-PDF REVIEW sätts summary.validation från första REVIEW. Vid flera REVIEWs finns idag ingen lista per faktura.
</context>

<tasks>

<task type="auto">
  <name>Lägg till validation_queue i RunSummary och bygg kö vid flera REVIEWs</name>
  <files>src/run_summary.py, src/cli/main.py, src/ui/views/main_window.py</files>
  <action>
1) RunSummary (src/run_summary.py):
   - Lägg till validation_queue: Optional[List[Dict[str, Any]]] = None. Varje element: {pdf_path, candidates, traceability, invoice_id (eller motsv.)}.
   - Vid save/load: inkludera validation_queue i asdict/from-dict om det finns.

2) CLI / pipeline som bygger summary:
   - När batch/run producerar flera REVIEW-invoices: bygg en lista av validation-blobs (en per REVIEW), sätt summary.validation_queue = [dict, ...]. Behåll summary.validation = validation_queue[0] om queue inte tom (för bakåtkompatibilitet med GUI som läser validation).
   - Identifiera var i cli/main eller run_summary-byggande detta ska hända (t.ex. vid sammanställning av batch-resultat). Om endast single-PDF-körning finns i GUI, specificera att validation_queue används när run returnerar flera REVIEW-artefakter (t.ex. från batch runner eller multi-file run).

3) GUI main_window (src/ui/views/main_window.py):
   - Vid _show_validation_ui: om processing_result har validation_queue med flera element, spara index/queue och visa första. Visa knapp "Nästa faktura" (eller liknande) när det finns fler i kön.
   - Vid _skip_validation / _on_confirm: om det finns nästa i validation_queue, uppdatera processing_result.validation till nästa element, och anropa _show_validation_ui igen (eller uppdatera bara viewer/candidates/widgets till nästa) så att nästa PDF och kandidater visas. Om ingen nästa, dölj valideringswidget som idag.
   - Säkerställ att correction sparas per faktura (invoice_id) så att flera korrigeringar inte skriver över varandra.
  </action>
  <verify>
Kör en run som ger minst 2 REVIEW-fakturor (t.ex. batch med 2+ PDFs som blir REVIEW). Öppna i GUI, bekräfta att validerings‑UI visar första, sedan efter Skip eller Bekräfta att "Nästa" eller nästa automatiskt visas för andra REVIEW-PDF.
  </verify>
  <done>
- RunSummary har validation_queue och den fylls när flera REVIEWs finns.
- GUI visar validering för första REVIEW; efter Skip/Bekräfta visas nästa REVIEW tills kön är tom.
  </done>
</task>

</tasks>

<verification>
- Användaren kan validera flera PDF:er i samma kört run när det finns flera REVIEWs.
</verification>

<success_criteria>
- 07-UAT gap "vi får bara svara på 1 pdf i viewer" stängd: användaren får validera alla REVIEW-PDF:er (en efter en).
</success_criteria>

<note>
Överlappar Phase 6 (Manual Validation UI). Implementationen berör run_summary, CLI som bygger summary, och main_window. Om batch-run idag inte körs från GUI utan endast single-file, kan 07-06 begränsas till: (a) RunSummary.validation_queue, (b) main_window stöd för att från en befintlig lista av validation-dicts (t.ex. från batch-artefakter) visa en i taget med "Nästa", så att när batch/API en dag levererar queue så fungerar UI redan.
</note>
