---
phase: 05-improved-confidence-scoring
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [src/pipeline/confidence_scoring.py, src/pipeline/footer_extractor.py]
autonomous: true

must_haves:
  truths:
    - "System uses enhanced multi-factor confidence scoring with additional signals (font size, VAT proximity, currency symbols, row isolation)"
    - "System extracts all total amount candidates (no limit during extraction)"
    - "System scores all candidates independently (not just top 10)"
    - "System stores top 5 candidates with scores for UI display"
  artifacts:
    - path: "src/pipeline/confidence_scoring.py"
      provides: "Enhanced multi-factor confidence scoring with additional signals"
      exports: ["score_total_amount_candidate"]
    - path: "src/pipeline/footer_extractor.py"
      provides: "Multiple candidate extraction and scoring"
      exports: ["extract_total_amount"]
  key_links:
    - from: "src/pipeline/confidence_scoring.py"
      to: "src/models/row.py"
      via: "Scores candidates from Row objects"
      pattern: "Row|row"
    - from: "src/pipeline/confidence_scoring.py"
      to: "src/models/page.py"
      via: "Uses Page for position calculations"
      pattern: "Page|page"
    - from: "src/pipeline/footer_extractor.py"
      to: "src/pipeline/confidence_scoring.py"
      via: "Uses scoring function for all candidates"
      pattern: "score_total_amount_candidate"
---

<objective>
Enhance multi-factor confidence scoring with additional signals and improve candidate extraction to score all candidates independently.

Purpose: Add font size/weight, VAT proximity, currency symbols, and row isolation signals to confidence scoring. Extract all candidates (no limit) and score all independently. Store top 5 candidates for UI display.

Output: Enhanced scoring function, improved candidate extraction, top candidates storage.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-improved-confidence-scoring/05-CONTEXT.md
@.planning/research/SUMMARY.md
@src/pipeline/confidence_scoring.py
@src/pipeline/footer_extractor.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Enhance confidence scoring with additional signals</name>
  <files>src/pipeline/confidence_scoring.py</files>
  <action>
Enhance `score_total_amount_candidate()` function with additional signals according to 05-CONTEXT.md.

**Current scoring (sums to 1.0):**
- Keyword match: 0.35
- Position: 0.20
- Mathematical validation: 0.35
- Relative size: 0.10

**New scoring (adjust weights to sum to 1.0):**
- Keyword match: 0.32 (reduced from 0.35)
- Position: 0.18 (reduced from 0.20)
- Mathematical validation: 0.32 (reduced from 0.35)
- Relative size: 0.08 (reduced from 0.10)
- **Font size/weight: 0.05** (NEW - check if candidate row has larger font or bold tokens)
- **VAT proximity: 0.05** (NEW - check if candidate is near VAT breakdown rows)
- **Currency symbol: 0.03** (NEW - check for SEK/kr/:- symbols in row)
- **Row isolation: 0.02** (NEW - check if row is isolated or in box)

**Font size/weight signal:**
- Check if tokens in candidate row have larger font size than average footer row
- Check if tokens are bold (if font info available)
- Score: 0.05 if larger/bolder, 0.02 if average, 0.0 if smaller

**VAT proximity signal:**
- Check if candidate row is within 2-3 rows of VAT amount (look for "moms" keywords)
- Score: 0.05 if within 2 rows, 0.03 if within 3 rows, 0.0 otherwise

**Currency symbol signal:**
- Check if row contains SEK/kr/:- symbols
- Score: 0.03 if present, 0.0 otherwise

**Row isolation signal:**
- Check if row is separated by blank lines or in visual box
- Score: 0.02 if isolated, 0.0 otherwise

Update function signature if needed to pass additional context (e.g., all footer rows for VAT proximity check).

Keep backward compatibility - existing calls should still work.
  </action>
  <verify>python -c "from src.pipeline.confidence_scoring import score_total_amount_candidate; import inspect; sig = inspect.signature(score_total_amount_candidate); print('Function signature:', sig)"</verify>
  <done>score_total_amount_candidate enhanced with 4 additional signals (font, VAT proximity, currency, isolation), weights adjusted to sum to 1.0</done>
</task>

<task type="auto">
  <name>Task 2: Improve candidate extraction and scoring</name>
  <files>src/pipeline/footer_extractor.py</files>
  <action>
Improve `extract_total_amount()` to extract ALL candidates (no limit) and score ALL candidates independently.

**Current behavior:**
- Extracts candidates, limits to top 10 for scoring
- Only scores limited candidates

**New behavior:**
1. Extract ALL candidates (no limit during extraction phase)
2. Score ALL candidates independently using `score_total_amount_candidate()`
3. Sort all scored candidates by score descending
4. Store top 5 candidates with scores in InvoiceHeader (add new field: `total_candidates: List[Dict]`)
5. Select final value from top candidate (existing logic)

**Add to InvoiceHeader model:**
- `total_candidates: Optional[List[Dict]] = None` - List of top 5 candidates with:
  - `amount: float`
  - `score: float`
  - `row_index: int`
  - `keyword_type: Optional[str]`

**Update InvoiceHeader model** (`src/models/invoice_header.py`):
- Add field: `total_candidates: Optional[List[Dict[str, Any]]] = None`

**Implementation:**
- Remove candidate_limit logic (extract all)
- Score all candidates (not just top 10)
- Store top 5 in InvoiceHeader.total_candidates
- Keep existing final selection logic (top candidate)

Update type hints and ensure backward compatibility.
  </action>
  <verify>python -c "from src.pipeline.footer_extractor import extract_total_amount; from src.models.invoice_header import InvoiceHeader; h = InvoiceHeader(); print('Has total_candidates:', hasattr(h, 'total_candidates'))"</verify>
  <done>extract_total_amount extracts all candidates, scores all independently, stores top 5 in InvoiceHeader.total_candidates</done>
</task>

</tasks>
