---
phase: 02-header-wrap
plan: 03
type: execute
wave: 3
depends_on: ["02-01"]
files_modified: [src/pipeline/header_extractor.py, src/pipeline/confidence_scoring.py, src/cli/main.py, tests/test_header_extractor.py]
autonomous: true

must_haves:
  truths:
    - "System extracts invoice number from header segment using keyword proximity and regex"
    - "System scores invoice number candidates using multi-factor confidence scoring (keyword 0.35, position 0.30, format 0.20, uniqueness 0.10, OCR 0.05)"
    - "System handles top-2 tie-breaking: if within 0.03 score difference → REVIEW"
    - "System stores invoice number with confidence score ≥0.95 for OK, otherwise REVIEW"
    - "System stores traceability evidence for invoice number"
  artifacts:
    - path: "src/pipeline/header_extractor.py"
      provides: "Invoice number extraction from header segment"
      exports: ["extract_invoice_number", "extract_header_fields"]
    - path: "src/pipeline/confidence_scoring.py"
      provides: "Invoice number confidence scoring (extends existing confidence_scoring.py)"
      exports: ["score_invoice_number_candidate"]
  key_links:
    - from: "src/pipeline/header_extractor.py"
      to: "src/models/segment.py"
      via: "Extracts from header segment"
      pattern: "Segment|segment_type.*header"
    - from: "src/pipeline/header_extractor.py"
      to: "src/pipeline/confidence_scoring.py"
      via: "Uses scoring algorithms for candidate evaluation"
      pattern: "score_invoice_number_candidate"
    - from: "src/pipeline/header_extractor.py"
      to: "src/models/invoice_header.py"
      via: "Updates InvoiceHeader.invoice_number and invoice_number_confidence"
      pattern: "InvoiceHeader|invoice_number|invoice_number_confidence"
    - from: "src/pipeline/confidence_scoring.py"
      to: "src/models/traceability.py"
      via: "Creates Traceability evidence for extracted values"
      pattern: "Traceability"
---

<objective>
Implement invoice number extraction from header segment with confidence scoring and traceability.

Purpose: Extract invoice number from header segment using keyword proximity and regex, score candidates with multi-factor weights (keyword 0.35, position 0.30), handle tie-breaking (top-2 within 0.03 → REVIEW), and store with traceability. This is Priority 2 for Phase 2 (after totalsumma).
Output: Header extractor for invoice number, confidence scoring for invoice number, integration with InvoiceHeader.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-header-wrap/02-CONTEXT.md
@.planning/phases/02-header-wrap/02-RESEARCH.md
@docs/04_heuristics.md
@specs/invoice_pipeline_v1.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement confidence scoring for invoice number</name>
  <files>src/pipeline/confidence_scoring.py</files>
  <action>
Implement multi-factor confidence scoring for invoice number candidates according to 02-CONTEXT.md and 02-RESEARCH.md.

Function to implement:
- `score_invoice_number_candidate(candidate: str, row: Row, page: Page, all_rows: List[Row]) -> float`: Returns confidence score 0.0-1.0

Score components (normalized to 0.0-1.0):
- Position (0.30 weight): Header zone (y < 0.3 * page_height) → full score (0.30)
- Keyword proximity (0.35 weight): "fakturanummer / invoice number / nr / no" on same row → full score (0.35), within 1 row above → partial (0.25)
- Format validation (0.20 weight): Alphanumeric, length 3-25, not just date/amount/org number → full score (0.20)
- Uniqueness (0.10 weight): Appears once in document (or clearly most likely instance) → full score (0.10)
- OCR/Token confidence (0.05 weight): Average confidence of tokens in candidate area → score = 0.05 * avg_conf

Use 02-RESEARCH.md implementation pattern. Normalize final score to 0.0-1.0 range.

Helper functions:
- `_validate_invoice_number_format(candidate: str) -> bool`: Validates alphanumeric, length 3-25, not date/amount/org number pattern
- `_has_keyword_in_adjacent_row(row: Row, all_rows: List[Row], keyword_pattern: str) -> bool`: Checks if keyword exists in row above
- `_appears_once_in_document(candidate: str, all_rows: List[Row]) -> bool`: Checks if candidate appears only once
- `_average_token_confidence(tokens: List[Token]) -> float`: Calculates average confidence from tokens (default 1.0 if no confidence available)
  </action>
  <verify>python -c "from src.pipeline.confidence_scoring import score_invoice_number_candidate; # Basic import test"</verify>
  <done>score_invoice_number_candidate implemented with correct weights (keyword 0.35, position 0.30, format 0.20, uniqueness 0.10, OCR 0.05)</done>
</task>

<task type="auto">
  <name>Task 2: Implement header extractor for invoice number</name>
  <files>src/pipeline/header_extractor.py</files>
  <action>
Implement invoice number extraction from header segment using keyword proximity, regex, and confidence scoring.

Function to implement:
- `extract_invoice_number(header_segment: Segment, invoice_header: InvoiceHeader) -> None`: Extracts invoice number, scores candidates, updates InvoiceHeader

Algorithm:
1. Extract all candidates from header segment rows:
   - Use regex pattern: `(?:fakturanummer|invoice\s*number|no\.|nr|number)[\s:]*([A-Z0-9\-]+)` (Heuristik 5)
   - Extract alphanumeric values after keywords
   - Also search for standalone alphanumeric patterns in header zone (fallback)
   
2. Score each candidate using `score_invoice_number_candidate()`:
   - Extract all matches, limit scoring to top 10 candidates (performance)
   - Score all candidates, sort by score descending
   
3. Select final value:
   - Choose candidate with highest score
   - Handle tie-breaking: If top-2 candidates are within 0.03 score difference and have different values → REVIEW (set confidence < 0.95, don't store value)
   - If highest score ≥0.95 → OK, store value
   - If highest score < 0.95 → REVIEW, don't store value (or store with low confidence)
   
4. Create traceability evidence:
   - Extract page_number from segment.page
   - Calculate bbox (union of all tokens matching invoice number)
   - Get row_index (position in header_segment.rows)
   - Extract text_excerpt (max 120 characters, full row if shorter)
   - Store tokens (minimal info: text, bbox as list, confidence if available)
   
5. Update InvoiceHeader:
   - Set invoice_number (extracted value or None if REVIEW)
   - Set invoice_number_confidence (score or 0.0 if no candidate found)
   - Set invoice_number_traceability (Traceability object or None)

Error handling: If header_segment is None or has no rows, set invoice_number_confidence = 0.0 (REVIEW).
  </action>
  <verify>python -c "from src.pipeline.header_extractor import extract_invoice_number; # Basic import test"</verify>
  <done>extract_invoice_number extracts invoice number from header segment, scores candidates, handles tie-breaking, creates traceability, updates InvoiceHeader</done>
</task>

<task type="auto">
  <name>Task 3: Integrate header extractor into CLI pipeline</name>
  <files>src/cli/main.py</files>
  <action>
Integrate header extractor into CLI pipeline after segment identification (before line item extraction, since invoice number doesn't depend on line items).

Update process_invoice() function:
- After segment identification
- Find header segment: `header_segment = next((s for s in segments if s.segment_type == "header"), None)`
- Create InvoiceHeader with segment reference and raw_text (concatenate header segment rows)
- Call `extract_invoice_number(header_segment, invoice_header)`

Handle multi-page invoices:
- Process header segment from first page (invoice number typically on first page)
- Or combine header segments if invoice number might span pages

Store InvoiceHeader in Document.metadata or create separate structure (will be refined in later plans).
  </action>
  <verify>python -c "from src.cli.main import process_invoice; # Import test"</verify>
  <done>Header extractor integrated into CLI pipeline, invoice number extracted and stored in InvoiceHeader after segment identification</done>
</task>

<task type="auto">
  <name>Task 4: Write unit tests for header extractor and invoice number scoring</name>
  <files>tests/test_header_extractor.py</files>
  <action>
Create unit tests for header extractor and invoice number confidence scoring.

Tests to write:
- Test invoice number extraction from header segment with keywords
- Test confidence scoring components (keyword proximity, position, format, uniqueness, OCR confidence)
- Test tie-breaking logic (top-2 within 0.03 → REVIEW)
- Test candidate selection (highest score, ≥0.95 = OK)
- Test traceability evidence creation (bbox, text_excerpt, tokens)
- Test REVIEW case (confidence < 0.95, value not stored)

Use pytest fixtures for Segment, Row objects. Verify:
- Invoice number extracted correctly from header rows
- Confidence scores calculated with correct weights
- Tie-breaking works correctly (within 0.03 → REVIEW)
- Traceability evidence structure matches 02-CONTEXT.md format

Ensure tests run with `pytest tests/test_header_extractor.py -v`.
  </action>
  <verify>pytest tests/test_header_extractor.py -v</verify>
  <done>All header extractor and invoice number scoring unit tests pass, coverage >80%</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] pytest tests/test_header_extractor.py -v passes
- [ ] mypy type checking passes for all new files
- [ ] Invoice number extracted from header segment using keywords and regex
- [ ] Confidence scoring uses correct weights (keyword 0.35, position 0.30, format 0.20, uniqueness 0.10, OCR 0.05)
- [ ] Tie-breaking works: top-2 within 0.03 → REVIEW
- [ ] Traceability evidence created and stored in InvoiceHeader
- [ ] Header extractor integrated into CLI pipeline
</verification>

<success_criteria>

- All tasks completed
- Invoice number extracted from header segment with keyword proximity and regex
- Multi-factor confidence scoring implemented with correct weights
- Tie-breaking logic: top-2 within 0.03 score difference → REVIEW
- Confidence ≥0.95 = OK, otherwise REVIEW (hard gate)
- Traceability evidence stored for invoice number
- Unit tests pass with >80% coverage
- No type errors or linting issues

</success_criteria>

<output>
After completion, create `.planning/phases/02-header-wrap/02-03-SUMMARY.md`
</output>
