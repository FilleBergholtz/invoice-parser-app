---
phase: 02-header-wrap
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified: [src/pipeline/footer_extractor.py, src/pipeline/confidence_scoring.py, src/cli/main.py, tests/test_footer_extractor.py]
autonomous: true

must_haves:
  truths:
    - "System extracts total amount from footer segment using keyword matching"
    - "System scores total amount candidates using multi-factor confidence scoring (keyword 0.35, position 0.20, mathematical validation 0.35, relative size 0.10)"
    - "System validates total amount against line item sums with ±1 SEK tolerance"
    - "System stores total amount with confidence score ≥0.95 for OK, otherwise REVIEW"
    - "System stores traceability evidence for total amount"
  artifacts:
    - path: "src/pipeline/footer_extractor.py"
      provides: "Total amount extraction from footer segment"
      exports: ["extract_total_amount"]
    - path: "src/pipeline/confidence_scoring.py"
      provides: "Multi-factor confidence scoring algorithms"
      exports: ["score_total_amount_candidate", "validate_total_against_line_items"]
  key_links:
    - from: "src/pipeline/footer_extractor.py"
      to: "src/models/segment.py"
      via: "Extracts from footer segment"
      pattern: "Segment|segment_type.*footer"
    - from: "src/pipeline/footer_extractor.py"
      to: "src/pipeline/confidence_scoring.py"
      via: "Uses scoring algorithms for candidate evaluation"
      pattern: "score_total_amount_candidate"
    - from: "src/pipeline/footer_extractor.py"
      to: "src/models/invoice_header.py"
      via: "Updates InvoiceHeader.total_amount and total_confidence"
      pattern: "InvoiceHeader|total_amount|total_confidence"
    - from: "src/pipeline/footer_extractor.py"
      to: "src/models/invoice_line.py"
      via: "Validates against line item sums"
      pattern: "InvoiceLine|total_amount"
    - from: "src/pipeline/confidence_scoring.py"
      to: "src/models/traceability.py"
      via: "Creates Traceability evidence for extracted values"
      pattern: "Traceability"
---

<objective>
Implement total amount extraction from footer segment with confidence scoring and mathematical validation.

Purpose: Extract total amount from footer segment using keyword matching, score candidates with multi-factor weights (mathematical validation weighted 0.35), validate against line item sums, and store with traceability. This is Priority 1 for Phase 2 (strongest signal via mathematical validation).
Output: Footer extractor, confidence scoring for total amount, integration with InvoiceHeader.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-header-wrap/02-CONTEXT.md
@.planning/phases/02-header-wrap/02-RESEARCH.md
@docs/04_heuristics.md
@specs/invoice_pipeline_v1.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement confidence scoring for total amount</name>
  <files>src/pipeline/confidence_scoring.py</files>
  <action>
Implement multi-factor confidence scoring for total amount candidates according to 02-CONTEXT.md and 02-RESEARCH.md.

Functions to implement:
- `score_total_amount_candidate(candidate: float, row: Row, page: Page, line_items: List[InvoiceLine], footer_rows: List[Row]) -> float`: Returns confidence score 0.0-1.0

Score components (normalized to 0.0-1.0):
- Keyword match (0.35 weight): "Att betala" strongest (0.35), "Total/Totalt" next (0.30), "Summa att betala" (0.30)
- Position (0.20 weight): Footer zone (y > 0.8 * page_height) + right-aligned
- Mathematical validation (0.35 weight): If subtotal + VAT + rounding ≈ total → full score (0.35). If only total exists (no validation possible) → neutral (0.15, not penalized but lower)
- Relative size (0.10 weight): Total should be largest amount in summation rows

Use 02-RESEARCH.md implementation pattern. Normalize final score to 0.0-1.0 range.

Helper function:
- `validate_total_against_line_items(total: float, line_items: List[InvoiceLine], tolerance: float = 1.0) -> bool`: Validates total against sum of line item totals with ±1 SEK tolerance

Return True if `abs(total - sum(line.total_amount for line in line_items)) <= tolerance`.
  </action>
  <verify>python -c "from src.pipeline.confidence_scoring import score_total_amount_candidate, validate_total_against_line_items; from src.models.row import Row; from src.models.page import Page; # Basic structure test"</verify>
  <done>score_total_amount_candidate and validate_total_against_line_items implemented with correct weights, mathematical validation with ±1 SEK tolerance</done>
</task>

<task type="auto">
  <name>Task 2: Implement footer extractor for total amount</name>
  <files>src/pipeline/footer_extractor.py</files>
  <action>
Implement total amount extraction from footer segment using keyword matching and confidence scoring.

Function to implement:
- `extract_total_amount(footer_segment: Segment, line_items: List[InvoiceLine], invoice_header: InvoiceHeader) -> None`: Extracts total amount, scores candidates, updates InvoiceHeader

Algorithm:
1. Extract all amount candidates from footer segment rows:
   - Search for keywords: "Att betala", "Total", "Totalt", "Summa att betala" (Heuristik 11)
   - Extract numeric amounts linked to these keywords
   - Look for right-aligned numeric values in footer rows
   
2. Score each candidate using `score_total_amount_candidate()`:
   - Limit to top 10 candidates (performance + robustness)
   - Score all candidates, sort by score descending
   
3. Select final value:
   - Choose candidate with highest score
   - If two totals compete but only one passes validation → choose validated one
   - If none pass validation and multiple exist → REVIEW (set confidence < 0.95)
   
4. Create traceability evidence:
   - Extract page_number from segment.page
   - Calculate bbox (union of all tokens in matching row)
   - Get row_index (position in footer_segment.rows)
   - Extract text_excerpt (max 120 characters, full row if shorter)
   - Store tokens (minimal info: text, bbox as list, confidence if available)
   
5. Update InvoiceHeader:
   - Set total_amount (extracted value or None)
   - Set total_confidence (score or 0.0 if no candidate found)
   - Set total_traceability (Traceability object or None)

Error handling: If footer_segment is None or has no rows, set total_confidence = 0.0 (REVIEW).
  </action>
  <verify>python -c "from src.pipeline.footer_extractor import extract_total_amount; # Basic import test"</verify>
  <done>extract_total_amount extracts total amount from footer segment, scores candidates, validates against line items, creates traceability, updates InvoiceHeader</done>
</task>

<task type="auto">
  <name>Task 3: Integrate footer extractor into CLI pipeline</name>
  <files>src/cli/main.py</files>
  <action>
Integrate footer extractor into CLI pipeline after segment identification and line item extraction.

Update process_invoice() function:
- After extracting line items from items segment
- Find footer segment: `footer_segment = next((s for s in segments if s.segment_type == "footer"), None)`
- Create InvoiceHeader (or get existing one if created earlier)
- Call `extract_total_amount(footer_segment, all_invoice_lines, invoice_header)`

Handle multi-page invoices:
- Process footer segment from last page (if total appears on last page)
- Or combine footer segments from all pages if needed

Ensure InvoiceHeader is linked to Document (can be stored in Document.metadata or separate structure for now, will be refined in later plans).
  </action>
  <verify>python -c "from src.cli.main import process_invoice; # Import test"</verify>
  <done>Footer extractor integrated into CLI pipeline, total amount extracted and stored in InvoiceHeader after line item extraction</done>
</task>

<task type="auto">
  <name>Task 4: Write unit tests for footer extractor and confidence scoring</name>
  <files>tests/test_footer_extractor.py</files>
  <action>
Create unit tests for footer extractor and total amount confidence scoring.

Tests to write:
- Test total amount extraction from footer segment with keywords
- Test confidence scoring components (keyword match, position, mathematical validation, relative size)
- Test mathematical validation against line item sums (±1 SEK tolerance)
- Test candidate selection (highest score, validation preference)
- Test traceability evidence creation (bbox, text_excerpt, tokens)
- Test REVIEW case (confidence < 0.95 when no good candidate)

Use pytest fixtures for Segment, Row, InvoiceLine objects. Verify:
- Total amount extracted correctly from footer rows
- Confidence scores calculated with correct weights
- Mathematical validation works with tolerance
- Traceability evidence structure matches 02-CONTEXT.md format

Ensure tests run with `pytest tests/test_footer_extractor.py -v`.
  </action>
  <verify>pytest tests/test_footer_extractor.py -v</verify>
  <done>All footer extractor and confidence scoring unit tests pass, coverage >80%</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] pytest tests/test_footer_extractor.py -v passes
- [ ] mypy type checking passes for all new files
- [ ] Total amount extracted from footer segment using keywords
- [ ] Confidence scoring uses correct weights (keyword 0.35, validation 0.35, position 0.20, size 0.10)
- [ ] Mathematical validation works with ±1 SEK tolerance
- [ ] Traceability evidence created and stored in InvoiceHeader
- [ ] Footer extractor integrated into CLI pipeline
</verification>

<success_criteria>

- All tasks completed
- Total amount extracted from footer segment with keyword matching
- Multi-factor confidence scoring implemented with correct weights
- Mathematical validation validates against line item sums (±1 SEK tolerance)
- Confidence ≥0.95 = OK, otherwise REVIEW (hard gate)
- Traceability evidence stored for total amount
- Unit tests pass with >80% coverage
- No type errors or linting issues

</success_criteria>

<output>
After completion, create `.planning/phases/02-header-wrap/02-02-SUMMARY.md`
</output>
