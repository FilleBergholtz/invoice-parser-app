---
phase: 02-header-wrap
plan: 05
type: execute
wave: 5
depends_on: ["02-01", "01-04"]
files_modified: [src/pipeline/wrap_detection.py, src/pipeline/invoice_line_parser.py, src/cli/main.py, tests/test_wrap_detection.py]
autonomous: true

must_haves:
  truths:
    - "System detects wrapped rows (continuation lines) for invoice line items"
    - "Wrap detection uses spatial X-position tolerance (±2% of page width)"
    - "System groups wrapped rows to same InvoiceLine (updates InvoiceLine.rows and description)"
    - "Max 3 wrap rows per line item enforced"
    - "Wrap text consolidated with space separator (Excel-friendly)"
  artifacts:
    - path: "src/pipeline/wrap_detection.py"
      provides: "Wrap detection logic for multi-line items"
      exports: ["detect_wrapped_rows", "consolidate_wrapped_description"]
    - path: "src/pipeline/invoice_line_parser.py"
      provides: "Updated line item parser with wrap detection integration"
      exports: ["extract_invoice_lines"] (updated)
  key_links:
    - from: "src/pipeline/wrap_detection.py"
      to: "src/models/row.py"
      via: "Detects wraps from Row objects"
      pattern: "Row|row\\.x_min"
    - from: "src/pipeline/wrap_detection.py"
      to: "src/models/invoice_line.py"
      via: "Updates InvoiceLine.rows and description with wrapped rows"
      pattern: "InvoiceLine|rows\\.append|description"
    - from: "src/pipeline/invoice_line_parser.py"
      to: "src/pipeline/wrap_detection.py"
      via: "Calls wrap detection after creating InvoiceLine"
      pattern: "detect_wrapped_rows"
---

<objective>
Implement wrap detection for multi-line invoice items and integrate with line item extraction.

Purpose: Detect continuation lines (wrapped text) for invoice line items using spatial X-position tolerance (±2% page width), group wrapped rows to same InvoiceLine, consolidate description with space separator. This is Priority 4 for Phase 2 (multi-line item handling).
Output: Wrap detection logic, integration with invoice line parser, updated InvoiceLines with wrapped rows.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-header-wrap/02-CONTEXT.md
@.planning/phases/02-header-wrap/02-RESEARCH.md
@docs/04_heuristics.md
@specs/invoice_pipeline_v1.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement wrap detection logic</name>
  <files>src/pipeline/wrap_detection.py</files>
  <action>
Implement wrap detection according to 02-CONTEXT.md and Heuristik 9 (docs/04_heuristics.md).

Function to implement:
- `detect_wrapped_rows(product_row: Row, following_rows: List[Row], page: Page) -> List[Row]`: Returns list of wrapped rows

Algorithm:
1. Get description column start position:
   - Use product_row.x_min (first token's X position)
   - Or calculate from first non-amount token if needed
   
2. Calculate X-position tolerance:
   - Tolerance = ±0.02 * page.width (2% of page width)
   - More robust than absolute pixels across DPI variations
   
3. Iterate through following_rows:
   - Stop conditions:
     a. Next row contains amount → stop (new product row)
     b. X-start deviates > tolerance → stop (different column)
     c. Max 3 wraps reached → stop (prevent runaway wrapping)
   - Candidate wrap row criteria:
     a. Lies directly below product_row (next in list)
     b. Contains no amount (checked by looking for numeric patterns)
     c. Starts at approximately same X as description start (within tolerance)
   
4. Return list of wrapped rows

Helper function:
- `_contains_amount(row: Row) -> bool`: Checks if row contains numeric amount (reuse logic from invoice_line_parser.py)
- `_get_description_column_start(row: Row) -> float`: Gets X-position of description column start (first token or first non-amount token)
  </action>
  <verify>python -c "from src.pipeline.wrap_detection import detect_wrapped_rows; # Basic import test"</verify>
  <done>detect_wrapped_rows detects wrapped rows using spatial X-position tolerance, enforces max 3 wraps, stops on amount-containing row</done>
</task>

<task type="auto">
  <name>Task 2: Implement wrap consolidation</name>
  <files>src/pipeline/wrap_detection.py</files>
  <action>
Implement wrap text consolidation with space separator (Excel-friendly).

Function to implement:
- `consolidate_wrapped_description(product_row: Row, wrapped_rows: List[Row]) -> str`: Returns consolidated description

Algorithm:
1. Extract text from product_row (description tokens before amount)
2. Extract text from each wrapped row (all tokens, no amount filtering needed for wraps)
3. Concatenate with space separator:
   - Primary description + " " + wrap1 + " " + wrap2 + " " + wrap3
   - Use space separator (not newline) for Excel readability

This consolidated description replaces InvoiceLine.description.
  </action>
  <verify>python -c "from src.pipeline.wrap_detection import consolidate_wrapped_description; # Basic import test"</verify>
  <done>consolidate_wrapped_description consolidates wrap text with space separator</done>
</task>

<task type="auto">
  <name>Task 3: Integrate wrap detection into invoice line parser</name>
  <files>src/pipeline/invoice_line_parser.py</files>
  <action>
Integrate wrap detection into invoice line extraction process.

Update extract_invoice_lines() function:
- After creating InvoiceLine from product_row
- Get following rows: `following_rows = items_segment.rows[row_index + 1:]`
- Call `detect_wrapped_rows(product_row, following_rows, items_segment.page)`
- If wrapped rows found:
  - Update InvoiceLine.rows: append wrapped rows to existing rows list (rows is KÄLLSANING for traceability)
  - Update InvoiceLine.description: call `consolidate_wrapped_description(product_row, wrapped_rows)`
- Skip wrapped rows in main loop (don't create separate InvoiceLine for wraps)

Edge case handling:
- If wrap row contains partial amount → treat as new row/fee row (not wrap), flag for uncertainty if needed
- Handle wrap detection across page boundaries (Phase 2 scope: within-page only, can defer cross-page to later)

Ensure wrapped rows are included in InvoiceLine.rows for full traceability (KÄLLSANING).
  </action>
  <verify>python -c "from src.pipeline.invoice_line_parser import extract_invoice_lines; # Import test"</verify>
  <done>Wrap detection integrated into invoice line parser, wrapped rows added to InvoiceLine.rows, description consolidated</done>
</task>

<task type="auto">
  <name>Task 4: Write unit tests for wrap detection</name>
  <files>tests/test_wrap_detection.py</files>
  <action>
Create unit tests for wrap detection logic.

Tests to write:
- Test wrap detection with X-position tolerance (±2% page width)
- Test stop conditions (amount-containing row, X-deviation, max 3 wraps)
- Test wrap consolidation with space separator
- Test edge cases: no wraps, max wraps reached, wrap with partial amount (should not be wrap)
- Test integration with invoice line parser (wrapped rows added to InvoiceLine.rows)

Use pytest fixtures for Row, Page objects. Verify:
- Wrapped rows detected correctly using spatial position
- Max 3 wraps enforced
- Description consolidated with space separator
- InvoiceLine.rows includes wrapped rows (traceability maintained)

Ensure tests run with `pytest tests/test_wrap_detection.py -v`.
  </action>
  <verify>pytest tests/test_wrap_detection.py -v</verify>
  <done>All wrap detection unit tests pass, coverage >80%</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] pytest tests/test_wrap_detection.py -v passes
- [ ] mypy type checking passes for all new files
- [ ] Wrap detection uses spatial X-position tolerance (±2% page width)
- [ ] Max 3 wraps per line item enforced
- [ ] Stop conditions work (amount-containing row, X-deviation)
- [ ] Wrap text consolidated with space separator
- [ ] Wrapped rows added to InvoiceLine.rows (traceability maintained)
- [ ] Wrap detection integrated into invoice line parser
</verification>

<success_criteria>

- All tasks completed
- Wrap detection detects continuation lines using spatial X-position tolerance
- Max 3 wraps per line item enforced
- Stop conditions work correctly (amount, X-deviation, max wraps)
- Wrap text consolidated with space separator (Excel-friendly)
- InvoiceLine.rows includes wrapped rows (KÄLLSANING for traceability)
- Unit tests pass with >80% coverage
- No type errors or linting issues

</success_criteria>

<output>
After completion, create `.planning/phases/02-header-wrap/02-05-SUMMARY.md`
</output>
