---
phase: 02-header-wrap
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [src/models/invoice_header.py, src/models/traceability.py, tests/test_invoice_header.py, tests/test_traceability.py]
autonomous: true

must_haves:
  truths:
    - "System has InvoiceHeader model with fields for invoice_number, invoice_date, supplier_name, confidence scores"
    - "System has Traceability model for storing evidence (page_number, bbox, text_excerpt, tokens)"
    - "InvoiceHeader stores traceability for invoice_number and total_amount fields"
    - "Traceability evidence structure matches 02-CONTEXT.md JSON format"
  artifacts:
    - path: "src/models/invoice_header.py"
      provides: "InvoiceHeader data model with confidence scores and traceability"
      contains: "class InvoiceHeader"
    - path: "src/models/traceability.py"
      provides: "Traceability evidence structure for critical fields"
      contains: "class Traceability"
  key_links:
    - from: "src/models/invoice_header.py"
      to: "src/models/segment.py"
      via: "InvoiceHeader.segment references Segment"
      pattern: "Segment"
    - from: "src/models/invoice_header.py"
      to: "src/models/traceability.py"
      via: "InvoiceHeader stores Traceability for invoice_number and total_amount"
      pattern: "Traceability"
    - from: "src/models/traceability.py"
      to: "src/models/token.py"
      via: "Traceability.evidence.tokens references Token objects"
      pattern: "Token"
---

<objective>
Create InvoiceHeader and Traceability data models as foundation for Phase 2 field extraction.

Purpose: Establish data models for storing extracted header fields (invoice number, date, vendor) with confidence scores and traceability evidence. This provides the foundation for all Phase 2 field extraction work.
Output: InvoiceHeader model, Traceability model, unit tests.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-header-wrap/02-CONTEXT.md
@.planning/phases/02-header-wrap/02-RESEARCH.md
@docs/02_data-model.md
@specs/invoice_pipeline_v1.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Traceability data model</name>
  <files>src/models/traceability.py</files>
  <action>
Create Traceability class according to 02-CONTEXT.md specifications.

Traceability class (JSON structure):
- field: str ("invoice_no" or "total")
- value: str (extracted value as string)
- confidence: float (0.0-1.0)
- evidence: Dict with:
  - page_number: int
  - bbox: List[float] (x, y, width, height - union of all tokens)
  - row_index: int (index of row in segment)
  - text_excerpt: str (max 120 characters, full row if shorter)
  - tokens: List[Dict] (list of token dicts with text, bbox, conf)

Use dataclass or Pydantic. Add type hints. Provide method to serialize to JSON dict matching 02-CONTEXT.md format.

The evidence.tokens should store minimal token info (text, bbox as list, confidence) for JSON serialization, not full Token objects (to avoid circular references in JSON).
  </action>
  <verify>python -c "from src.models.traceability import Traceability; t = Traceability(field='invoice_no', value='INV-001', confidence=0.95, evidence={'page_number': 1, 'bbox': [100, 50, 90, 12], 'row_index': 0, 'text_excerpt': 'Test', 'tokens': []}); assert t.confidence == 0.95"</verify>
  <done>Traceability class defined with field, value, confidence, evidence dict, JSON serialization method</done>
</task>

<task type="auto">
  <name>Task 2: Create InvoiceHeader data model</name>
  <files>src/models/invoice_header.py</files>
  <action>
Create InvoiceHeader class according to docs/02_data-model.md and 02-CONTEXT.md specifications.

InvoiceHeader class:
- segment: Segment (reference to header segment)
- invoice_number: Optional[str] (extracted invoice number or None)
- invoice_number_confidence: float (0.0-1.0, default 0.0)
- invoice_number_traceability: Optional[Traceability] (evidence for invoice number)
- invoice_date: Optional[datetime.date] (extracted date or None, normalized to ISO format)
- supplier_name: Optional[str] (vendor/company name, address out of scope Phase 2)
- supplier_address: Optional[str] (deferred to later phase, can be None)
- customer_name: Optional[str] (can be None)
- customer_address: Optional[str] (can be None)
- raw_text: str (concatenated text from header segment rows)
- total_amount: Optional[float] (extracted total amount or None)
- total_confidence: float (0.0-1.0, default 0.0)
- total_traceability: Optional[Traceability] (evidence for total amount)

Use dataclass or Pydantic. Add type hints. Ensure InvoiceHeader maintains segment reference for traceability. Use TYPE_CHECKING for circular imports if needed.

Confidence scores default to 0.0 (uncertain until extraction completes). Traceability fields are Optional (None until extraction completes).
  </action>
  <verify>python -m mypy src/models/invoice_header.py --python-version 3.11</verify>
  <done>InvoiceHeader class defined with all fields including confidence scores and traceability, type hints pass mypy validation</done>
</task>

<task type="auto">
  <name>Task 3: Write unit tests for InvoiceHeader and Traceability</name>
  <files>tests/test_invoice_header.py, tests/test_traceability.py</files>
  <action>
Create comprehensive unit tests for InvoiceHeader and Traceability models.

Tests to write:
- test_traceability.py:
  - Test Traceability creation with evidence dict
  - Test JSON serialization (to_dict method)
  - Test evidence structure (page_number, bbox, text_excerpt, tokens)
  - Test confidence range validation (0.0-1.0)

- test_invoice_header.py:
  - Test InvoiceHeader creation with segment reference
  - Test confidence scores default to 0.0
  - Test traceability fields are Optional (can be None)
  - Test raw_text concatenation from segment rows
  - Test invoice_date normalization (if applicable)

Use pytest fixtures for Segment objects (simplified for unit tests). Verify:
- Traceability JSON serialization matches 02-CONTEXT.md format
- InvoiceHeader can store confidence scores and traceability
- Models validate correctly (confidence in range, required fields present)

Follow pytest best practices. Ensure tests run with `pytest tests/test_invoice_header.py tests/test_traceability.py -v`.
  </action>
  <verify>pytest tests/test_invoice_header.py tests/test_traceability.py -v</verify>
  <done>All unit tests pass, coverage >80% for InvoiceHeader and Traceability models</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] pytest tests/test_invoice_header.py tests/test_traceability.py -v passes
- [ ] mypy type checking passes for all new files
- [ ] InvoiceHeader model has all required fields (invoice_number, date, supplier_name, confidence scores, traceability)
- [ ] Traceability model matches 02-CONTEXT.md JSON structure
- [ ] Models can serialize to JSON for review folder export
</verification>

<success_criteria>

- All tasks completed
- InvoiceHeader model matches docs/02_data-model.md and 02-CONTEXT.md specifications
- Traceability model matches 02-CONTEXT.md JSON structure
- Confidence scores stored as float (0.0-1.0)
- Traceability evidence structure includes page_number, bbox, row_index, text_excerpt, tokens
- Unit tests pass with >80% coverage
- No type errors or linting issues

</success_criteria>

<output>
After completion, create `.planning/phases/02-header-wrap/02-01-SUMMARY.md`
</output>
