---
phase: 02-header-wrap
plan: 04
type: execute
wave: 4
depends_on: ["02-01", "02-03"]
files_modified: [src/pipeline/header_extractor.py, tests/test_header_extractor.py]
autonomous: true

must_haves:
  truths:
    - "System extracts vendor name from header segment (company name only, address out of scope)"
    - "System extracts invoice date from header segment and normalizes to ISO format (YYYY-MM-DD)"
    - "Vendor and date extraction have no hard gate (low confidence acceptable, can be None)"
    - "Extracted values stored in InvoiceHeader (supplier_name, invoice_date)"
  artifacts:
    - path: "src/pipeline/header_extractor.py"
      provides: "Vendor name and date extraction (extends existing header_extractor.py)"
      exports: ["extract_vendor_name", "extract_invoice_date"]
  key_links:
    - from: "src/pipeline/header_extractor.py"
      to: "src/models/segment.py"
      via: "Extracts from header segment"
      pattern: "Segment|segment_type.*header"
    - from: "src/pipeline/header_extractor.py"
      to: "src/models/invoice_header.py"
      via: "Updates InvoiceHeader.supplier_name and invoice_date"
      pattern: "InvoiceHeader|supplier_name|invoice_date"
---

<objective>
Implement vendor name and invoice date extraction from header segment.

Purpose: Extract vendor name (company name) and invoice date from header segment using heuristics. No hard gate (low confidence acceptable, can be None). Date normalized to ISO format for consistency. This complements invoice number extraction from Plan 02-03.
Output: Vendor name extractor, date extractor, integration with InvoiceHeader.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-header-wrap/02-CONTEXT.md
@.planning/phases/02-header-wrap/02-RESEARCH.md
@docs/04_heuristics.md
@specs/invoice_pipeline_v1.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement invoice date extraction</name>
  <files>src/pipeline/header_extractor.py</files>
  <action>
Implement invoice date extraction from header segment according to Heuristik 6 (docs/04_heuristics.md) and 02-CONTEXT.md.

Function to implement:
- `extract_invoice_date(header_segment: Segment, invoice_header: InvoiceHeader) -> None`: Extracts invoice date, normalizes to ISO format, updates InvoiceHeader

Algorithm:
1. Search for date keywords in header segment rows:
   - Keywords: "datum", "date", "fakturadatum", "invoice date"
   - Look for keywords on same row or adjacent rows
   
2. Extract date value after keyword:
   - Support formats (Heuristik 6):
     - ISO: `YYYY-MM-DD` (e.g., "2024-01-15")
     - Swedish variants: `DD/MM/YYYY`, `DD.MM.YYYY`, `DD-MM-YYYY`
     - Swedish text: "15 januari 2024", "15 jan 2024"
   - Use regex patterns to match date formats
   - Parse first matching date found
   
3. Normalize to ISO format (YYYY-MM-DD):
   - Convert all formats to datetime.date object
   - Format as ISO string for storage
   
4. Update InvoiceHeader:
   - Set invoice_date (datetime.date object or None if not found)

Error handling: If no date found, leave invoice_date as None (no hard gate, acceptable for Phase 2).
  </action>
  <verify>python -c "from src.pipeline.header_extractor import extract_invoice_date; # Basic import test"</verify>
  <done>extract_invoice_date extracts date from header segment, normalizes to ISO format, updates InvoiceHeader</done>
</task>

<task type="auto">
  <name>Task 2: Implement vendor name extraction</name>
  <files>src/pipeline/header_extractor.py</files>
  <action>
Implement vendor name extraction from header segment (company name only, address out of scope for Phase 2).

Function to implement:
- `extract_vendor_name(header_segment: Segment, invoice_header: InvoiceHeader) -> None`: Extracts vendor/company name, updates InvoiceHeader

Algorithm:
1. Search for vendor indicators in header segment:
   - Common patterns: Company name often appears in top-left or top-right of header
   - Look for capitalized text (company names often capitalized)
   - Avoid lines with keywords like "Faktura", "Invoice", "Datum" (metadata, not company name)
   
2. Heuristics for company name identification:
   - Usually one of first few rows in header
   - Often largest font size in header (company branding)
   - May contain "AB", "Ltd", "Inc", "AB" (Swedish company suffixes)
   - Not a date, not an invoice number
   
3. Extract candidate vendor name:
   - Take first substantial text row (not keyword rows)
   - Or identify by font size (largest in header)
   - Limit to reasonable length (e.g., max 100 characters)
   
4. Update InvoiceHeader:
   - Set supplier_name (extracted value or None if not found)

Note: Address extraction deferred to later phase. This extracts company name only.

Error handling: If no clear vendor name found, leave supplier_name as None (no hard gate).
  </action>
  <verify>python -c "from src.pipeline.header_extractor import extract_vendor_name; # Basic import test"</verify>
  <done>extract_vendor_name extracts company name from header segment, updates InvoiceHeader</done>
</task>

<task type="auto">
  <name>Task 3: Integrate vendor and date extraction into header extractor</name>
  <files>src/pipeline/header_extractor.py</files>
  <action>
Create main function to extract all header fields (invoice number, vendor, date) in one call.

Function to implement:
- `extract_header_fields(header_segment: Segment, invoice_header: InvoiceHeader) -> None`: Extracts all header fields

This function calls:
1. `extract_invoice_number(header_segment, invoice_header)` (from Plan 02-03)
2. `extract_invoice_date(header_segment, invoice_header)` (new)
3. `extract_vendor_name(header_segment, invoice_header)` (new)

Update CLI to use `extract_header_fields()` instead of calling individual extractors separately.
  </action>
  <verify>python -c "from src.pipeline.header_extractor import extract_header_fields; # Basic import test"</verify>
  <done>extract_header_fields extracts all header fields (invoice number, date, vendor) in one call</done>
</task>

<task type="auto">
  <name>Task 4: Update unit tests for vendor and date extraction</name>
  <files>tests/test_header_extractor.py</files>
  <action>
Add unit tests for vendor name and date extraction.

Tests to write:
- Test date extraction with various formats (ISO, Swedish variants, Swedish text)
- Test date normalization to ISO format (YYYY-MM-DD)
- Test vendor name extraction from header (company name patterns)
- Test edge cases: no date found (None), no vendor found (None)
- Test extract_header_fields calls all extractors

Use pytest fixtures for Segment, Row objects. Verify:
- Date extracted and normalized correctly
- Vendor name extracted (company name only)
- None values handled correctly (no hard gate)

Ensure tests run with `pytest tests/test_header_extractor.py -v`.
  </action>
  <verify>pytest tests/test_header_extractor.py -v</verify>
  <done>All vendor and date extraction unit tests pass, coverage >80%</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] pytest tests/test_header_extractor.py -v passes
- [ ] mypy type checking passes for all modified files
- [ ] Invoice date extracted from header segment and normalized to ISO format
- [ ] Vendor name extracted from header segment (company name only)
- [ ] extract_header_fields extracts all fields (invoice number, date, vendor)
- [ ] None values handled correctly (no hard gate for vendor/date)
</verification>

<success_criteria>

- All tasks completed
- Invoice date extracted and normalized to ISO format (YYYY-MM-DD)
- Vendor name extracted (company name only, address out of scope)
- No hard gate for vendor/date (can be None, low confidence acceptable)
- extract_header_fields extracts all header fields in one call
- Unit tests pass with >80% coverage
- No type errors or linting issues

</success_criteria>

<output>
After completion, create `.planning/phases/02-header-wrap/02-04-SUMMARY.md`
</output>
