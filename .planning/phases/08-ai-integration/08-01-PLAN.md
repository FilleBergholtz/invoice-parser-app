---
phase: 08-ai-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [src/ai/fallback.py, src/ai/providers.py]
autonomous: true

must_haves:
  truths:
    - "System abstracts AI provider (can switch between OpenAI/Claude)"
    - "System uses structured outputs (Pydantic) for AI responses"
    - "AI provider abstraction supports multiple providers"
  artifacts:
    - path: "src/ai/providers.py"
      provides: "AI provider abstraction (OpenAI/Claude)"
      exports: ["AIProvider", "OpenAIProvider", "ClaudeProvider"]
    - path: "src/ai/fallback.py"
      provides: "AI fallback for total amount extraction"
      exports: ["extract_total_with_ai", "AIFallback"]
  key_links:
    - from: "src/ai/fallback.py"
      to: "src/ai/providers.py"
      via: "Uses AIProvider for API calls"
      pattern: "AIProvider|extract_total"
    - from: "src/ai/fallback.py"
      to: "src/models/invoice_header.py"
      via: "Returns total amount and confidence"
      pattern: "InvoiceHeader|total_amount|total_confidence"
---

<objective>
Create AI provider abstraction and fallback system for total amount extraction using structured outputs.

Purpose: Build provider abstraction (OpenAI/Claude), structured output schemas (Pydantic), and AI fallback function that extracts total amount when confidence < 0.95.

Output: AIProvider abstraction, structured output schemas, AI fallback function.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-ai-integration/08-CONTEXT.md
@.planning/research/ARCHITECTURE.md
@src/ai/client.py
@src/ai/schemas.py
@src/config.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create AI provider abstraction</name>
  <files>src/ai/providers.py</files>
  <action>
Create AI provider abstraction module `src/ai/providers.py`.

**Dependencies:**
- openai library (for OpenAI API) - add to pyproject.toml: `openai>=1.0.0`
- anthropic library (for Claude API) - add to pyproject.toml: `anthropic>=0.18.0`
- pydantic for structured outputs - check if already in dependencies

**Classes to implement:**

1. `AIProvider` (abstract base class):
   - Methods:
     - `extract_total_amount(footer_text: str, line_items_sum: Optional[float] = None) -> Dict[str, Any]`:
       - Extract total amount from footer text using AI
       - Returns dict with: total_amount, confidence, reasoning, validation_passed
     - `validate_response(response: Dict) -> bool`: Validate AI response structure

2. `OpenAIProvider(AIProvider)`:
   - Uses OpenAI API (GPT-4) with structured outputs
   - Methods:
     - `__init__(api_key: str, model: str = "gpt-4-turbo-preview")`
     - `extract_total_amount()`: Call OpenAI API with structured output schema

3. `ClaudeProvider(AIProvider)`:
   - Uses Anthropic Claude API with structured outputs
   - Methods:
     - `__init__(api_key: str, model: str = "claude-3-opus-20240229")`
     - `extract_total_amount()`: Call Claude API with structured output schema

**Structured Output Schema (Pydantic):**
```python
class AITotalResponse(BaseModel):
    total_amount: float
    confidence: float = Field(ge=0.0, le=1.0)
    reasoning: Optional[str] = None
    validation_passed: bool
```

**Prompt Template:**
- Extract total amount from Swedish invoice footer text
- Consider line items sum for validation
- Return structured response with confidence

**Error Handling:**
- Handle API errors (rate limits, auth errors)
- Handle timeouts
- Handle invalid responses
- Return None or raise exception (will be handled by fallback)

Add type hints and docstrings.
  </action>
  <verify>python -c "from src.ai.providers import AIProvider, OpenAIProvider, ClaudeProvider; print('AI providers imported successfully')"</verify>
  <done>AI provider abstraction created with OpenAI and Claude support</done>
</task>

<task type="auto">
  <name>Task 2: Create AI fallback function</name>
  <files>src/ai/fallback.py</files>
  <action>
Create AI fallback module `src/ai/fallback.py` for total amount extraction.

**Dependencies:**
- AIProvider from providers.py
- Config functions for AI settings

**Functions/Classes to implement:**

1. `extract_total_with_ai(
    footer_text: str,
    line_items_sum: Optional[float] = None,
    provider: Optional[AIProvider] = None
) -> Optional[Dict[str, Any]]`:
   - Extract total amount using AI
   - Validate response
   - Return dict with total_amount, confidence, reasoning, validation_passed
   - Return None if AI fails

2. `AIFallback` class (optional, for future extensibility):
   - Methods:
     - `__init__(provider: Optional[AIProvider] = None)`: Initialize with provider
     - `extract(footer_text: str, line_items_sum: Optional[float] = None) -> Optional[Dict]`: Extract using AI

**Provider Selection:**
- Get provider from config (AI_PROVIDER env var: "openai" or "claude")
- Default to OpenAI if not specified
- Initialize provider with API key from config

**Error Handling:**
- Catch all AI errors (AIConnectionError, AIAPIError, etc.)
- Log errors but return None (graceful degradation)
- Don't raise exceptions (let caller handle None)

**Validation:**
- Validate AI response structure
- Validate total_amount is numeric
- Validate confidence is 0.0-1.0
- Check validation_passed flag

Add type hints and docstrings.
  </action>
  <verify>python -c "from src.ai.fallback import extract_total_with_ai; print('AI fallback imported successfully')"</verify>
  <done>AI fallback function created with provider abstraction and error handling</done>
</task>

</tasks>
