---
phase: 08-ai-integration
plan: 03
type: execute
wave: 3
depends_on: ["08-02"]
files_modified: [src/ai/fallback.py, src/pipeline/footer_extractor.py]
autonomous: true

must_haves:
  truths:
    - "System can boost confidence score if AI validation succeeds"
    - "AI responses validated before using"
    - "System handles all AI errors gracefully (timeouts, API errors, invalid responses)"
  artifacts:
    - path: "src/ai/fallback.py"
      provides: "Enhanced AI fallback with validation and confidence boosting"
      exports: []
  key_links:
    - from: "src/ai/fallback.py"
      to: "src/pipeline/validation.py"
      via: "Validates AI result against line items sum"
      pattern: "validate_total_against_line_items"
    - from: "src/pipeline/footer_extractor.py"
      to: "src/ai/fallback.py"
      via: "Uses AI result with boosted confidence if validation passes"
      pattern: "extract_total_with_ai|validation_passed"
---

<objective>
Enhance AI fallback with validation and confidence boosting when AI validation succeeds.

Purpose: Add validation of AI results against line items sum, boost confidence if validation passes, and enhance error handling for all AI error types.

Output: Enhanced AI fallback with validation, confidence boosting, and comprehensive error handling.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-ai-integration/08-CONTEXT.md
@src/ai/fallback.py
@src/pipeline/validation.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add validation and confidence boosting to AI fallback</name>
  <files>src/ai/fallback.py</files>
  <action>
Enhance AI fallback with validation and confidence boosting.

**Update extract_total_with_ai():**
- After AI extraction, validate result against line_items_sum
- Use validate_total_against_line_items() from validation module
- If validation passes, boost confidence:
  - Base boost: +0.1
  - Additional boost if exact match: +0.1 (total +0.2)
  - Cap at 1.0
- Set validation_passed flag in response

**Validation Logic:**
- Check if AI total_amount matches line_items_sum (within Â±1 SEK tolerance)
- If matches, validation_passed = True, boost confidence
- If doesn't match, validation_passed = False, no boost (or smaller boost)

**Confidence Boosting:**
- If validation_passed:
  - Boost = 0.1 (base) + 0.1 (if exact match) = 0.2 max
  - New confidence = min(1.0, ai_confidence + boost)
- Return boosted confidence in response

**Error Handling Enhancement:**
- Handle timeouts explicitly (30s default)
- Handle API errors (rate limits, auth errors, 429, 401, 500)
- Handle invalid responses (malformed JSON, missing fields, invalid types)
- Handle network errors (connection failures)
- All errors: log warning, return None (graceful degradation)

Add type hints and docstrings.
  </action>
  <verify>python -c "from src.ai.fallback import extract_total_with_ai; print('AI fallback with validation imported')"</verify>
  <done>AI fallback enhanced with validation and confidence boosting</done>
</task>

<task type="auto">
  <name>Task 2: Update footer extractor to use boosted confidence</name>
  <files>src/pipeline/footer_extractor.py</files>
  <action>
Update footer extractor to use AI result with boosted confidence when validation passes.

**Update AI fallback integration:**
- Check validation_passed flag from AI response
- If validation_passed and AI confidence > heuristic confidence:
  - Use AI total_amount
  - Use boosted confidence from AI
  - Update InvoiceHeader accordingly
- If validation_passed but AI confidence <= heuristic:
  - Still consider using AI if validation is strong signal
  - Or keep heuristic but note AI validation passed

**Confidence Selection:**
- Compare AI confidence (boosted) with heuristic confidence
- Use higher confidence result
- If AI validation passed, prefer AI even if confidence similar

**Logging:**
- Log when AI validation passes
- Log confidence boost amount
- Log final confidence after boost

Update AI fallback call to handle boosted confidence properly.
  </action>
  <verify>python -c "from src.pipeline.footer_extractor import extract_total_amount; print('Footer extractor uses boosted AI confidence')"</verify>
  <done>Footer extractor updated to use boosted confidence from validated AI results</done>
</task>

</tasks>
