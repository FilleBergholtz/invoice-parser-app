---
phase: 11-pdfplumber-ocr-compare
plan: 03
type: execute
wave: 1
depends_on: ["11-02"]
files_modified: [src/cli/main.py, src/export/excel_export.py, src/review/review_package.py, src/export/review_report.py]
autonomous: true

must_haves:
  truths:
    - "Export, review reports, and run_summary use the chosen extraction result (pdfplumber or OCR)"
    - "No mixed use of pdfplumber vs OCR within the same invoice"
  artifacts:
    - path: "src/cli/main.py"
      provides: "Single chosen result per invoice for downstream"
      exports: ["process_pdf", "process_batch"]
  key_links:
    - from: "src/cli/main.py"
      to: "src/export/excel_export.py"
      via: "Excel uses invoice data from chosen result"
      pattern: "export.*excel|excel_export"
    - from: "src/cli/main.py"
      to: "src/review/review_package.py"
      via: "Review package uses chosen result"
      pattern: "review_package|create_review_package"
---

<objective>
Ensure export, review, and run_summary use the chosen extraction result (pdfplumber or OCR) only. No mixed sources per invoice.

Purpose: Downstream (Excel, review reports, run_summary, validation UI) already consume the result of process_pdf / process_virtual_invoice. With 11-02 we return a single "best" result per invoice. Verify that all consumers use that result and that we don't accidentally mix pdfplumber and OCR data for the same invoice.

Output: Confidence that compare mode produces correct, consistent downstream outputs.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/11-pdfplumber-ocr-compare/11-CONTEXT.md
@.planning/phases/11-pdfplumber-ocr-compare/11-02-PLAN.md
@src/cli/main.py
@src/export/excel_export.py
@src/export/review_report.py
@src/review/review_package.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Verify export uses chosen result</name>
  <files>src/cli/main.py, src/export/excel_export.py</files>
  <action>
Confirm that Excel export and any other export paths use the **chosen** virtual-invoice result (the one selected by compare logic), not a mix of pdfplumber and OCR.

- Trace data flow: `process_batch` → `process_pdf` → virtual results → export. When compare mode is on, each virtual result should already be the "best" one. Ensure we never pass both results to export or switch sources mid-stream.
- If process_pdf returns a list of virtual results, each element must be the single chosen result for that invoice. No changes needed if 11-02 already enforces this; otherwise fix.

**Acceptance:**
- Excel (and other exports) reflect the chosen extraction only.
</action>
</task>

<task type="auto">
  <name>Task 2: Verify review reports and validation use chosen result</name>
  <files>src/cli/main.py, src/export/review_report.py, src/review/review_package.py, src/ui</files>
  <action>
Confirm that review reports, review package, and validation UI (candidates, traceability) use the chosen result.

- Review reports and review package are built from process_batch output (virtual results, run_summary). Ensure they use the same chosen result.
- Validation UI loads from run_summary.validation (candidates, traceability). That data comes from the invoice we processed. Verify it's the chosen one when compare mode is on.

**Acceptance:**
- Review folders and validation UI show data from the selected extraction source only.
</action>
</task>

<task type="auto">
  <name>Task 3: Optional metadata for compare runs</name>
  <files>src/run_summary.py, src/cli/main.py</files>
  <action>
Optionally add `extraction_source` (or similar) to run_summary or per-invoice metadata when `--compare-extraction` was used.

- E.g. `summary.compare_extraction_used = True` and per-invoice `extraction_source: "pdfplumber" | "ocr"`. Useful for debugging and analytics.
- Ensure JSON serialization includes any new fields (e.g. in quality_scores or a new `extraction_meta` structure).

**Acceptance:**
- When compare mode was used, we can later inspect which source was chosen per invoice (e.g. from run_summary or artifacts).
</action>
</task>

</tasks>
