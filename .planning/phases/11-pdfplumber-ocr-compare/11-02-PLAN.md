---
phase: 11-pdfplumber-ocr-compare
plan: 02
type: execute
wave: 1
depends_on: ["11-01"]
files_modified: [src/cli/main.py]
autonomous: true

must_haves:
  truths:
    - "CLI supports --compare-extraction mode"
    - "When compare mode is on, both pdfplumber and OCR extraction run per virtual invoice"
    - "System compares results (validation_passed, total_confidence) and selects the best"
  artifacts:
    - path: "src/cli/main.py"
      provides: "Dual-run and comparison logic"
      exports: ["process_pdf", "process_virtual_invoice"]
  key_links:
    - from: "src/cli/main.py"
      to: "src/pipeline/footer_extractor.py"
      via: "Uses validation and confidence from extraction"
      pattern: "validation_result|total_confidence"
---

<objective>
Add dual-run and comparison: when --compare-extraction is enabled, run both pdfplumber and OCR extraction per virtual invoice, compare results (validation_passed, total_confidence), and select the best.

Purpose: Allow the system to use whichever source (pdfplumber or OCR) gives better results per invoice. Comparison is based on validation pass and confidence scores.

Output: CLI flag --compare-extraction; comparison logic; chosen result (pdfplumber or OCR) per virtual invoice.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/11-pdfplumber-ocr-compare/11-CONTEXT.md
@.planning/phases/11-pdfplumber-ocr-compare/11-01-PLAN.md
@src/cli/main.py
@src/cli/main.py process_pdf, process_virtual_invoice
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add --compare-extraction CLI flag</name>
  <files>src/cli/main.py</files>
  <action>
Add a CLI argument `--compare-extraction`.

- In `main()`, add `parser.add_argument("--compare-extraction", action="store_true", help="Run both pdfplumber and OCR, compare results, use best.")`.
- Pass the flag through to `process_batch` and `process_pdf` (e.g. `compare_extraction: bool = False`). Ensure it reaches the layer where we run extraction per virtual invoice.

**Acceptance:**
- `python run_engine.py --input file.pdf --output out --compare-extraction` runs with compare mode enabled.
</action>
</task>

<task type="auto">
  <name>Task 2: Dual-run per virtual invoice when compare mode on</name>
  <files>src/cli/main.py</files>
  <action>
When `compare_extraction` is True, run extraction twice per virtual invoice: once with `extraction_path="pdfplumber"`, once with `extraction_path="ocr"`.

**Options:**
- **A)** Refactor `process_virtual_invoice` to accept `compare_extraction`. When True, call the core extraction logic twice (with path pdfplumber, then ocr), collect two `VirtualInvoiceResult`-like results, compare, return the better one.
- **B)** In `process_pdf`, for each virtual invoice, call `process_virtual_invoice` twice (passing pdfplumber vs ocr), get two results, compare, then use the better one for that invoice.

Prefer **A** if we can cleanly factor "run extraction for this invoice with path X" and reuse it; **B** if we want to avoid refactoring process_virtual_invoice internals.

**Acceptance:**
- When --compare-extraction is set, both pdfplumber and OCR extraction run for each virtual invoice.
- We have two results per invoice to compare.
</action>
</task>

<task type="auto">
  <name>Task 3: Compare and select best result</name>
  <files>src/cli/main.py</files>
  <action>
Implement comparison and selection logic.

**Comparison criteria (in order):**
1. If exactly one result has `validation_passed` (total â‰ˆ line_items_sum), choose that one.
2. Else, choose the result with higher `total_confidence`. Optionally break ties with `invoice_number_confidence`.
3. If both fail (e.g. no candidates, or neither validates), default to pdfplumber.

**Implementation:**
- Add a helper e.g. `_choose_best_extraction_result(result_pdfplumber, result_ocr) -> str` returning `"pdfplumber"` or `"ocr"`, or directly compare the two virtual-invoice results and return the chosen one.
- Use the chosen result as the single result for that virtual invoice (export, review, run_summary, etc.).

**Acceptance:**
- Best result is selected per virtual invoice according to the criteria above.
- Same downstream pipeline consumes the chosen result (no dual export).
</action>
</task>

<task type="auto">
  <name>Task 4: Log which source was used</name>
  <files>src/cli/main.py</files>
  <action>
When compare mode is used, log which source (pdfplumber vs ocr) was chosen per virtual invoice.

- E.g. `print(f"  [{virtual_invoice_id}] using {chosen} (validation_passed={...}, confidence={...})")` when verbose, or store in result metadata for debugging.
- Optional: add a small field to run_summary or per-invoice artifacts indicating `extraction_source: "pdfplumber" | "ocr"` for compare runs.

**Acceptance:**
- User can see which source was used per invoice when --compare-extraction and --verbose.
</action>
</task>

</tasks>
